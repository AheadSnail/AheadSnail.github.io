<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Matrix Resource Cannary 源码解析, AheadSnail&#39;s blog">
    <meta name="description" content>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Matrix Resource Cannary 源码解析 | AheadSnail&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="alternate" href="/atom.xml" title="AheadSnail's blog" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">AheadSnail&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/guestbook" class="waves-effect waves-light">
      
      <span>guestbook</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">AheadSnail&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/guestbook" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			guestbook
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Matrix Resource Cannary 源码解析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Matrix/">
                                <span class="chip bg-color">Matrix</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-03-15
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>Matrix Resource Cannary 源码解析</p>
</blockquote>
<a id="more"></a>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>前面分析了Matrix 中 SQLite Lint 模块，了解了对应的检测原理实现，本文继续分析 Matrix Resource Cannary  模块,在分析之前先看检测的原理，官网有这样的介绍，基于 WeakReference 的特性和Square Haha 库开发的 Activity 泄漏和 Bitmap 重复创建检测工具，我们知道 WeakReference 在触发Gc的时候都会被回收掉，所以利用这个特性就能知道是否发生了泄漏,本模块提供的功能有<br>1.分离了检测和分析部分，便于在不打断自动化测试的前提下持续输出分析后的检测结果<br>2.对检测部分生成的 Hprof 文件进行了裁剪，移除了大部分无用数据，降低了传输 Hprof 文件的开销<br>3.增加了重复 Bitmap 对象检测，方便通过减少冗余 Bitmap 数量，降低内存消耗</p>
</blockquote>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>在demo中有一个这样的选项，RESOURCE_CANNARY，点击之后进入一个测试页面，点击返回键,等待一会，会出现检测的结果<br><img src="/uploads/Matrix Trace分析/内存泄漏检测的结果.png" alt="结果显示"></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><pre class=" language-java"><code class="language-java">先看demo 的调用过程<span class="token punctuation">,</span>首先是Application的 初始化
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatrixApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//resource 首先 构建一个 ResourceConfig 对象，然后构建一个 ResourcePlugin 对象，最终保存到 Matrix 的build 中的 plug 集合里面</span>
        builder<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourcePlugin</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceConfig<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">dynamicConfig</span><span class="token punctuation">(</span>dynamicConfig<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//保存动态的 配置选项</span>
                    <span class="token punctuation">.</span><span class="token function">setDumpHprof</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setDetectDebuger</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true">//only set true when in sample, not in your app  设置当前为debug 模式</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment" spellcheck="true">//注册一个 Activity 泄漏的修复</span>
         ResourcePlugin<span class="token punctuation">.</span><span class="token function">activityLeakFixer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestLeakActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">/**
     * 用来模拟内存泄漏
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Set<span class="token operator">&lt;</span>Activity<span class="token operator">></span> testLeaks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ArrayList<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> bitmaps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//模拟内存泄漏</span>
        testLeaks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到 ResourcePlugin 组件</span>
        Plugin plugin <span class="token operator">=</span> Matrix<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPluginByClass</span><span class="token punctuation">(</span>ResourcePlugin<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果这个组件没有启动，执行启动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugin<span class="token punctuation">.</span><span class="token function">isPluginStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"plugin-resource start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            plugin<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//获取到Bitmap ，添加到  bitmaps 集合中，模拟内存泄漏</span>
        BitmapFactory<span class="token punctuation">.</span>Options options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BitmapFactory<span class="token punctuation">.</span>Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>inSampleSize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        bitmaps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>BitmapFactory<span class="token punctuation">.</span><span class="token function">decodeResource</span><span class="token punctuation">(</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>welcome_bg<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"test leak activity size: %d, bitmaps size: %d"</span><span class="token punctuation">,</span> testLeaks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bitmaps<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>test_leak<span class="token punctuation">)</span><span class="token punctuation">;</span>
        IssueFilter<span class="token punctuation">.</span><span class="token function">setCurrentFilter</span><span class="token punctuation">(</span>IssueFilter<span class="token punctuation">.</span>ISSUE_LEAK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
<span class="token punctuation">}</span>

首先启动  ResourcePlugin
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourcePlugin</span> <span class="token keyword">extends</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"Matrix.ResourcePlugin"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ResourceConfig mConfig<span class="token punctuation">;</span>
    <span class="token keyword">private</span> ActivityRefWatcher mWatcher <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ResourcePlugin</span><span class="token punctuation">(</span>ResourceConfig config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mConfig <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 注册全局的 Activity 生命周期的监控，监控 onActivityDestroyed,用于在销毁的时候，执行一些销毁的操作,比如修复输入法的泄漏
     * @param application
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">activityLeakFixer</span><span class="token punctuation">(</span>Application application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Auto break the path from Views in their holder to gc root when activity is destroyed.</span>
        application<span class="token punctuation">.</span><span class="token function">registerActivityLifecycleCallbacks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActivityLifeCycleCallbacksAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActivityDestroyed</span><span class="token punctuation">(</span>Activity activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//修复输入法的泄漏</span>
                ActivityLeakFixer<span class="token punctuation">.</span><span class="token function">fixInputMethodManagerLeak</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//修复Drawable 的泄漏</span>
                ActivityLeakFixer<span class="token punctuation">.</span><span class="token function">unbindDrawables</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>Application app<span class="token punctuation">,</span> PluginListener listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//只有SDK 的版本大于 4.0 才能支持</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&lt;</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>ICE_CREAM_SANDWICH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"API is low Build.VERSION_CODES.ICE_CREAM_SANDWICH(14), ResourcePlugin is not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">unSupportPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//构建一个 ActivityRefWatcher 对象，由这个对象来完成对 泄漏的监控</span>
        mWatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRefWatcher</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果当前插件不支持，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"ResourcePlugin start, ResourcePlugin is not supported, just return"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//如果支持，启动</span>
        mWatcher<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"ResourcePlugin stop, ResourcePlugin is not supported, just return"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mWatcher<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"ResourcePlugin destroy, ResourcePlugin is not supported, just return"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mWatcher<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

对应到上文中，也即是会构建一个 ResourcePlugin 对象，并且调用 <span class="token function">activityLeakFixer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，利用application<span class="token punctuation">.</span><span class="token function">registerActivityLifecycleCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>监听全局的Activity的生命周期，这里监听
<span class="token function">onActivityDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>生命周期的调用，当监听到Activity 销毁的时候，修复键盘，Drawable 泄漏<span class="token punctuation">,</span>前面分析过 当 执行 Matrix<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>的时候，会触发对应的plugin执行init函数
所以这里就会执行ResourcePlugin 中的 <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数<span class="token punctuation">,</span>在这个函数中 执行了 mWatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRefWatcher</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ，这个对象就是专门用来检测泄漏的核心类

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityRefWatcher</span> <span class="token keyword">extends</span> <span class="token class-name">FilePublisher</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ComponentFactory</span> <span class="token punctuation">{</span>

        <span class="token keyword">protected</span> RetryableTaskExecutor <span class="token function">createDetectExecutor</span><span class="token punctuation">(</span>ResourceConfig config<span class="token punctuation">,</span> HandlerThread handlerThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RetryableTaskExecutor</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getScanIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handlerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> DumpStorageManager <span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DumpStorageManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> AndroidHeapDumper <span class="token function">createHeapDumper</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> DumpStorageManager dumpStorageManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AndroidHeapDumper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dumpStorageManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> AndroidHeapDumper<span class="token punctuation">.</span>HeapDumpHandler <span class="token function">createHeapDumpHandler</span><span class="token punctuation">(</span><span class="token keyword">final</span> Context context<span class="token punctuation">,</span> ResourceConfig resourceConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AndroidHeapDumper<span class="token punctuation">.</span>HeapDumpHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>HeapDump result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//处理dump 文件 ,这里会在另一个进程中启动 CanaryWorkerService，用来执行分析 Hprof 文件</span>
                    CanaryWorkerService<span class="token punctuation">.</span><span class="token function">shrinkHprofAndReport</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">public</span> <span class="token function">ActivityRefWatcher</span><span class="token punctuation">(</span>Application app<span class="token punctuation">,</span><span class="token keyword">final</span> ResourcePlugin resourcePlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> resourcePlugin<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ComponentFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> DumpStorageManager <span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcePlugin<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDumpHprof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> AndroidHeapDumper <span class="token function">createHeapDumper</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> DumpStorageManager dumpStorageManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcePlugin<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDumpHprof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createHeapDumper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dumpStorageManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> AndroidHeapDumper<span class="token punctuation">.</span>HeapDumpHandler <span class="token function">createHeapDumpHandler</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ResourceConfig resourceConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceConfig<span class="token punctuation">.</span><span class="token function">getDumpHprof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createHeapDumpHandler</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token function">ActivityRefWatcher</span><span class="token punctuation">(</span>Application app<span class="token punctuation">,</span>ResourcePlugin resourcePlugin<span class="token punctuation">,</span>ComponentFactory componentFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//初始化 父类 FilePublisher</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> FILE_CONFIG_EXPIRED_TIME<span class="token punctuation">,</span> resourcePlugin<span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resourcePlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mResourcePlugin <span class="token operator">=</span> resourcePlugin<span class="token punctuation">;</span>
        <span class="token keyword">final</span> ResourceConfig config <span class="token operator">=</span> resourcePlugin<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Context context <span class="token operator">=</span> app<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到 子线程的 HandlerThread</span>
        HandlerThread handlerThread <span class="token operator">=</span> MatrixHandlerThread<span class="token punctuation">.</span><span class="token function">getDefaultHandlerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到重试任务的Executor</span>
        mDetectExecutor <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createDetectExecutor</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> handlerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到最多重试的次数</span>
        mMaxRedetectTimes <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getMaxRedetectTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到管理 HPROF文件的管理对象</span>
        mDumpStorageManager <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//创建Hprof 文件的类</span>
        mHeapDumper <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createHeapDumper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mDumpStorageManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//创建 HeapDumpHandler 回调</span>
        mHeapDumpHandler <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createHeapDumpHandler</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//创建一个用来存储 Activity 的并发队列</span>
        mDestroyedActivityInfos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCurrentCreatedActivityCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>    
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
这里的第三个参数为 ComponentFactory 对象，而在构造函数中，直接<span class="token keyword">new</span> 出来一个<span class="token punctuation">,</span>接着执行初始化<span class="token punctuation">,</span>首先是获取到 HandlerThread，这是一个子线程的Handler，也即是可以用来执行耗时的任务
接着调用  mDetectExecutor <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createDetectExecutor</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> handlerThread<span class="token punctuation">)</span><span class="token punctuation">;</span> 由于我们在构造函数中，没有重写这个函数，所以会执行父类的实现
<span class="token keyword">protected</span> RetryableTaskExecutor <span class="token function">createDetectExecutor</span><span class="token punctuation">(</span>ResourceConfig config<span class="token punctuation">,</span> HandlerThread handlerThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RetryableTaskExecutor</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getScanIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handlerThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/**
* 获取到资源扫描的时间，这里为一分钟
* @return
*/</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getScanIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mDynamicConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IDynamicConfig<span class="token punctuation">.</span>ExptEnum<span class="token punctuation">.</span>clicfg_matrix_resource_detect_interval_millis<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DEFAULT_DETECT_INTERVAL_MILLIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>首先看看 RetryableTaskExecutor 的实现</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryableTaskExecutor</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//子线程的 Handler</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Handler mBackgroundHandler<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//主线程的 Handler</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Handler mMainHandler<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//重试延迟的时间</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> mDelayMillis<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RetryableTask</span> <span class="token punctuation">{</span>
        <span class="token keyword">enum</span> Status <span class="token punctuation">{</span>
            DONE<span class="token punctuation">,</span> RETRY
        <span class="token punctuation">}</span>
        Status <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token function">RetryableTaskExecutor</span><span class="token punctuation">(</span><span class="token keyword">long</span> delayMillis<span class="token punctuation">,</span> HandlerThread handleThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBackgroundHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>handleThread<span class="token punctuation">.</span><span class="token function">getLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mMainHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDelayMillis <span class="token operator">=</span> delayMillis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 在主线程中执行任务， 也即是将当前的任务 提交到  mMainHandler 中执行
     * @param task
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeInMainThread</span><span class="token punctuation">(</span><span class="token keyword">final</span> RetryableTask task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">postToMainThreadWithDelay</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 执行后台任务,也即是将当前的任务提交到 mBackgroundHandler 中执行
     * @param task
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeInBackground</span><span class="token punctuation">(</span><span class="token keyword">final</span> RetryableTask task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">postToBackgroundWithDelay</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 清除任务
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBackgroundHandler<span class="token punctuation">.</span><span class="token function">removeCallbacksAndMessages</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mMainHandler<span class="token punctuation">.</span><span class="token function">removeCallbacksAndMessages</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 退出
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 提交任务到主线程中执行
     * @param task
     * @param failedAttempts
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postToMainThreadWithDelay</span><span class="token punctuation">(</span><span class="token keyword">final</span> RetryableTask task<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> failedAttempts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMainHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//主线程中执行这个任务，并且得到这个返回的结果，如果结果为  RETRY ，那么再次的添加，下次就会触发</span>
                RetryableTask<span class="token punctuation">.</span>Status status <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> RetryableTask<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>RETRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//重试，再次的提交这个任务</span>
                    <span class="token function">postToMainThreadWithDelay</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> failedAttempts <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> mDelayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 提交任务到子线程中执行
     * @param task
     * @param failedAttempts
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postToBackgroundWithDelay</span><span class="token punctuation">(</span><span class="token keyword">final</span> RetryableTask task<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> failedAttempts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBackgroundHandler<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//子线程中执行这个任务，并且到这个返回的结果，如果结果为  RETRY ，那么再次的添加，下次就会触发</span>
                RetryableTask<span class="token punctuation">.</span>Status status <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//重试，再次的提交这个任务</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> RetryableTask<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>RETRY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">postToBackgroundWithDelay</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> failedAttempts <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> mDelayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

首先我们在构造这个类的时候，传递进来的Handler，为子线程的Looper对象，所以这里会存在俩个Handelr，一个是代表子线程的mBackgroundHandler，可以用来执行耗时的任务，一个是代表主线程的
mMainHandler，同时 mDelayMillis 为<span class="token number">1</span>分钟，实际上这个类主要是用来重试的，当提交任务执行的时候，会判断这个任务的执行结果，当结果为 RETRY的时候，又会post一个任务到对应的Handler中，下次
再触发执行

接着构造函数继续往下执行，下面有这样的内容
mMaxRedetectTimes <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getMaxRedetectTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取到最多重试的次数</span>
<span class="token comment" spellcheck="true">/**
 * 获取到默认的重试次数,这里为三次
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMaxRedetectTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> mDynamicConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>IDynamicConfig<span class="token punctuation">.</span>ExptEnum<span class="token punctuation">.</span>clicfg_matrix_resource_max_detect_times<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DEFAULT_MAX_REDETECT_TIMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
为了防止我们误测，我们应该重试检测的次数

ActivityRefWatcher 构造函数，继续执行 
mDumpStorageManager <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取到管理 HPROF文件的管理对象 ,由于我们重写了这个方法</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> DumpStorageManager <span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcePlugin<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDumpHprof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> null<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

这里假设当前我们允许Dump hprof文件，那么就会执行 <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> DumpStorageManager <span class="token function">createDumpStorageManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DumpStorageManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>下面看看DumpStorageManager 的定义</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DumpStorageManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"Matrix.DumpStorageManager"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String HPROF_EXT <span class="token operator">=</span> <span class="token string">".hprof"</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 默认最多存储HPROF 文件的个数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_MAX_STORED_HPROF_FILECOUNT <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> Context mContext<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mMaxStoredHprofFileCount<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">DumpStorageManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> DEFAULT_MAX_STORED_HPROF_FILECOUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">DumpStorageManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> <span class="token keyword">int</span> maxStoredHprofFileCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxStoredHprofFileCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"illegal max stored hprof file count: "</span> <span class="token operator">+</span> maxStoredHprofFileCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        mMaxStoredHprofFileCount <span class="token operator">=</span> maxStoredHprofFileCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 创建一个Hpro 文件，指定生成的目录
     * @return
     */</span>
    <span class="token keyword">public</span> File <span class="token function">newHprofFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> File storageDir <span class="token operator">=</span> <span class="token function">prepareStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>storageDir <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> UUID uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String hprofFileName <span class="token operator">=</span> <span class="token string">"dump_"</span>
                <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">getMostSignificantBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">getLeastSignificantBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> HPROF_EXT<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>storageDir<span class="token punctuation">,</span> hprofFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> File <span class="token function">prepareStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> File storageDir <span class="token operator">=</span> <span class="token function">getStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>storageDir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>storageDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>storageDir<span class="token punctuation">.</span><span class="token function">canWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"failed to allocate new hprof file since path: %s is not writable."</span><span class="token punctuation">,</span>
                    storageDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> File<span class="token punctuation">[</span><span class="token punctuation">]</span> hprofFiles <span class="token operator">=</span> storageDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilenameFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">accept</span><span class="token punctuation">(</span>File dir<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>HPROF_EXT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hprofFiles <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> hprofFiles<span class="token punctuation">.</span>length <span class="token operator">></span> mMaxStoredHprofFileCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> hprofFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"faile to delete hprof file: "</span> <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> storageDir<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> File <span class="token function">getStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String sdcardState <span class="token operator">=</span> Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        File root <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>MEDIA_MOUNTED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sdcardState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            root <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getExternalCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            root <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> File result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">"matrix_resource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"path to store hprof and result: %s"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
其实这个类也很简单，只是负责返回一个hprof 文件的路径，并且限制最多存储<span class="token number">5</span>个hprof文件

接着执行初始化
mHeapDumper <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createHeapDumper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mDumpStorageManager<span class="token punctuation">)</span><span class="token punctuation">;</span> 创建Hprof 文件的类 ，假设当前允许dump hprof文件，那么就会执行 父类的
<span class="token keyword">protected</span> AndroidHeapDumper <span class="token function">createHeapDumper</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> DumpStorageManager dumpStorageManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AndroidHeapDumper</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dumpStorageManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>首先来看看AndroidHeapDumper定义</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AndroidHeapDumper</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"Matrix.AndroidHeapDumper"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> Context mContext<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//用来创建，管理 Hprof 文件</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> DumpStorageManager mDumpStorageManager<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//主线程的Handler</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Handler mMainHandler<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HeapDumpHandler</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>HeapDump result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">AndroidHeapDumper</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> DumpStorageManager dumpStorageManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dumpStorageManager<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">AndroidHeapDumper</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> DumpStorageManager dumpStorageManager<span class="token punctuation">,</span> Handler mainHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        mDumpStorageManager <span class="token operator">=</span> dumpStorageManager<span class="token punctuation">;</span>
        mMainHandler <span class="token operator">=</span> mainHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 执行文件的dump
     * @return
     */</span>
    <span class="token keyword">public</span> File <span class="token function">dumpHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//创建一个 hpro 文件路径</span>
        <span class="token keyword">final</span> File hprofFile <span class="token operator">=</span> mDumpStorageManager<span class="token punctuation">.</span><span class="token function">newHprofFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> hprofFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"hprof file is null."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//确保父类是可以写的路径</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hprofFile<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"hprof file path: %s cannot be written."</span><span class="token punctuation">,</span> hprofFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//创建一个 FutureResult 对象</span>
        <span class="token keyword">final</span> FutureResult<span class="token operator">&lt;</span>Toast<span class="token operator">></span> waitingForToast <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureResult</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//显示toast</span>
        <span class="token function">showToast</span><span class="token punctuation">(</span>waitingForToast<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//如果toast 在5秒中之内都么有显示完成，那么就放弃当前 dump 文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waitingForToast<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"give up dumping heap, waiting for toast too long."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//如果到了这里，那说明5 秒钟之内显示出来了，执行dump</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Debug<span class="token punctuation">.</span><span class="token function">dumpHprofData</span><span class="token punctuation">(</span>hprofFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//dump 成功显示，取消toast</span>
            <span class="token function">cancelToast</span><span class="token punctuation">(</span>waitingForToast<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> hprofFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">printErrStackTrace</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token string">"failed to dump heap into file: %s."</span><span class="token punctuation">,</span> hprofFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 显示toast
     * @param waitingForToast
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token keyword">final</span> FutureResult<span class="token operator">&lt;</span>Toast<span class="token operator">></span> waitingForToast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//使用 mMainHandler 执行任务</span>
        mMainHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//主线程里面执行，构建一个toast ,执行显示</span>
                <span class="token keyword">final</span> Toast toast <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Toast</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                toast<span class="token punctuation">.</span><span class="token function">setDuration</span><span class="token punctuation">(</span>Toast<span class="token punctuation">.</span>LENGTH_LONG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                toast<span class="token punctuation">.</span><span class="token function">setGravity</span><span class="token punctuation">(</span>Gravity<span class="token punctuation">.</span>CENTER_VERTICAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LayoutInflater inflater <span class="token operator">=</span> LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                toast<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span>inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>resource_canary_toast_wait_for_heapdump<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                toast<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Waiting for Idle to make sure Toast gets rendered.  然后添加一个 addIdleHandler 确保这个toast 能显示完成</span>
                Looper<span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageQueue<span class="token punctuation">.</span>IdleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//如果执行到了这里，那能确保toast 肯定显示完成</span>
                        waitingForToast<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>toast<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelToast</span><span class="token punctuation">(</span><span class="token keyword">final</span> Toast toast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mMainHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                toast<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

其实这个类也很简单，只是负责生成一个hprof 文件，而具体的生成方法是调用 Debug<span class="token punctuation">.</span><span class="token function">dumpHprofData</span><span class="token punctuation">(</span>hprofFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 这里在执行dump 文件的时候还考虑到了频繁触发dump文件的
操作，因为dump  hprof文件是一个很耗时的任务，虽然这个任务是放在子线程中执行的，但是也不能频繁的触发，这里的做法是在 dump之前，创建了一个 FutureResult 对象
<span class="token keyword">final</span> FutureResult<span class="token operator">&lt;</span>Toast<span class="token operator">></span> waitingForToast <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureResult</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

这里先分析下FutureResult 的定义
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FutureResult</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * AtomicReference 对象的原子操作,也即是在多线程的环境下修改了这个对象，其他的线程也能获取到最新的结果
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> AtomicReference<span class="token operator">&lt;</span>T<span class="token operator">></span> resultHolder<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     *CountDownLatch类位于java.util.concurrent包下，利用它可以实现类似计数器的功能。比如有一个任务A，它要等待其他4个任务执行完毕之后才能执行，此时就可以利用CountDownLatch来实现这种功能了。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> CountDownLatch latch<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">FutureResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//指定长度 为1</span>
        latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 判断是否需要等待，如果调用这个函数的时候，刚好  CountDownLatch 为0，不用等待，如果不为0 需要等待子任务结束
     * @param timeout
     * @param unit
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> TimeUnit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Did not expect thread to be interrupted"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 获取到结果
     * @return
     */</span>
    <span class="token keyword">public</span> T <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>latch<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Call wait() and check its result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> resultHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 填充结果
     * @param result
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//填充结果</span>
        resultHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//让 CountDownLatch 减一处理，本文中就变成0 ，下次调用wait 方法的时候，就不用等待了</span>
        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
可以看到内部使用了 AtomicReference 来保证对象的原子性，同时使用 CountDownLatch，在构造函数的 <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 将这个长度指定为 <span class="token number">1</span>，由于CountDownLatch 的特性，当调用
CountDownLatch<span class="token punctuation">.</span>wait的时候，如果当前的长度不为<span class="token number">1</span>，就会阻塞，如果为<span class="token number">0</span>了，就会立刻返回，这个可以用在多线程同步上，可以看到在FutureResult 上，当调用<span class="token function">set</span><span class="token punctuation">(</span>T result<span class="token punctuation">)</span>的时候，会将当前的结果
存储到AtomicReference 中保证原子性，同时将latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 让长度为<span class="token number">0</span>， 相应的提供了get，wait函数，在get函数的时候，如果不为<span class="token number">0</span>，就会返回异常，在wait的时候就利用了CountDownLatch
的wait的特性

接着看这里的逻辑

<span class="token comment" spellcheck="true">//创建一个 FutureResult 对象</span>
<span class="token keyword">final</span> FutureResult<span class="token operator">&lt;</span>Toast<span class="token operator">></span> waitingForToast <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureResult</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//显示toast</span>
<span class="token function">showToast</span><span class="token punctuation">(</span>waitingForToast<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//如果toast 在5秒中之内都么有显示完成，那么就放弃当前 dump 文件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waitingForToast<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"give up dumping heap, waiting for toast too long."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//如果到了这里，那说明5 秒钟之内显示出来了，执行dump</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
       Debug<span class="token punctuation">.</span><span class="token function">dumpHprofData</span><span class="token punctuation">(</span>hprofFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">//dump 成功显示，取消toast</span>
       <span class="token function">cancelToast</span><span class="token punctuation">(</span>waitingForToast<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> hprofFile<span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       MatrixLog<span class="token punctuation">.</span><span class="token function">printErrStackTrace</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token string">"failed to dump heap into file: %s."</span><span class="token punctuation">,</span> hprofFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

首先显示Toast，使用主线程的Handler提交了一个显示的任务，当这个显示的任务被执行的时候，又通过  Looper<span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>设置了一个监听
这是一个空闲的监听，当主线程的Looper对应的MessageQuque中没有消息的时候，就会触发这个回调，当你有设置这个回调的化，同时返回值为<span class="token boolean">false</span>的化，代表下次不会再次的触发，现在假设主线程
没有消息要处理了，那么就会执行这个回调，调用 waitingForToast<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>toast<span class="token punctuation">)</span><span class="token punctuation">;</span>，前面分析过 FutureResult的set函数，内部会将这个对象使用AtomicReference 原子封装起来，同时让latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
等到Dump hprof 文件成功之后，就调用<span class="token function">cancelToast</span><span class="token punctuation">(</span>waitingForToast<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>让toast取消显示<span class="token punctuation">,</span>现在来看看他是怎么样做到当主线程处于繁忙状态的时候，不执行dump操作的，如果主线程处于繁忙状态
那Looper<span class="token punctuation">.</span><span class="token function">myQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIdleHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>的监听就不会立刻的回调，那就不会调用FutureResult<span class="token punctuation">.</span>set（）函数，就不会调用latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>那么接下来的waitingForToast<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
就会因为CountDownLatch 没有达到<span class="token number">0</span>，而导致等待了<span class="token number">5</span>秒之后超时返回，此时直接返回null，日志也显示出来了放弃当前的dump 操作，
</code></pre>
<p>继续回到ActivityRefWatcher 构造函数初始化的过程，接着往下执行</p>
<pre class=" language-java"><code class="language-java">mHeapDumpHandler <span class="token operator">=</span> componentFactory<span class="token punctuation">.</span><span class="token function">createHeapDumpHandler</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span> 创建 HeapDumpHandler 回调，最终会调用到 父类的实现
<span class="token keyword">protected</span> AndroidHeapDumper<span class="token punctuation">.</span>HeapDumpHandler <span class="token function">createHeapDumpHandler</span><span class="token punctuation">(</span><span class="token keyword">final</span> Context context<span class="token punctuation">,</span> ResourceConfig resourceConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AndroidHeapDumper<span class="token punctuation">.</span>HeapDumpHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>HeapDump result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment" spellcheck="true">//处理dump 文件 ,这里会在另一个进程中启动 CanaryWorkerService，用来执行分析 Hprof 文件</span>
               CanaryWorkerService<span class="token punctuation">.</span><span class="token function">shrinkHprofAndReport</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
可以看到这里直接创建了一个这样的对象，继续往下执行
<span class="token comment" spellcheck="true">//创建一个用来存储 Activity 的并发队列</span>
mDestroyedActivityInfos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mCurrentCreatedActivityCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

这样 ResourcePlugin 的init过程结束，接着会执行start函数
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//如果当前插件不支持，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"ResourcePlugin start, ResourcePlugin is not supported, just return"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//如果支持，启动</span>
    mWatcher<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">stopDetect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">final</span> Application app <span class="token operator">=</span> mResourcePlugin<span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">//注册全局的 Activity 生命周期的监听，监听 ActivityCreate 以及 ActivityDestroy,</span>
         app<span class="token punctuation">.</span><span class="token function">registerActivityLifecycleCallbacks</span><span class="token punctuation">(</span>mRemovedActivityMonitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">scheduleDetectProcedure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"watcher is started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
可以看到start的时候，调用app<span class="token punctuation">.</span><span class="token function">registerActivityLifecycleCallbacks</span><span class="token punctuation">(</span>mRemovedActivityMonitor<span class="token punctuation">)</span><span class="token punctuation">;</span>这是一个监控Activity生命周期的回调
<span class="token comment" spellcheck="true">/**
* 全局的Activity 创建 销毁的监听
*/</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Application<span class="token punctuation">.</span>ActivityLifecycleCallbacks mRemovedActivityMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityLifeCycleCallbacksAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActivityCreated</span><span class="token punctuation">(</span>Activity activity<span class="token punctuation">,</span> Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//创建的时候，使用cas 加一处理</span>
        mCurrentCreatedActivityCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onActivityDestroyed</span><span class="token punctuation">(</span>Activity activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//捕捉到 Activity 销毁的时机点</span>
        <span class="token function">pushDestroyedActivityInfo</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
可以看到这里监控的是Activity的创建以及销毁的时间点<span class="token punctuation">,</span>当创建的时候就让mCurrentCreatedActivityCount 加一处理<span class="token punctuation">,</span>前面分析到在初始化的时候值为<span class="token number">0</span><span class="token punctuation">,</span>这是一个使用cas操作的并发类，当Activity
销毁的时候就会执行 <span class="token function">pushDestroyedActivityInfo</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pushDestroyedActivityInfo</span><span class="token punctuation">(</span>Activity activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//获取到当前Activity的名字</span>
    <span class="token keyword">final</span> String activityName <span class="token operator">=</span> activity<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//如果当前的 activity 已经在 泄漏的集合中，直接返回</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">final</span> UUID uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> StringBuilder keyBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>ACTIVITY_REFKEY_PREFIX<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>activityName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">getMostSignificantBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">getLeastSignificantBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> String key <span class="token operator">=</span> keyBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//构建一个 DestroyedActivityInfo，然后添加到 mDestroyedActivityInfos 集合中</span>
    <span class="token keyword">final</span> DestroyedActivityInfo destroyedActivityInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DestroyedActivityInfo</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> activity<span class="token punctuation">,</span> activityName<span class="token punctuation">,</span> mCurrentCreatedActivityCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mDestroyedActivityInfos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>destroyedActivityInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DestroyedActivityInfo</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//唯一的key</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> String mKey<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//当前对应的 Activity 类名</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> String mActivityName<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//Activity 的虚引用对象</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> WeakReference<span class="token operator">&lt;</span>Activity<span class="token operator">></span> mActivityRef<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//上一次Activity 的数量</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">long</span> mLastCreatedActivityCount<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//表示回收的次数</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> mDetectedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">DestroyedActivityInfo</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> Activity activity<span class="token punctuation">,</span> String activityName<span class="token punctuation">,</span> <span class="token keyword">long</span> lastCreatedActivityCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mKey <span class="token operator">=</span> key<span class="token punctuation">;</span>
        mActivityName <span class="token operator">=</span> activityName<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//这里创建了一个 WeakReference 来持有这个Activity ，WeakReference的特点就是当触发Gc的时候，就会销毁掉</span>
        mActivityRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastCreatedActivityCount <span class="token operator">=</span> lastCreatedActivityCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
可以看到当监控到Activity 销毁的时候，就会将当前的Activity信息保存起来，使用DestroyedActivityInfo封装，其中有一个成员变量mActivityRef <span class="token punctuation">,</span>这是一个使用了WeakReference 特性的封装的对象
最后将DestroyedActivityInfo存储到mDestroyedActivityInfos队列中，
</code></pre>
<p>接着执行 scheduleDetectProcedure();,</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityRefWatcher</span> <span class="token keyword">extends</span> <span class="token class-name">FilePublisher</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">/**
     * 安排扫描 任务
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleDetectProcedure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mDetectExecutor<span class="token punctuation">.</span><span class="token function">executeInBackground</span><span class="token punctuation">(</span>mScanDestroyedActivitiesTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 用于扫描Activity 销毁的任务,execute 会在子线程中执行
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> RetryableTask mScanDestroyedActivitiesTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RetryableTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> Status <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Fake leaks will be generated when debugger is attached.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Debug<span class="token punctuation">.</span><span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mResourcePlugin<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDetectDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"debugger is connected, to avoid fake result, detection was delayed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Status<span class="token punctuation">.</span>RETRY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//如果这个集合为空，说明当前并没有收集到 销毁的Activity 信息，返回 重试，下次再来检查</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mDestroyedActivityInfos<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Status<span class="token punctuation">.</span>RETRY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//首先测试下 系统的Gc 是否能够响应，如果不能够响应，下次再来触发</span>
            <span class="token keyword">final</span> WeakReference<span class="token operator">&lt;</span>Object<span class="token operator">></span> sentinelRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">triggerGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinelRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// System ignored our gc request, we will retry later.</span>
                MatrixLog<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"system ignore our gc request, wait for next detection."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Status<span class="token punctuation">.</span>RETRY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//遍历 mDestroyedActivityInfos 集合中的内容</span>
            <span class="token keyword">final</span> Iterator<span class="token operator">&lt;</span>DestroyedActivityInfo<span class="token operator">></span> infoIt <span class="token operator">=</span> mDestroyedActivityInfos<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>infoIt<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> DestroyedActivityInfo destroyedActivityInfo <span class="token operator">=</span> infoIt<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//如果当前已经发布过，从集合中移除，并且跳过</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPublished</span><span class="token punctuation">(</span>destroyedActivityInfo<span class="token punctuation">.</span>mActivityName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"activity with key [%s] was already published."</span><span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mActivityName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    infoIt<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">//如果当前要销毁的 mActivityRef 为空，说明对应的Activity 已经被回收了，从集合中移除，并且跳过</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>destroyedActivityInfo<span class="token punctuation">.</span>mActivityRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// The activity was recycled by a gc triggered outside.</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"activity with key [%s] was already recycled."</span><span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    infoIt<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">//到了这里说明，mActivityRef 中的Activity 没有被释放掉，有可能发生了内存泄漏了</span>
                <span class="token comment" spellcheck="true">//标识当前的Activity 经历过了一次的Gc 回收</span>
                <span class="token operator">++</span>destroyedActivityInfo<span class="token punctuation">.</span>mDetectedCount<span class="token punctuation">;</span>

                <span class="token keyword">long</span> createdActivityCountFromDestroy <span class="token operator">=</span> mCurrentCreatedActivityCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> destroyedActivityInfo<span class="token punctuation">.</span>mLastCreatedActivityCount<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//判断单钱的Activity 是否已经经历过了三次的回收操作</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>destroyedActivityInfo<span class="token punctuation">.</span>mDetectedCount <span class="token operator">&lt;</span> mMaxRedetectTimes
                    <span class="token operator">||</span> <span class="token punctuation">(</span>createdActivityCountFromDestroy <span class="token operator">&lt;</span> CREATED_ACTIVITY_COUNT_THRESHOLD <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mResourcePlugin<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDetectDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Although the sentinel tell us the activity should have been recycled,</span>
                    <span class="token comment" spellcheck="true">// system may still ignore it, so try again until we reach max retry times.</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"activity with key [%s] should be recycled but actually still \n"</span>
                            <span class="token operator">+</span> <span class="token string">"exists in %s times detection with %s created activities during destroy, wait for next detection to confirm."</span><span class="token punctuation">,</span>
                        destroyedActivityInfo<span class="token punctuation">.</span>mKey<span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mDetectedCount<span class="token punctuation">,</span> createdActivityCountFromDestroy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">//如果到了这里说明经历过了三次的回收操作，这个Activity还是没有被释放到，说明泄漏了</span>
                MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"activity with key [%s] was suspected to be a leaked instance."</span><span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mHeapDumper <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//生成对应的dump文件</span>
                    <span class="token keyword">final</span> File hprofFile <span class="token operator">=</span> mHeapDumper<span class="token punctuation">.</span><span class="token function">dumpHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//dump文件生成成功</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hprofFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//标记当前的Activity 执行发布，添加到map中，并且保存到 sp中</span>
                        <span class="token function">markPublished</span><span class="token punctuation">(</span>destroyedActivityInfo<span class="token punctuation">.</span>mActivityName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">//处理Dump文件</span>
                        <span class="token keyword">final</span> HeapDump heapDump <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapDump</span><span class="token punctuation">(</span>hprofFile<span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mKey<span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mActivityName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mHeapDumpHandler<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>heapDump<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        infoIt<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//生成失败，直接从集合中移除当前的元素</span>
                        MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"heap dump for further analyzing activity with key [%s] was failed, just ignore."</span><span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        infoIt<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Lightweight mode, just report leaked activity name.</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"lightweight mode, just report leaked activity name."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">markPublished</span><span class="token punctuation">(</span>destroyedActivityInfo<span class="token punctuation">.</span>mActivityName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mResourcePlugin <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//直接将泄漏的Activity 直接报告</span>
                        <span class="token keyword">final</span> JSONObject resultJson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            resultJson<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>SharePluginInfo<span class="token punctuation">.</span>ISSUE_ACTIVITY_NAME<span class="token punctuation">,</span> destroyedActivityInfo<span class="token punctuation">.</span>mActivityName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSONException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            MatrixLog<span class="token punctuation">.</span><span class="token function">printErrStackTrace</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token string">"unexpected exception."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mResourcePlugin<span class="token punctuation">.</span><span class="token function">onDetectIssue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Issue</span><span class="token punctuation">(</span>resultJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> Status<span class="token punctuation">.</span>RETRY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 手动的触发GC的操作
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">triggerGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MatrixLog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"triggering gc..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runFinalization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MatrixLog<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"gc was triggered."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
所以通过执行<span class="token function">scheduleDetectProcedure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数就会触发执行mDetectExecutor<span class="token punctuation">.</span><span class="token function">executeInBackground</span><span class="token punctuation">(</span>mScanDestroyedActivitiesTask<span class="token punctuation">)</span><span class="token punctuation">;</span>，前面已经分析过mDetectExecutor的做用，这里就是提交一个扫描的任务
到子线程的Handler中，当这个任务执行的时候，还要根据这个任务的返回值是否为RETRY，继而判断是否有必要再次的检查，

而mScanDestroyedActivitiesTask 做的就是检查内存泄漏的关键了<span class="token punctuation">,</span>其实注释已经写的很清楚了，这里再大概的说下，由于 WeakReference的特性，当Gc触发的时候，就会将这个对象销毁，所以我们可以
通过手动的触发Gc的操作，判断由WeakReference 封装的对象是否还存在，如果存在就代表内存泄漏，否则相反，由于系统有时候会忽略掉我们的Gc请求，所以这里在开始的时候<span class="token punctuation">,</span>先测试下，当前的gc请求
<span class="token keyword">final</span> WeakReference<span class="token operator">&lt;</span>Object<span class="token operator">></span> sentinelRef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>这里通过构建一个局部的匿名对象，然后调用<span class="token function">triggerGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>执行gc的请求，如果此时发现sentinelRef封装的对象不为空
那么直接返回<span class="token keyword">return</span> Status<span class="token punctuation">.</span>RETRY，让下次再来触发检查，当然我们并不能简单的通过这个测试就能保证后面我们Gc的时候，一定不会被系统忽略掉，所以这里还有一个参数是mMaxRedetectTimes，前面提到
过，这个代表应该重试的检查的次数，所以如果第一次gc的时候，发现还存在，还要触发俩次的gc的检查，要是还存在，才能判断为内存泄漏，接着就会执行dump hprof的操作，前面已经分析过了dump hprof
的关键点 得到结果之后，会构建一个 HeapDump对象，然后调用mHeapDumpHandler<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>heapDump<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">,</span>mHeapDumpHandler前面分析过为创建的匿名对象，所以就会执行到对应的函数

<span class="token keyword">protected</span> AndroidHeapDumper<span class="token punctuation">.</span>HeapDumpHandler <span class="token function">createHeapDumpHandler</span><span class="token punctuation">(</span><span class="token keyword">final</span> Context context<span class="token punctuation">,</span> ResourceConfig resourceConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AndroidHeapDumper<span class="token punctuation">.</span>HeapDumpHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>HeapDump result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment" spellcheck="true">//处理dump 文件 ,这里会在另一个进程中启动 CanaryWorkerService，用来执行分析 Hprof 文件</span>
               CanaryWorkerService<span class="token punctuation">.</span><span class="token function">shrinkHprofAndReport</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>下面看看 CanaryWorkerService的实现</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanaryWorkerService</span> <span class="token keyword">extends</span> <span class="token class-name">MatrixJobIntentService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"Matrix.CanaryWorkerService"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> JOB_ID <span class="token operator">=</span> <span class="token number">0xFAFBFCFD</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ACTION_SHRINK_HPROF <span class="token operator">=</span> <span class="token string">"com.tencent.matrix.resource.worker.action.SHRINK_HPROF"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String EXTRA_PARAM_HEAPDUMP <span class="token operator">=</span> <span class="token string">"com.tencent.matrix.resource.worker.param.HEAPDUMP"</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 启动  CanaryWorkerService 服务来分析当前的 dump 文件
     * @param context
     * @param heapDump
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shrinkHprofAndReport</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> HeapDump heapDump<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//将当前的dump 文件传递过去</span>
        <span class="token keyword">final</span> Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> CanaryWorkerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span>ACTION_SHRINK_HPROF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>EXTRA_PARAM_HEAPDUMP<span class="token punctuation">,</span> heapDump<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enqueueWork</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> CanaryWorkerService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> JOB_ID<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 会在子线程中执行
     * @param intent The intent describing the work to now be processed.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onHandleWork</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//当前的操作为 分析 hprof 文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ACTION_SHRINK_HPROF<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//获取到传递过来的 HeapDump对象</span>
                <span class="token keyword">final</span> HeapDump heapDump <span class="token operator">=</span> <span class="token punctuation">(</span>HeapDump<span class="token punctuation">)</span> intent<span class="token punctuation">.</span><span class="token function">getSerializableExtra</span><span class="token punctuation">(</span>EXTRA_PARAM_HEAPDUMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>heapDump <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//执行分析操作</span>
                    <span class="token function">doShrinkHprofAndReport</span><span class="token punctuation">(</span>heapDump<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"failed to deserialize heap dump, give up shrinking and reporting."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span>service
    android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".CanaryWorkerService"</span>
    android<span class="token operator">:</span>process<span class="token operator">=</span><span class="token string">":res_can_worker"</span>
    android<span class="token operator">:</span>permission<span class="token operator">=</span><span class="token string">"android.permission.BIND_JOB_SERVICE"</span>
    android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">"false"</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>service<span class="token operator">></span>
</code></pre>
<p>其实这里做的事情就是另起一个服务，这个服务在另外一个进程 res_can_worker 为进程名，至于怎么样将这个服务启动起来，内部也是挺有考究的，下面来具体的分析下是怎么做到的</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enqueueWork</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Class <span class="token class-name">cls</span><span class="token punctuation">,</span> <span class="token keyword">int</span> jobId<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Intent work<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">enqueueWork</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">,</span> jobId<span class="token punctuation">,</span> work<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
首先将我们要启动的Service，封装到ComponentName 中<span class="token punctuation">,</span>接着执行
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enqueueWork</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> ComponentName component<span class="token punctuation">,</span> <span class="token keyword">int</span> jobId<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Intent work<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>work <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"work must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//线程安全</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true">//获取到当前的 ComponentName 对应的 WorkEnqueuer</span>
       WorkEnqueuer we <span class="token operator">=</span> <span class="token function">getWorkEnqueuer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> component<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">//设置对应的jobId</span>
       we<span class="token punctuation">.</span><span class="token function">ensureJobId</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">//执行这个任务</span>
       we<span class="token punctuation">.</span><span class="token function">enqueueWork</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
首先通过 <span class="token function">getWorkEnqueuer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数调用，获取到 对应的WorkEnqueuer 对象
<span class="token keyword">static</span> WorkEnqueuer <span class="token function">getWorkEnqueuer</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ComponentName cn<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasJobId<span class="token punctuation">,</span> <span class="token keyword">int</span> jobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//首先从集合中获取，如果不为空，直接使用</span>
    WorkEnqueuer we <span class="token operator">=</span> sClassWorkEnqueuer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>we <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasJobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Can't be here without a job id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token comment" spellcheck="true">//8.0 使用 JobScheduler</span>
             we <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobWorkEnqueuer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true">//低于 8.0 使用</span>
           we <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompatWorkEnqueuer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sClassWorkEnqueuer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> we<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> we<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//这里的sClassWorkEnqueuer 为一个HashMap集合，作用为缓存的功能，下次存在就直接从集合中获取到</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> HashMap<span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> WorkEnqueuer<span class="token operator">></span> sClassWorkEnqueuer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
如果在集合中不存在以当前 ComponentName 对应的 WorkEnqueuer对象的时候，就会根据当前的SDK 的版本号，创建对应的WorkEnqueuer对象，这里的WorkEnqueuer是我们自己定义的抽象类<span class="token punctuation">,</span>为了更好的
封装对于<span class="token number">8.0</span>以上跟<span class="token number">8.0</span>以下的操作

<span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WorkEnqueuer</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ComponentName mComponentName<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//标识是否有JobId</span>
        <span class="token keyword">boolean</span> mHasJobId<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//对应的JobId 的值</span>
        <span class="token keyword">int</span> mJobId<span class="token punctuation">;</span>

        <span class="token function">WorkEnqueuer</span><span class="token punctuation">(</span>ComponentName cn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mComponentName <span class="token operator">=</span> cn<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * 设置 对应的JobId
         * @param jobId
         */</span>
        <span class="token keyword">void</span> <span class="token function">ensureJobId</span><span class="token punctuation">(</span><span class="token keyword">int</span> jobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasJobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mHasJobId <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mJobId <span class="token operator">=</span> jobId<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mJobId <span class="token operator">!=</span> jobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Given job ID "</span> <span class="token operator">+</span> jobId <span class="token operator">+</span> <span class="token string">" is different than previous "</span> <span class="token operator">+</span> mJobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">enqueueWork</span><span class="token punctuation">(</span>Intent work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
现在假设当前为<span class="token number">8.0</span>以上，那么就会执行  we <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobWorkEnqueuer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">JobWorkEnqueuer</span> <span class="token keyword">extends</span> <span class="token class-name">MatrixJobIntentService<span class="token punctuation">.</span>WorkEnqueuer</span> <span class="token punctuation">{</span>
     <span class="token keyword">private</span> <span class="token keyword">final</span> JobInfo mJobInfo<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">final</span> JobScheduler mJobScheduler<span class="token punctuation">;</span>

     <span class="token function">JobWorkEnqueuer</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ComponentName cn<span class="token punctuation">,</span> <span class="token keyword">int</span> jobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//设置对应的jobId</span>
        <span class="token function">ensureJobId</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//即每个需要后台的业务处理为一个job，通过系统管理job，来提高资源的利用率，从而提高性能，节省电源。这样又能满足APP开发商的要求，又能满足系统性能的要求。</span>
        <span class="token comment" spellcheck="true">//Jobscheduler由此应运而生。</span>
        JobInfo<span class="token punctuation">.</span>Builder b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobInfo<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>jobId<span class="token punctuation">,</span> mComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mJobInfo <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">setOverrideDeadline</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mJobScheduler <span class="token operator">=</span> <span class="token punctuation">(</span>JobScheduler<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>JOB_SCHEDULER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">void</span> <span class="token function">enqueueWork</span><span class="token punctuation">(</span>Intent work<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">//执行任务</span>
         mJobScheduler<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mJobInfo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JobWorkItem</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
在构造函数的时候，使用了JobScheduler，下面介绍下JobScheduler 这个的作用，以及用法 
JobScheduler是安卓<span class="token number">5.0</span>版本推出的API，允许开发者在符合某些条件时创建执行在后台的任务。在Android开发中，会存在这些场景<span class="token operator">:</span>你需要在稍后的某个时间点或者当满足某个特定的条件时执行一个任务，
例如当设备接通电源适配器或者连接到WIFI，此时就可以使用JobScheduler了，当一系列预置的条件被满足时，JobScheduler API为你的应用执行一个操作。与AlarmManager不同的是这个执行时间是不确定的。
除此之外，JobScheduler API允许同时执行多个任务。

JobSchedule的宗旨就是把一些不是特别紧急的任务放到更合适的时机批量处理。这样做有两个好处：避免频繁的唤醒硬件模块，造成不必要的电量消耗以及避免在不合适的时间
<span class="token punctuation">(</span>例如低电量情况下、弱网络或者移动网络情况下的<span class="token punctuation">)</span>执行过多的任务消耗电量。JobSchedule适用版本为<span class="token number">5.0</span>及以上，目前还未发现兼容库支持。

首先 创建一个JobScheduler
mJobScheduler <span class="token operator">=</span> <span class="token punctuation">(</span>JobScheduler<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>JOB_SCHEDULER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span> 实例化一个mJobScheduler的JobScheduler对象。

创建定时任务时，可以使用JobInfo<span class="token punctuation">.</span>Builder来构建一个JobInfo对象
JobInfo<span class="token punctuation">.</span>Builder b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobInfo<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>jobId<span class="token punctuation">,</span> mComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>

开启一个JobScheduler任务：
mJobScheduler<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mJobInfo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JobWorkItem</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
至此，这个任务会由系统在合适的时机点启动起来，至于什么时候启动我们不用关心，当启动的时候，就会将我们的这个CanaryWorkerService 启动起来

现在来介绍下如果在<span class="token number">8.0</span>以下，怎么保证创建这个服务肯定会被启动起来，继续回到前面获取到 <span class="token function">getWorkEnqueuer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 函数的地方
<span class="token keyword">static</span> WorkEnqueuer <span class="token function">getWorkEnqueuer</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ComponentName cn<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasJobId<span class="token punctuation">,</span> <span class="token keyword">int</span> jobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//首先从集合中获取，如果不为空，直接使用</span>
    WorkEnqueuer we <span class="token operator">=</span> sClassWorkEnqueuer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>we <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasJobId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Can't be here without a job id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token comment" spellcheck="true">//8.0 使用 JobScheduler</span>
             we <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobWorkEnqueuer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cn<span class="token punctuation">,</span> jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true">//低于 8.0 使用</span>
           we <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompatWorkEnqueuer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sClassWorkEnqueuer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cn<span class="token punctuation">,</span> we<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> we<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

下面是这个类的定义
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CompatWorkEnqueuer</span> <span class="token keyword">extends</span> <span class="token class-name">WorkEnqueuer</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Context mContext<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> PowerManager<span class="token punctuation">.</span>WakeLock mLaunchWakeLock<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> PowerManager<span class="token punctuation">.</span>WakeLock mRunWakeLock<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//标识是否启动服务完成</span>
        <span class="token keyword">boolean</span> mLaunchingService<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//标识当前服务是否正在处理</span>
        <span class="token keyword">boolean</span> mServiceProcessing<span class="token punctuation">;</span>

        <span class="token function">CompatWorkEnqueuer</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ComponentName cn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mContext <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//WakeLock正是为了解决这类问题，应用只要申请了WakeLock，那么在释放WakeLock之前，系统不会进入休眠，即使在灭屏的状态下，应用要执行的任务依旧不会被系统打断。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>WAKE_LOCK<span class="token punctuation">,</span> Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Process<span class="token punctuation">.</span><span class="token function">myUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Make wake locks.  We need two, because the launch wake lock wants to have</span>
                <span class="token comment" spellcheck="true">// a timeout, and the system does not do the right thing if you mix timeout and</span>
                <span class="token comment" spellcheck="true">// non timeout (or even changing the timeout duration) in one wake lock.</span>
                PowerManager pm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PowerManager<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>POWER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//PARTIAL_WAKE_LOCK: 灭屏，关闭键盘背光的情况下，CPU依然保持运行。</span>
                mLaunchWakeLock <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">newWakeLock</span><span class="token punctuation">(</span>PowerManager<span class="token punctuation">.</span>PARTIAL_WAKE_LOCK<span class="token punctuation">,</span> cn<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":launch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//在创建了PowerManager.WakeLock 后，有两种机制，第一种是不计数锁机制，另一种是计数锁机制。这可以通过setReferenceCounted( boolean value) 来指定，默认为计数机制。</span>
                <span class="token comment" spellcheck="true">// 这两种机制的区别在于，前者无论acquire() 了多少次，只要通过一次release() 即可解锁。而后者正真解锁是在（--count == 0 ）的时候，同样当（count == 0） 的时候才会去申请加锁，</span>
                <span class="token comment" spellcheck="true">// 其他情况下isHeld 状态是不会改变的。所以PowerManager.WakeLock 的计数机制并不是正真意义上的对每次请求进行申请／释放每一把锁，它只是对同一把锁被申请／释放的次数进行了统计。</span>
                mLaunchWakeLock<span class="token punctuation">.</span><span class="token function">setReferenceCounted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                mRunWakeLock <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">newWakeLock</span><span class="token punctuation">(</span>PowerManager<span class="token punctuation">.</span>PARTIAL_WAKE_LOCK<span class="token punctuation">,</span> cn<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//指定为 不计数锁机制</span>
                mRunWakeLock<span class="token punctuation">.</span><span class="token function">setReferenceCounted</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//没有权限</span>
                MatrixLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"it would be better to grant WAKE_LOCK permission to your app so that tinker can use WakeLock to keep system awake."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mLaunchWakeLock <span class="token operator">=</span> mRunWakeLock <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">enqueueWork</span><span class="token punctuation">(</span>Intent work<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>mComponentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//执行任务，启动服务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mLaunchingService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//标识启动服务完成</span>
                        mLaunchingService <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">//mServiceProcessing 默认为 false</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mServiceProcessing <span class="token operator">&amp;&amp;</span> mLaunchWakeLock <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// If the service is not already holding the wake lock for</span>
                            <span class="token comment" spellcheck="true">// itself, acquire it now to keep the system running until</span>
                            <span class="token comment" spellcheck="true">// we get this work dispatched.  We use a timeout here to</span>
                            <span class="token comment" spellcheck="true">// protect against whatever problem may cause it to not get</span>
                            <span class="token comment" spellcheck="true">// the work.</span>

                            <span class="token comment" spellcheck="true">//为了保证任务不被系统休眠打断，申请WakeLock,指定了时间，这样就不用手动的调用relese方法了</span>
                            <span class="token comment" spellcheck="true">//任务结束后释放，如果不写该句。则可以用wl.acquire(timeout)的方式把释放的工作交给系统</span>
                            <span class="token comment" spellcheck="true">//也即是过了60 秒之后会自动的释放</span>
                            mLaunchWakeLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
在构造函数中使用了Wakelock<span class="token punctuation">,</span>这里介绍下 WakeLock的作用
wakelock是一种锁的机制，只要有应用拿着这个锁，CPU就无法进入休眠状态，一直处于工作状态。比如，手机屏幕在屏幕关闭的时候，有些应用依然可以唤醒屏幕提示用户消息，
这里就是用到了wakelock锁机制，虽然手机屏幕关闭了，但是这些应用依然在运行着。手机耗电的问题，大部分是开发人员没有正确使用这个锁，成为<span class="token string">"待机杀手"</span>。
一般手机待机时，AP、LCD、WIFI均进入休眠状态，这时Android中应用程序的代码也会停止执行。
Android为了确保应用程序中关键代码的正确执行，提供了Wake Lock的API，使得应用程序有权限通过代码阻止AP进入休眠状态。但如果不领会Android设计者的意图而滥用Wake Lock API，
为了自身程序在后台的正常工作而长时间阻止AP进入休眠状态，就会成为待机电池杀手。

获取WakeLock实例代码如下<span class="token operator">:</span>
PowerManager pm <span class="token operator">=</span> <span class="token punctuation">(</span>PowerManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>POWER_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
WakeLock wakeLock <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">newWakeLock</span><span class="token punctuation">(</span>PowerManager<span class="token punctuation">.</span>PARTIAL_WAKE_LOCK<span class="token punctuation">,</span> <span class="token string">"MyWakelockTag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">newWakeLock</span><span class="token punctuation">(</span><span class="token keyword">int</span> levelAndFlags<span class="token punctuation">,</span> String tag<span class="token punctuation">)</span>中PowerManager<span class="token punctuation">.</span>PARTIIAL_WAKE_LOCK是一个标志位，标志位是用来控制获取的WakeLock对象的类型，主要控制CPU工作时屏幕是否需要亮着以及键盘灯需要亮着
WakeLock类可以用来控制设备的工作状态。使用该类中的acquire可以使CPU一直处于工作的状态，如果不需要使CPU处于工作状态就调用release来关闭。
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>、自动release
如果我们调用的是<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span>那么就无需我们自己手动调用<span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>来释放锁，系统会帮助我们在timeout时间后释放。
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>、手动release
如果我们调用的是<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span>那么就需要我们自己手动调用<span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>来释放锁。

所以这里就是使用了 Wakelock 让这个创建服务的过程，不会因为手机处于待机状态时，导致这个关键的操作没有执行，可以看到，在 <span class="token function">enqueueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>执行的时候，最终还是通过
mContext<span class="token punctuation">.</span><span class="token function">startService</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span> 来启动这个服务，至此这个对于<span class="token number">8.0</span>以下，这个服务也被启动起来了
</code></pre>
<p>接下来再分析 CanaryWorkerService 这个服务启动起来后，是怎么让让耗时的任务转到子线程中执行的</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanaryWorkerService</span> <span class="token keyword">extends</span> <span class="token class-name">MatrixJobIntentService</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">/**
     * 会在子线程中执行
     * @param intent The intent describing the work to now be processed.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onHandleWork</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//当前的操作为 分析 hprof 文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ACTION_SHRINK_HPROF<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//获取到传递过来的 HeapDump对象</span>
                <span class="token keyword">final</span> HeapDump heapDump <span class="token operator">=</span> <span class="token punctuation">(</span>HeapDump<span class="token punctuation">)</span> intent<span class="token punctuation">.</span><span class="token function">getSerializableExtra</span><span class="token punctuation">(</span>EXTRA_PARAM_HEAPDUMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>heapDump <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//执行分析操作</span>
                    <span class="token function">doShrinkHprofAndReport</span><span class="token punctuation">(</span>heapDump<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"failed to deserialize heap dump, give up shrinking and reporting."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
可以看到这个 CanaryWorkerService<span class="token punctuation">,</span>继承了 MatrixJobIntentService <span class="token punctuation">,</span>并且这个类中并没有看到任何的service的生命周期，所以对应的操作都是由父类完成的
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MatrixJobIntentService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">//8.0 使用这个执行耗时的任务</span>
    CompatJobEngine mJobImpl<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//8.0 以下使用 Workenqueuer,执行耗时的任务</span>
    WorkEnqueuer mCompatWorkEnqueuer<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//用来执行任务的对象</span>
    CommandProcessor mCurProcessor<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">//低于 8.0 要使用这个集合</span>
    <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>CompatWorkItem<span class="token operator">></span> mCompatQueue<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 静态的hashMap 用来存储 具体的 ComponentName 对应的 WorkEnqueuer
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> HashMap<span class="token operator">&lt;</span>ComponentName<span class="token punctuation">,</span> WorkEnqueuer<span class="token operator">></span> sClassWorkEnqueuer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

     <span class="token comment" spellcheck="true">/**
     * Default empty constructor.  构造函数
     */</span>
    <span class="token keyword">public</span> <span class="token function">MatrixJobIntentService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果sdk的版本 大于 8.0 直接使用 JobServiceEngine</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCompatQueue <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//如果小于8.0 使用 WorkEnqueuer</span>
            mCompatQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果大于 8.0 则构建一个 JobServiceEngine</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> <span class="token number">26</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mJobImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobServiceEngineImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCompatWorkEnqueuer <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mJobImpl <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//构建一个 ComponentName</span>
            ComponentName cn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//获取到ComponentName 对应的 WorkEnqueuer</span>
            mCompatWorkEnqueuer <span class="token operator">=</span> <span class="token function">getWorkEnqueuer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * Processes start commands when running as a pre-O service, enqueueing them to be
     * later dispatched in {@link #onHandleWork(Intent)}.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果 mCompatQueue 不为空 ，说明是8.0 以下的，添加到 mCompatQueue 中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatQueue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCompatWorkEnqueuer<span class="token punctuation">.</span><span class="token function">serviceStartReceived</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCompatQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//添加队列</span>
                mCompatQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompatWorkItem</span><span class="token punctuation">(</span>intent <span class="token operator">!=</span> null <span class="token operator">?</span> intent <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//提交任务</span>
                <span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//重传Intent。使用这个返回值时，如果在执行完onStartCommand后，服务被异常kill掉，系统会自动重启该服务，并将Intent的值传入。</span>
            <span class="token keyword">return</span> START_REDELIVER_INTENT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//非粘性的”。使用这个返回值时，如果在执行完onStartCommand后，服务被异常kill掉，系统不会自动重启该服务。</span>
            <span class="token keyword">return</span> START_NOT_STICKY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
所以看到在父类的构造函数 中就会判断当前的sdk 版本是否大于<span class="token number">8.0</span>以上，如果 大于<span class="token number">8.0</span>就将 mCompatQueue 赋值为 null，低于<span class="token number">8.0</span>以下，则执行 mCompatQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>初始化
接着在<span class="token function">onCeate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数中，也会判断当前的sdk的版本号，如果为 <span class="token number">8.0</span>以上，则执行  mJobImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobServiceEngineImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RequiresApi</span><span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">)</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">JobServiceEngineImpl</span> <span class="token keyword">extends</span> <span class="token class-name">JobServiceEngineimplements</span> MatrixJobIntentService<span class="token punctuation">.</span>CompatJobEngine <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"JobServiceEngineImpl"</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> DEBUG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> MatrixJobIntentService mService<span class="token punctuation">;</span>
        <span class="token keyword">final</span> Object mLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        JobParameters mParams<span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WrapperWorkItem</span> <span class="token keyword">implements</span> <span class="token class-name">MatrixJobIntentService<span class="token punctuation">.</span>GenericWorkItem</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> JobWorkItem mJobWork<span class="token punctuation">;</span>

            <span class="token function">WrapperWorkItem</span><span class="token punctuation">(</span>JobWorkItem jobWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mJobWork <span class="token operator">=</span> jobWork<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> Intent <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mJobWork<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mParams <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        mParams<span class="token punctuation">.</span><span class="token function">completeWork</span><span class="token punctuation">(</span>mJobWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">JobServiceEngineImpl</span><span class="token punctuation">(</span>MatrixJobIntentService service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mService <span class="token operator">=</span> service<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> IBinder <span class="token function">compatGetBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onStartJob</span><span class="token punctuation">(</span>JobParameters params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParams <span class="token operator">=</span> params<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// We can now start dequeuing work!</span>
            mService<span class="token punctuation">.</span><span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onStopJob</span><span class="token punctuation">(</span>JobParameters params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">doStopCurrentWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Once we return, the job is stopped, so its JobParameters are no</span>
                <span class="token comment" spellcheck="true">// longer valid and we should not be doing anything with them.</span>
                mParams <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * Dequeue some work.
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> MatrixJobIntentService<span class="token punctuation">.</span>GenericWorkItem <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            JobWorkItem work<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mParams <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                work <span class="token operator">=</span> mParams<span class="token punctuation">.</span><span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>work <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                work<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WrapperWorkItem</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
可以看到这个类继承了 JobServiceEngine，这个是系统的类，并且实现了自定义的接口<span class="token punctuation">,</span>下面是这个接口的定义
<span class="token comment" spellcheck="true">/**
* Get rid of lint warnings about API levels.
*/</span>
<span class="token keyword">interface</span> <span class="token class-name">CompatJobEngine</span> <span class="token punctuation">{</span>
    IBinder <span class="token function">compatGetBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GenericWorkItem <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
继续回到<span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 函数<span class="token punctuation">,</span>而是低于<span class="token number">8.0</span>的则会执行下面的操作
mJobImpl <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//构建一个 ComponentName</span>
ComponentName cn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取到ComponentName 对应的 WorkEnqueuer，对于 getWorkEnqueuer() 函数前面已经介绍过</span>
mCompatWorkEnqueuer <span class="token operator">=</span> <span class="token function">getWorkEnqueuer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> cn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
相比于 <span class="token number">8.0</span>以上会执行 
mJobImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobServiceEngineImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mCompatWorkEnqueuer <span class="token operator">=</span> null<span class="token punctuation">;</span>
可以看出来 mJobImpl<span class="token punctuation">,</span>跟 mCompatWorkEnqueuer 对象是互相排斥的，接着看看<span class="token function">onStartCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数，这个每次启动当前服务的时候都会触发，所以我们可以在这里获取到要执行的Intent

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//如果 mCompatQueue 不为空 ，说明是8.0 以下的，添加到 mCompatQueue 中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatQueue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         mCompatWorkEnqueuer<span class="token punctuation">.</span><span class="token function">serviceStartReceived</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCompatQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment" spellcheck="true">//添加队列</span>
             mCompatQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompatWorkItem</span><span class="token punctuation">(</span>intent <span class="token operator">!=</span> null <span class="token operator">?</span> intent <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment" spellcheck="true">//提交任务</span>
             <span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//重传Intent。使用这个返回值时，如果在执行完onStartCommand后，服务被异常kill掉，系统会自动重启该服务，并将Intent的值传入。</span>
        <span class="token keyword">return</span> START_REDELIVER_INTENT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//非粘性的”。使用这个返回值时，如果在执行完onStartCommand后，服务被异常kill掉，系统不会自动重启该服务。</span>
        <span class="token keyword">return</span> START_NOT_STICKY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

前面说过 mCompatQueue 在Android 版本<span class="token number">8.0</span>以下才会不为空，那么我们先分析下  <span class="token number">8.0</span>以下的执行逻辑<span class="token punctuation">,</span> 由于 mCompatQueue 不为空
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CompatWorkItem</span> <span class="token keyword">implements</span> <span class="token class-name">GenericWorkItem</span> <span class="token punctuation">{</span>
     <span class="token keyword">final</span> Intent mIntent<span class="token punctuation">;</span>
     <span class="token keyword">final</span> <span class="token keyword">int</span> mStartId<span class="token punctuation">;</span>

     <span class="token function">CompatWorkItem</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         mIntent <span class="token operator">=</span> intent<span class="token punctuation">;</span>
         mStartId <span class="token operator">=</span> startId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Intent <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mIntent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">stopSelf</span><span class="token punctuation">(</span>mStartId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//统一实现的接口，方便获取</span>
<span class="token keyword">interface</span> <span class="token class-name">GenericWorkItem</span> <span class="token punctuation">{</span>
    Intent <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
首先将当前获取到Intent，已经startId，封装到 CompatWorkItem <span class="token punctuation">,</span>然后添加到mCompatQueue 队列中，接着执行 <span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@TargetApi</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> reportStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">//如果  mCurProcessor 为空，则构建一个 CommandProcessor 对象，本质为 AsynTask对象</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurProcessor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         mCurProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token comment" spellcheck="true">//利用AsyncTask 执行多线程任务，提交任务</span>
         mCurProcessor<span class="token punctuation">.</span><span class="token function">executeOnExecutor</span><span class="token punctuation">(</span>AsyncTask<span class="token punctuation">.</span>THREAD_POOL_EXECUTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
一开始mCurProcessor 为空，所以会执行  mCurProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CommandProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncTask</span><span class="token operator">&lt;</span>Void<span class="token punctuation">,</span> Void<span class="token punctuation">,</span> Void<span class="token operator">></span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">protected</span> Void <span class="token function">doInBackground</span><span class="token punctuation">(</span>Void<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         GenericWorkItem work<span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">//遍历执行任务列表中的任务</span>
         <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>work <span class="token operator">=</span> <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment" spellcheck="true">//回调给子线程中执行</span>
             <span class="token function">onHandleWork</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment" spellcheck="true">//标识当前任务执行完成</span>
             work<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment" spellcheck="true">/**
     * AsyncTask 取消任务的执行
     * @param aVoid
     */</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCancelled</span><span class="token punctuation">(</span>Void aVoid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">processorFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment" spellcheck="true">/**
     * AsyncTask 执行完队列中所有的任务之后，通过执行  processorFinished 告知任务结束的时机
     * @param aVoid
     */</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPostExecute</span><span class="token punctuation">(</span>Void aVoid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processorFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
可以看出这本质是一个 AsyncTask<span class="token punctuation">,</span>接着调用 mCurProcessor<span class="token punctuation">.</span><span class="token function">executeOnExecutor</span><span class="token punctuation">(</span>AsyncTask<span class="token punctuation">.</span>THREAD_POOL_EXECUTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>那么这个任务就会提交给 AsycTask执行了，那么当AsyncTask执行的时候
就会触发<span class="token function">doInBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，我们看看这里所做的操作
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>work <span class="token operator">=</span> <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//回调给子线程中执行</span>
      <span class="token function">onHandleWork</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//标识当前任务执行完成</span>
      work<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/**
* 获取到队列的元素
* @return
*/</span>
GenericWorkItem <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mJobImpl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> mJobImpl<span class="token punctuation">.</span><span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatQueue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCompatQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatQueue <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mCompatQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">return</span> mCompatQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> null<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
由于当前我们假设为 <span class="token number">8.0</span>以下，所以 mJobImpl 为空，mCompatQueue 不为空，所以下面的逻辑就很简单了，通过从mCompatQueue 队列中移除对首的元素，然后执行这个任务，前面我们在onStartCommand
的时候会将任务添加到这个队列中，所以这里就能获取到添加的任务，接着执行  <span class="token function">onHandleWork</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>而  <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">onHandleWork</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Intent intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
为抽象方法，需要由子类实现，回到前面我们 说过的 CanaryWorkerService定义中，可以看到这个子类就实现了这个方法，


现在我们来分析下那么对于 <span class="token number">8.0</span>以上，多次的启动服务，传递任务的时候，是怎么样将任务执行起来的，我们知道多次启动服务会调用onStartCommand
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">onStartCommand</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Intent intent<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">//如果 mCompatQueue 不为空 ，说明是8.0 以下的，添加到 mCompatQueue 中</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatQueue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mCompatWorkEnqueuer<span class="token punctuation">.</span><span class="token function">serviceStartReceived</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCompatQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment" spellcheck="true">//添加队列</span>
             mCompatQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompatWorkItem</span><span class="token punctuation">(</span>intent <span class="token operator">!=</span> null <span class="token operator">?</span> intent <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> startId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment" spellcheck="true">//提交任务</span>
             <span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">//重传Intent。使用这个返回值时，如果在执行完onStartCommand后，服务被异常kill掉，系统会自动重启该服务，并将Intent的值传入。</span>
          <span class="token keyword">return</span> START_REDELIVER_INTENT<span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">//非粘性的”。使用这个返回值时，如果在执行完onStartCommand后，服务被异常kill掉，系统不会自动重启该服务。</span>
         <span class="token keyword">return</span> START_NOT_STICKY<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
由于我们这里为 <span class="token number">8.0</span> 以上，所以mCompatQueue 为空，所以会直接返回 START_NOT_STICKY，可以看到这里并没有执行任何的操作，还记得我们前面分析过 当我们使用JobScheduler 安排执行任务的时候
会在未来的某一个合适的时间点启动起来，那么系统就要告知我们他启动的时机点，我们在onCreate的时候，在<span class="token number">8.0</span>以上，创建了一个JobServiceEngineImpl 对象

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">JobServiceEngineImpl</span> <span class="token keyword">extends</span> <span class="token class-name">JobServiceEngine</span>
            <span class="token keyword">implements</span> <span class="token class-name">MatrixJobIntentService<span class="token punctuation">.</span>CompatJobEngine</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onStartJob</span><span class="token punctuation">(</span>JobParameters params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mParams <span class="token operator">=</span> params<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// We can now start dequeuing work!</span>
            mService<span class="token punctuation">.</span><span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onStopJob</span><span class="token punctuation">(</span>JobParameters params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">doStopCurrentWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Once we return, the job is stopped, so its JobParameters are no</span>
                <span class="token comment" spellcheck="true">// longer valid and we should not be doing anything with them.</span>
                mParams <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * Dequeue some work.
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> MatrixJobIntentService<span class="token punctuation">.</span>GenericWorkItem <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            JobWorkItem work<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mParams <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                work <span class="token operator">=</span> mParams<span class="token punctuation">.</span><span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>work <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                work<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WrapperWorkItem</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>    
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
下面来介绍下这些回调函数的作用

当开始一个任务时，onstartjob（jobparameters params） 是必须使用的方法，因为它是系统用来触发已经安排的工作（job）的。从上边的用例代码可以看到，该方法返回一个布尔值。不同的返回值对应了不同的处理方式。
如果返回值是<span class="token boolean">false</span>，该系统假定任何任务运行不需要很长时间并且到方法返回时已经完成。

如果返回值是<span class="token boolean">true</span>，那么系统假设任务是需要一些时间并且是需要在我们自己应用执行的。当给定的任务完成时需要通过调用
<span class="token function">jobFinished</span><span class="token punctuation">(</span>JobParameters params<span class="token punctuation">,</span> <span class="token keyword">boolean</span> needsRescheduled<span class="token punctuation">)</span>告知系统，该任务已经处理完成。如果返回值为<span class="token boolean">true</span>，我们需要手动调用jobFinished来停止该任务

所以onStartJob 就是系统执行任务的时机点，由于这里返回了<span class="token boolean">true</span>，告知系统我们执行的是耗时的任务，我们自己完成任务的执行过程，但是需要手动的调用<span class="token function">jobFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span>标记当前任务执行完成，好让
系统继续执行下一个任务<span class="token punctuation">,</span>在 onStartJob中有这样的逻辑  mService<span class="token punctuation">.</span><span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@TargetApi</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">ensureProcessorRunningLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> reportStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//如果  mCurProcessor 为空，则构建一个 CommandProcessor 对象，本质为 AsynTask对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurProcessor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         mCurProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">//告知耗时任务执行前的回调</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatWorkEnqueuer <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> reportStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              mCompatWorkEnqueuer<span class="token punctuation">.</span><span class="token function">serviceProcessingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment" spellcheck="true">//利用AsyncTask 执行多线程任务，提交任务</span>
         mCurProcessor<span class="token punctuation">.</span><span class="token function">executeOnExecutor</span><span class="token punctuation">(</span>AsyncTask<span class="token punctuation">.</span>THREAD_POOL_EXECUTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

前面我们分析过，这是通过AsycTask来执行耗时的任务，本身通过回调 onStartJob 的时候，只是告诉你这个执行的时机点，至于任务的耗时执行，还是要自己来执行，那么继续看 doInBackground的函数
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>work <span class="token operator">=</span> <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">//回调给子线程中执行</span>
     <span class="token function">onHandleWork</span><span class="token punctuation">(</span>work<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//标识当前任务执行完成</span>
     work<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/**
* 获取到队列的元素
* @return
*/</span>
GenericWorkItem <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mJobImpl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mJobImpl<span class="token punctuation">.</span><span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatQueue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mCompatQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>mCompatQueue <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mCompatQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> mCompatQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
由于此时为 <span class="token number">8.0</span>以上，所以会执行  mJobImpl<span class="token punctuation">.</span><span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>，也即是会执行到
<span class="token keyword">public</span> MatrixJobIntentService<span class="token punctuation">.</span>GenericWorkItem <span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      JobWorkItem work<span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mParams <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> null<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          work <span class="token operator">=</span> mParams<span class="token punctuation">.</span><span class="token function">dequeueWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>work <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           work<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>mService<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WrapperWorkItem</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
mParams 由 <span class="token function">onStartJob</span><span class="token punctuation">(</span>JobParameters params<span class="token punctuation">)</span>回调的时候，保存下来当前执行的任务参数<span class="token punctuation">,</span>所以这里不为空，最终获取到对应的Intent，然后传递给子类<span class="token function">onHandleWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>中实现具体的耗时操作
这里的耗时任务主要是执行 <span class="token function">doShrinkHprofAndReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onHandleWork</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//当前的操作为 分析 hprof 文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ACTION_SHRINK_HPROF<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//获取到传递过来的 HeapDump对象</span>
                <span class="token keyword">final</span> HeapDump heapDump <span class="token operator">=</span> <span class="token punctuation">(</span>HeapDump<span class="token punctuation">)</span> intent<span class="token punctuation">.</span><span class="token function">getSerializableExtra</span><span class="token punctuation">(</span>EXTRA_PARAM_HEAPDUMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>heapDump <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//执行分析操作</span>
                    <span class="token function">doShrinkHprofAndReport</span><span class="token punctuation">(</span>heapDump<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    MatrixLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"failed to deserialize heap dump, give up shrinking and reporting."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanaryWorkerService</span> <span class="token keyword">extends</span> <span class="token class-name">MatrixJobIntentService</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
    <span class="token comment" spellcheck="true">/**
     * 分析 hprof文件
     * @param heapDump
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doShrinkHprofAndReport</span><span class="token punctuation">(</span>HeapDump heapDump<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取到当前  hprof 上一级</span>
        <span class="token keyword">final</span> File hprofDir <span class="token operator">=</span> heapDump<span class="token punctuation">.</span><span class="token function">getHprofFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//创建一个 文件  _shrink.hprof 文件</span>
        <span class="token keyword">final</span> File shrinkedHProfFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>hprofDir<span class="token punctuation">,</span> <span class="token function">getShrinkHprofName</span><span class="token punctuation">(</span>heapDump<span class="token punctuation">.</span><span class="token function">getHprofFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//创建一个zip 文件路径</span>
        <span class="token keyword">final</span> File zipResFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>hprofDir<span class="token punctuation">,</span> <span class="token function">getResultZipName</span><span class="token punctuation">(</span><span class="token string">"dump_result_"</span> <span class="token operator">+</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到原本的 hprof 文件路径</span>
        <span class="token keyword">final</span> File hprofFile <span class="token operator">=</span> heapDump<span class="token punctuation">.</span><span class="token function">getHprofFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ZipOutputStream zos <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//分析之前获得当前的时间</span>
            <span class="token keyword">long</span> startTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//分析原本的 hprof 文件，将有用的信息重新写入到 shrinkedHprofFile 中，也即是所谓的 对检测部分生成的 Hprof 文件进行了裁剪，移除了大部分无用数据</span>
            <span class="token keyword">new</span> <span class="token class-name">HprofBufferShrinker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shrink</span><span class="token punctuation">(</span>hprofFile<span class="token punctuation">,</span> shrinkedHProfFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

            MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"shrink hprof file %s, size: %dk to %s, size: %dk, use time:%d"</span><span class="token punctuation">,</span>
                    hprofFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hprofFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> shrinkedHProfFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shrinkedHProfFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//往 zipResFile 压缩包里面填充一个元素为  result.info</span>
            zos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>zipResFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ZipEntry resultInfoEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipEntry</span><span class="token punctuation">(</span><span class="token string">"result.info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ZipEntry shrinkedHProfEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipEntry</span><span class="token punctuation">(</span>shrinkedHProfFile<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zos<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span>resultInfoEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//接下里 往 result.info 写内容</span>
            <span class="token keyword">final</span> PrintWriter pw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>zos<span class="token punctuation">,</span> Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"# Resource Canary Result Infomation. THIS FILE IS IMPORTANT FOR THE ANALYZER !!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"sdkVersion="</span> <span class="token operator">+</span> Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"manufacturer="</span> <span class="token operator">+</span> Build<span class="token punctuation">.</span>MANUFACTURER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//对应的hprof 文件</span>
            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hprofEntry="</span> <span class="token operator">+</span> shrinkedHProfEntry<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//当前泄漏的类名</span>
            pw<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"leakedActivityKey="</span> <span class="token operator">+</span> heapDump<span class="token punctuation">.</span><span class="token function">getReferenceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zos<span class="token punctuation">.</span><span class="token function">closeEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            zos<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span>shrinkedHProfEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">copyFileToStream</span><span class="token punctuation">(</span>shrinkedHProfFile<span class="token punctuation">,</span> zos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            zos<span class="token punctuation">.</span><span class="token function">closeEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            shrinkedHProfFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hprofFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"process hprof file use total time:%d"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//将当前分析的结果， 通知出去 ,这个服务 跟当前的应用程序在 同一个进程中</span>
            CanaryResultService<span class="token punctuation">.</span><span class="token function">reportHprofResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> zipResFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> heapDump<span class="token punctuation">.</span><span class="token function">getActivityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">printErrStackTrace</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">closeQuietly</span><span class="token punctuation">(</span>zos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
这个函数会解析当前生成的hprof 文件，按照格式解析出特定有用的内容，比如用来判断Bitmap 重复的内容等，之后将解析之后认为有用的内容重新写到另一个hprof文件，这个官网称为
对检测部分生成的 Hprof 文件进行了裁剪，移除了大部分无用数据，降低了传输 Hprof 文件的开销，之后再创建一个 result<span class="token punctuation">.</span>info 文件，里面输入当前检测的泄漏的类名，sdk的版本号，机型的类型
等，最终将这些内容打包成zip包，后面在通过CanaryResultService<span class="token punctuation">.</span><span class="token function">reportHprofResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> zipResFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> heapDump<span class="token punctuation">.</span><span class="token function">getActivityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 将泄漏的Activity信息，显示出来
这里就不分析了<span class="token punctuation">,</span>至此流程差不多就是这样的
</code></pre>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p>对于 Resource Cannary的做法是 首先使用registerActivityLifecycleCallbacks 监听onActivityDestroyed 函数，接着在 onActivityDestroyed() 中将当前要销毁的Activity内容封装成一个DestroyedActivityInfo，然后添加到mDestroyedActivityInfos 中，接着开启一个扫描这个队列的任务，如果队列中有元素，为了防止系统忽略掉我们的Gc操作，首先进行测试声明了一个匿名的对象，然后触发Gc的操作，如果看这个对象是否还存在，如果存在，就说明系统忽略了我们的Gc操作，那么下次再来检查，当然假设当前系统没有忽略掉我们的Gc操作，之后的操作还是有可能会忽略的，所以为了防止误判，我们在第一次Gc的时候发现由WeakReference封装的对象还存在，那么还要再多触发俩次，如果达到了三次还是存在，那说明这个对象内存泄漏了，此时执行 Dump hprof的操作，由于这个dump hprof 耗时，所以放在了子线程中执行了，为了防止频繁的dump操作，我们通过在主线程的Handler里面设置了addIdleCallback的监听，当主线程没有消息要处理的时候，就会回调这个函数，将CountDownLatch 减一处理，当子线程调用CountDownLatch.wait的时候，可以判断主线程是否有回调addIdleHandler函数，如果回调了内部会减一处理，如果当前没有回调addIdleHandler函数，那么子线程调用 wait函数等待五秒之后还没有结果，就直接return，终止掉当前的这次dump请求，接着就是分析这个dump 下来的hprof 文件了，这里是启动了服务，这个服务在另一个进程里面，为了让这个服务进程能顺利的启动起来，在8.0以下使用了WakeLock，在8.0以上使用JobScheduler,同时在服务里面 通过AsyncTask 让分析的操作在子线程中执行，这就是大概的逻辑</p>
</blockquote>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><a href="https://github.com/Tencent/matrix#matrix_cn" target="_blank" rel="noopener">Matrix</a></li>
<li><a href="https://www.cnblogs.com/leipDao/p/8241468.html" target="_blank" rel="noopener">安卓电量优化之WakeLock锁机制全面解析</a></li>
<li><a href="https://www.cnblogs.com/leipDao/p/8268918.html" target="_blank" rel="noopener">安卓电量优化之JobScheduler使用介绍</a></li>
<li><a href="https://www.jianshu.com/p/9fb882cae239" target="_blank" rel="noopener">Android Jobscheduler使用</a></li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">AheadSnail</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://aheadsnail.github.io/2019/03/15/matrix-resource-cannary-yuan-ma-jie-xi/">https://aheadsnail.github.io/2019/03/15/matrix-resource-cannary-yuan-ma-jie-xi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">AheadSnail</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Android/">
                                    <span class="chip bg-color">Android</span>
                                </a>
                            
                                <a href="/tags/Matrix/">
                                    <span class="chip bg-color">Matrix</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'IHAROYQfeblNBhewb7XcnPvS-gzGzoHsz',
        appKey: 'W2Wktehj1wV33eFF0A6B6elX',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/07/20/valgrind-native-nei-cun-jian-ce/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Valgrind Native 内存检测">
                        
                        <span class="card-title">Valgrind Native 内存检测</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            概述
Valgrind Native 内存检测

                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2019-07-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/NDK/">
                        <span class="chip bg-color">NDK</span>
                    </a>
                    
                    <a href="/tags/Valgrind/">
                        <span class="chip bg-color">Valgrind</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/03/14/matrix-sqlite-lint-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="Matrix SQLite Lint源码解析">
                        
                        <span class="card-title">Matrix SQLite Lint源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            概述
Matrix SQLite Lint源码解析

                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2019-03-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Matrix/">
                        <span class="chip bg-color">Matrix</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">AheadSnail</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
