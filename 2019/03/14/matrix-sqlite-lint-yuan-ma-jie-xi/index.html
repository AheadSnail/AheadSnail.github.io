<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Matrix SQLite Lint源码解析, AheadSnail&#39;s blog">
    <meta name="description" content>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Matrix SQLite Lint源码解析 | AheadSnail&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<link rel="alternate" href="/atom.xml" title="AheadSnail's blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">AheadSnail&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">AheadSnail&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/10.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Matrix SQLite Lint源码解析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Matrix/">
                                <span class="chip bg-color">Matrix</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-03-14
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>Matrix SQLite Lint源码解析</p>
</blockquote>
<a id="more"></a>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>前面分析了Matrix 中 IO Canary 模块，了解了对应的检测原理实现，本文继续分析 SQLite Lint 模块,在分析这块内容的时候最好知道对于SQLite Lint的性能主要检测的内容有哪些,这个可以参考这篇文章<br><a href="https://mp.weixin.qq.com/s/laUgOmAcMiZIOfM2sWrQgw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/laUgOmAcMiZIOfM2sWrQgw</a><br>文中介绍到他可以在我们开发，测试或者灰度阶段就可以发现隐藏的问题，既然要检测sql语句，那么就设计到了怎么收集App运行时的sql执行信息，包括执行语句、创建的表信息等。其中表相关信息可以通过 pragma 命令得到。对于执行语句，有两种情况<br>a）DB 框架提供了回调接口。比如微信使用的是 WCDB ，很容易就可以通过MMDataBase.setSQLiteTrace 注册回调拿到这些信息。<br>b）若使用 Android 默认的 DB 框架，SQLiteLint 提供了一种无侵入的获取到执行的sql语句及耗时等信息的方式。通过hook的技巧，向 SQLite3 C 层的   api sqlite3_profile 方法注册回调，<br>也能拿到分析所需的信息，从而无需开发者额外的打点统计代码。但是通过我阅读源码发现这个hook在7.0以上存在问题，源码的demo也并没有使用这种方式，而是通过一种通知的方式，也即是开发者将要检测的sql语句直接传递给SQLiteLint<br>对于检测的选项这里包括：<br>1.检测索引使用问题<br>2.检测冗余索引问题<br>3.检测 select * 问题<br>4.检测 Autoincrement 问题<br>5.检测建议使用 prepared statement<br>至于为什么要检测这些内容，具体可以查看上面的连接，文章中已经介绍的很清楚了，甚至包括了检测的标准</p>
</blockquote>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>在SQLite Lint页面中包含了下面的检测<br><img src="/uploads/Matrix Trace分析/SqliteLint检测的条目.png" alt="结果显示"></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><pre class=" language-java"><code class="language-java">先看demo 的调用过程
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MatrixApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> SQLiteLintConfig <span class="token function">initSQLiteLintConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteLintConfig</span><span class="token punctuation">(</span>SQLiteLint<span class="token punctuation">.</span>SqlExecutionCallbackMode<span class="token punctuation">.</span>CUSTOM_NOTIFY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteLintConfig</span><span class="token punctuation">(</span>SQLiteLint<span class="token punctuation">.</span>SqlExecutionCallbackMode<span class="token punctuation">.</span>CUSTOM_NOTIFY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        SQLiteLintConfig config <span class="token operator">=</span> <span class="token function">initSQLiteLintConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SQLiteLintPlugin sqLiteLintPlugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteLintPlugin</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>sqLiteLintPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

    首先是执行了initSQLiteLintConfig ，构建了一个 SQLiteLintConfig对象，这里传递的模式为CUSTOM_NOTIFY，下面看看这俩个模式的选择，可以知道在<span class="token number">7.0</span>之后hook就会失败
    <span class="token comment" spellcheck="true">/**
     * The first step of SQLiteLint is to collect the executed sqls.  SQL的检测，第一步就是收集Sql的信息
     * Two way to achieve this.
     *
     * #HOOK: We will hook sqlite3_profile, and it will callback to our method when sqls are executed.
     * @see com.tencent.sqlitelint.util.SQLite3ProfileHooker
     * But hook will fail when tha android version is over Androd N.   但是在 Android N 以上 这个会失败
     * TODO try to break through this limitation
     *
     * #CUSTOM_NOTIFY: It means that the user is responbisable to notify the sql execution.  通过通知的的方式来告知sql的执行
     * @see #notifySqlExecution(String, String, int)
     * TODO link example
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> SqlExecutionCallbackMode <span class="token punctuation">{</span>
        HOOK<span class="token punctuation">,</span>
        CUSTOM_NOTIFY<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//构建一个 SQLiteLintConfig 对象,这里传递进来的模式 CUSTOM_NOTIFY</span>
    <span class="token keyword">public</span> <span class="token function">SQLiteLintConfig</span><span class="token punctuation">(</span>SQLiteLint<span class="token punctuation">.</span>SqlExecutionCallbackMode sqlExecutionCallbackMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">setSqlExecutionCallbackMode</span><span class="token punctuation">(</span>sqlExecutionCallbackMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sConcernDbList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

接着执行  SQLiteLint<span class="token punctuation">.</span><span class="token function">setSqlExecutionCallbackMode</span><span class="token punctuation">(</span>sqlExecutionCallbackMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLiteLint</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * 首先执行 SqliteLint-lib so 的加载
     */</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        SQLiteLintNativeBridge<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">SQLiteLint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 当前所采用的的Sql的检测方式
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> SqlExecutionCallbackMode sSqlExecutionCallbackMode <span class="token operator">=</span> null<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setSqlExecutionCallbackMode</span><span class="token punctuation">(</span>SqlExecutionCallbackMode sqlExecutionCallbackMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sSqlExecutionCallbackMode <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//赋值成员变量，标识当前所采用的模式</span>
        sSqlExecutionCallbackMode <span class="token operator">=</span> sqlExecutionCallbackMode<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//如果为Hook方案</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sSqlExecutionCallbackMode <span class="token operator">==</span> SqlExecutionCallbackMode<span class="token punctuation">.</span>HOOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// hook must called before open the database</span>
            SQLite3ProfileHooker<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

在执行这个<span class="token function">setSqlExecutionCallbackMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数之前，先看静态代码块的内容<span class="token punctuation">,</span>执行了 SQLiteLintNativeBridge<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLiteLintNativeBridge</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * 加载so的操作
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"SqliteLint-lib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SLog<span class="token punctuation">.</span><span class="token function">nativeSetLogger</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

可以看出首先调用了 System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"SqliteLint-lib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 将 SqliteLint<span class="token operator">-</span>lib 加载进来，这样就会调用的JNI_ONLoad函数的执行<span class="token punctuation">,</span>具体的实现是在loader<span class="token punctuation">.</span>cc 中
当调用System<span class="token punctuation">.</span>loadLibrary 的时候就会调用这个方法

JNIEXPORT jint JNICALL <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sqlitelint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">LOGE</span><span class="token punctuation">(</span> <span class="token string">"Initialize GetEnv null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//将 g_loaders 集合成员 中 init 为 true 的执行初始化的操作</span>
    vector<span class="token operator">&lt;</span>JNIModule<span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator e <span class="token operator">=</span> g_loaders<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>JNIModule<span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> g_loaders<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> e<span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果当前为初始化的时候，默认为 1的</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token operator">-</span><span class="token operator">></span>init<span class="token punctuation">)</span>
       <span class="token punctuation">{</span>
            sqlitelint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">LOGI</span><span class="token punctuation">(</span> <span class="token string">"Initialize module '%s'..."</span><span class="token punctuation">,</span> it<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//执行对应的函数指针</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token operator">-</span><span class="token operator">></span><span class="token function">func</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> env<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

这里的g_loaders 的定义为
struct JNIModule
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//注册的名称</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//回调函数</span>
    ModuleInitializer func<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//是否初始化</span>
    bool init<span class="token punctuation">;</span>

    <span class="token function">JNIModule</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name_<span class="token punctuation">,</span> ModuleInitializer func_<span class="token punctuation">,</span> bool init_<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">name</span><span class="token punctuation">(</span>name_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">func</span><span class="token punctuation">(</span>func_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">init</span><span class="token punctuation">(</span>init_<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//全局的 g_loaders 集合</span>
<span class="token keyword">static</span> vector<span class="token operator">&lt;</span>JNIModule<span class="token operator">></span> <span class="token operator">*</span>g_loaders <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
可以看出 g_loaders 是一个全局的成员集合变量，用来存储JNIModule 的成员<span class="token punctuation">,</span>JNIModule的定义就在上面<span class="token punctuation">,</span>所以很好奇，难道g_loaders 在执行 JNI_OnLoad的时候就已经有内容了吗，如果有那么是怎么样
添加进来的呢<span class="token punctuation">,</span>我们在 sqlite3_profile_hook<span class="token punctuation">.</span>cc 中发现了有这样的内容<span class="token punctuation">,</span>下面的内容看起来就像是 MODULE_INIT 执行初始化，MODULE_FINI用来执行销毁的操作

    <span class="token function">MODULE_INIT</span><span class="token punctuation">(</span>sqlite3_proifle_hook<span class="token punctuation">)</span><span class="token punctuation">{</span>
        kInitSuc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        kJvm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
        jint result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//找到 SQLiteLintUtil</span>
        jclass utilClass <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/tencent/sqlitelint/util/SQLiteLintUtil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>utilClass <span class="token operator">==</span> nullptr<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//由于涉及到多线程，所以要变成GlobalRef</span>
        kUtilClass <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>jclass<span class="token operator">></span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>utilClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//找到 SQLiteLintUtil 中的 getThrowableStack  方法</span>
        kMethodIDGetThrowableStack <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>kUtilClass<span class="token punctuation">,</span> <span class="token string">"getThrowableStack"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kMethodIDGetThrowableStack <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//标识初始化成功</span>
        kInitSuc <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MODULE_FINI</span><span class="token punctuation">(</span>sqlite3_proifle_hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//释放全局的 引用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kUtilClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteGlobalRef</span><span class="token punctuation">(</span>kUtilClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//重置变量</span>
        kInitSuc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        kStop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    下面我们看看MODULE_INIT，MODULE_FINI的定义
    #define <span class="token function">MODULE_INIT</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> \
    <span class="token keyword">static</span> <span class="token keyword">int</span> ModuleInit_##<span class="token function">name</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> MODULE_INIT_##<span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> \
    <span class="token punctuation">{</span> \
        <span class="token function">register_module_func</span><span class="token punctuation">(</span>#name<span class="token punctuation">,</span> ModuleInit_##name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token punctuation">}</span> \
    <span class="token keyword">static</span> <span class="token keyword">int</span> ModuleInit_##<span class="token function">name</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span>

    #define <span class="token function">MODULE_FINI</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> \
    <span class="token keyword">static</span> <span class="token keyword">int</span> ModuleFini_##<span class="token function">name</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> MODULE_FINI_##<span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> \
    <span class="token punctuation">{</span> \
       <span class="token function">register_module_func</span><span class="token punctuation">(</span>#name<span class="token punctuation">,</span> ModuleFini_##name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \
    <span class="token punctuation">}</span> \
    这里要注意这俩个宏有一个不同点就是调用<span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>第三个参数不一样，这个参数<span class="token number">1</span>代表为初始化的时候调用，<span class="token number">0</span>代表销毁的时候调用

    <span class="token keyword">static</span> <span class="token keyword">int</span> ModuleFini_##<span class="token function">name</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span>
    可以看出其实他们是一个宏，那么就很简单了，宏在c中只要直接展开就好了，比如我们展开一个内容少一点的 比如  <span class="token function">MODULE_FINI</span><span class="token punctuation">(</span>sqlite3_proifle_hook<span class="token punctuation">)</span>函数，下面就是展开的内容

    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ModuleFini_sqlite3_proifle_hook</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//声明    __attribute__((constructor))  会在 main函数执行之前被执行</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">MODULE_FINI_sqlite3_proifle_hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token string">"sqlite3_proifle_hook"</span><span class="token punctuation">,</span> ModuleFini_sqlite3_proifle_hook<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//定义</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ModuleFini_sqlite3_proifle_hook</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kUtilClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteGlobalRef</span><span class="token punctuation">(</span>kUtilClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kInitSuc <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        kStop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    展开之后就很简答了，一个是函数的声明，一个是函数的定义，唯一的这个要解释下
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">MODULE_FINI_sqlite3_proifle_hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token string">"sqlite3_proifle_hook"</span><span class="token punctuation">,</span> ModuleFini_sqlite3_proifle_hook<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    这个其实是使用了 __attribute__中constructor和destructor，使用了之后，这个函数被设定为destructor属性，则该函数会在main（）函数执行之后或者exit（）被调用后被自动的执行
    由于我们的为 <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">)</span> 所以会在main函数执行之前就会调用这个函数<span class="token punctuation">,</span>所以会执行
    <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token string">"sqlite3_proifle_hook"</span><span class="token punctuation">,</span> ModuleFini_sqlite3_proifle_hook<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    先看看 <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数
    SQLITELINT_EXPORT <span class="token keyword">void</span> <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> ModuleInitializer func<span class="token punctuation">,</span> <span class="token keyword">int</span> init<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> ModuleInitializer func<span class="token punctuation">,</span> <span class="token keyword">int</span> init<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果为空，创建一个集合的对象，用来存储 JNIModule</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_loaders<span class="token punctuation">)</span>
             g_loaders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vector</span><span class="token operator">&lt;</span>JNIModule<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//!!init 代表取反， 也即是为true 默认值</span>
        g_loaders<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">JNIModule</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token operator">!</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    而其中  ModuleInitializer其实为一个函数指针，下面是定义
    typedef <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ModuleInitializer<span class="token punctuation">)</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> JNIEnv <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    而我们的<span class="token function">ModuleFini_sqlite3_proifle_hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数，刚好满足这个条件，那么到了这里就很简单了，当调用到 
    <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token string">"sqlite3_proifle_hook"</span><span class="token punctuation">,</span> ModuleFini_sqlite3_proifle_hook<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 对应到<span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，将参数一一对应的化，name就为sqlite3_proifle_hook字符串
    所以这里做的内容就是将这些传递过来的参数，构建成一个JNIModule，然后添加到了g_loaders全局变量中，那么对于<span class="token function">MODULE_INIT</span><span class="token punctuation">(</span>sqlite3_proifle_hook<span class="token punctuation">)</span>也是类似的，只是这里调用
    <span class="token function">register_module_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>的时候，第三个参数为<span class="token number">1</span>，代表在初始化的时候执行，而<span class="token function">MODULE_FINI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>为在销毁的时候执行，下面我们看看这俩个参数的区别

再次回到JNI_OnLoad函数
<span class="token comment" spellcheck="true">//当调用System.loadLibrary 的时候就会调用这个方法</span>
extern <span class="token string">"C"</span> JNIEXPORT jint JNICALL <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sqlitelint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">LOGE</span><span class="token punctuation">(</span> <span class="token string">"Initialize GetEnv null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//将 g_loaders 集合成员 中 init 为 true 的执行初始化的操作</span>
    vector<span class="token operator">&lt;</span>JNIModule<span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator e <span class="token operator">=</span> g_loaders<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>JNIModule<span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> g_loaders<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> e<span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果当前为初始化的时候，默认为 1的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token operator">-</span><span class="token operator">></span>init<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            sqlitelint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">LOGI</span><span class="token punctuation">(</span> <span class="token string">"Initialize module '%s'..."</span><span class="token punctuation">,</span> it<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//执行对应的函数指针</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token operator">-</span><span class="token operator">></span><span class="token function">func</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> env<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
在遍历g_loaders集合的时候，当it<span class="token operator">-</span><span class="token operator">></span>init为真的时候就执行it<span class="token operator">-</span><span class="token operator">></span><span class="token function">func</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> env<span class="token punctuation">)</span>，前面已经说过JNIModule，这里的init对应的就为 <span class="token number">0</span>或者<span class="token number">1</span>， 当使用MODULE_INIT就为<span class="token number">1</span>，MODULE_FINI就为<span class="token number">0</span>，func为函数指针
所以可以做到在初始化的时候，就可以将所有注册的要初始化的函数都执行初始化，下面再看看销毁的时候调用过程
<span class="token comment" spellcheck="true">/**
 * 当 so 销毁的时候，会回调这个函数，可以用来执行销毁的操作
 */</span>
extern <span class="token string">"C"</span> JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">JNI_OnUnload</span><span class="token punctuation">(</span>JavaVM <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sqlitelint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">LOGE</span><span class="token punctuation">(</span> <span class="token string">"Finalize GetEnv null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//相应的 将  g_loaders 集合 中的 成员中 init 为false 的，执行对应的函数指针，也即是销毁的操作</span>
    vector<span class="token operator">&lt;</span>JNIModule<span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator e <span class="token operator">=</span> g_loaders<span class="token operator">-</span><span class="token operator">></span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>JNIModule<span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> g_loaders<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> e<span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>it<span class="token operator">-</span><span class="token operator">></span>init<span class="token punctuation">)</span>
           <span class="token punctuation">{</span>
               sqlitelint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"Finalize module '%s'..."</span><span class="token punctuation">,</span> it<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
               it<span class="token operator">-</span><span class="token operator">></span><span class="token function">func</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
可以看到这里的调用过程跟JNI_Onload类似，唯一不同的就是 当满足了 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>it<span class="token operator">-</span><span class="token operator">></span>init<span class="token punctuation">)</span>的时候才会调用 it<span class="token operator">-</span><span class="token operator">></span><span class="token function">func</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span> 达到销毁的目的，至于为什么要这样写，估计这样写可以将对应模块的初始化
以及销毁的操作交给对应的模块来处理，就不会出现将所有的初始化，销毁操作都写在一个函数里面<span class="token punctuation">,</span>比如我们刚刚看的是sqlite3_profile_hook<span class="token punctuation">.</span>cc文件，其实这个文件的内容是没有作用的，以为我们并不是
采用hook的方式，在com_tencent_sqlitelint_SqliteLint<span class="token punctuation">.</span>cc 中也有对应的MODULE_INIT<span class="token punctuation">,</span>MODULE_FINI
<span class="token function">MODULE_INIT</span><span class="token punctuation">(</span>sqliteLint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kJvm <span class="token operator">=</span> vm<span class="token punctuation">;</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>env <span class="token operator">!=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//找到 SQLiteLintNativeBridge 类</span>
        jclass tmp_java_bridge_class <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"com/tencent/sqlitelint/SQLiteLintNativeBridge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp_java_bridge_class <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"MODULE_INIT tmpJavaBridgeClass is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//变成全局变量</span>
        kJavaBridgeClass <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>jclass<span class="token operator">></span><span class="token punctuation">(</span>env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>tmp_java_bridge_class<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>    
在初始化的时候，找到java对应的类，和方法，属性等字段
<span class="token function">MODULE_FINI</span><span class="token punctuation">(</span>sqliteLint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kExecSqlObj<span class="token punctuation">)</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>kExecSqlObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kIssueClass<span class="token punctuation">)</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteGlobalRef</span><span class="token punctuation">(</span>kIssueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kJavaBridgeClass<span class="token punctuation">)</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteGlobalRef</span><span class="token punctuation">(</span>kJavaBridgeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
在销毁的释放，这些字段，在 com_tencent_sqlitelint_util_SLog<span class="token punctuation">.</span>cc 中也有对应的MODULE_INIT，MODULE_FINI的使用，这个文件是Android日志文件，这里做了一层的中转输出，这里就不看了
这样JNI_OnLoad函数执行完毕，继续回调java层<span class="token punctuation">,</span>在 TestSQLiteLintActivity 中有这样的使用

Plugin plugin <span class="token operator">=</span> Matrix<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPluginByClass</span><span class="token punctuation">(</span>SQLiteLintPlugin<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plugin<span class="token punctuation">.</span><span class="token function">isPluginStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"plugin-sqlite-lint start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     plugin<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLiteLintPlugin</span> <span class="token keyword">extends</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//设置报告的回调函数</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">setReportDelegate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IssueReportBehaviour<span class="token punctuation">.</span>IReportDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">report</span><span class="token punctuation">(</span>SQLiteLintIssue issue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>issue <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">//提交报告</span>
                <span class="token function">reportMatrixIssue</span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addConcernedDB</span><span class="token punctuation">(</span>SQLiteLintConfig<span class="token punctuation">.</span>ConcernDb concernDb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPluginStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"addConcernedDB isPluginStarted not"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>concernDb <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        mConfig<span class="token punctuation">.</span><span class="token function">addConcernDB</span><span class="token punctuation">(</span>concernDb<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//获取到当前要安装的数据库的路径</span>
        String concernedDbPath <span class="token operator">=</span> concernDb<span class="token punctuation">.</span><span class="token function">getInstallEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConcernedDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//执行安装的操作</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getInstallEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//设置白名单</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">setWhiteList</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getWhiteListXmlResId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//设置允许检查的内容</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">enableCheckers</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getEnableCheckerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

接着看看测试点击按钮执行的逻辑
    <span class="token comment" spellcheck="true">/**
     * 开始数据库的创建测试
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startDBCreateTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        plugin<span class="token punctuation">.</span><span class="token function">addConcernedDB</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SQLiteLintConfig<span class="token punctuation">.</span>ConcernDb</span><span class="token punctuation">(</span>TestDBHelper<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWritableDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enableAllCheckers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

首先调用<span class="token function">TestDBHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWritableDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestDBHelper</span> <span class="token keyword">extends</span> <span class="token class-name">SQLiteOpenHelper</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">//单例模式</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> TestDBHelper <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHelper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>TestDBHelper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mHelper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestDBHelper</span><span class="token punctuation">(</span>MatrixApplication<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mHelper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">TestDBHelper</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> DB_NAME<span class="token punctuation">,</span> null<span class="token punctuation">,</span> DB_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>SQLiteDatabase sqLiteDatabase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//创建表 testTable</span>
        String sql <span class="token operator">=</span> <span class="token string">"create table if not exists "</span> <span class="token operator">+</span> TABLE_NAME <span class="token operator">+</span> <span class="token string">" (Id integer primary key, name text, age integer)"</span><span class="token punctuation">;</span>
        sqLiteDatabase<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUpgrade</span><span class="token punctuation">(</span>SQLiteDatabase sqLiteDatabase<span class="token punctuation">,</span> <span class="token keyword">int</span> oldVersion<span class="token punctuation">,</span> <span class="token keyword">int</span> newVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//升级的化，就直接删除表</span>
        String sql <span class="token operator">=</span> <span class="token string">"DROP TABLE IF EXISTS "</span> <span class="token operator">+</span> TABLE_NAME<span class="token punctuation">;</span>
        sqLiteDatabase<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String sql2 <span class="token operator">=</span> <span class="token string">"DROP TABLE IF EXISTS "</span> <span class="token operator">+</span> TABLE_NAME_AUTO_INCREMENT<span class="token punctuation">;</span>
        sqLiteDatabase<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sql2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String sql3 <span class="token operator">=</span> <span class="token string">"DROP TABLE IF EXISTS "</span> <span class="token operator">+</span> TABLE_NAME_WITHOUT_ROWID_BETTER<span class="token punctuation">;</span>
        sqLiteDatabase<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sql3<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//表删除之后，重新的执行创建的过程</span>
        <span class="token function">onCreate</span><span class="token punctuation">(</span>sqLiteDatabase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
所以这边创建了一个TestDBHelper，本质是SQLiteOpenHelper<span class="token punctuation">,</span>在onCreate的时候执行了创建表的操作，在升级的时候，删除表，又直接的创建数据库
接着执行 <span class="token keyword">new</span> <span class="token class-name">SQLiteLintConfig<span class="token punctuation">.</span>ConcernDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>接着调用 <span class="token function">enableAllCheckers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数，下面看看这个函数的定义

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ConcernDb</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//用于检测 索引的问题</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String EXPLAIN_QUERY_PLAN_CHECKER_NAME        <span class="token operator">=</span> <span class="token string">"ExplainQueryPlanChecker"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//用于检测 Select * 的问题</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String AVOID_SELECT_ALL_CHECKER_NAME          <span class="token operator">=</span> <span class="token string">"AvoidSelectAllChecker"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//用于检测 WithoutRow 的问题</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String WITHOUT_ROWID_BETTER_CHECKER_NAME      <span class="token operator">=</span> <span class="token string">"WithoutRowIdBetterChecker"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//用于检测 AutoIncrement 的问题</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String AVOID_AUTO_INCREMENT_CHECKER_NAME      <span class="token operator">=</span> <span class="token string">"AvoidAutoIncrementChecker"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//用于检测 PreparedStatement 的问题</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PREPARED_STATEMENT_BETTER_CHECKER_NAME <span class="token operator">=</span> <span class="token string">"PreparedStatementBetterChecker"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//用于检测 冗余索引的问题</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String REDUNDANT_INDEX_CHECKER_NAME           <span class="token operator">=</span> <span class="token string">"RedundantIndexChecker"</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//数据库检查的安装环境</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> SQLiteLint<span class="token punctuation">.</span>InstallEnv mInstallEnv<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//数据库检查的 配置</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> SQLiteLint<span class="token punctuation">.</span>Options    mOptions<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//数据库检测的白名单</span>
        <span class="token keyword">private</span>       <span class="token keyword">int</span>                   mWhiteListXmlResId<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//当前允许数据库检测的 内容</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> mEnableCheckerList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">ConcernDb</span><span class="token punctuation">(</span>SQLiteLint<span class="token punctuation">.</span>InstallEnv installEnv<span class="token punctuation">,</span> SQLiteLint<span class="token punctuation">.</span>Options options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mInstallEnv <span class="token operator">=</span> installEnv<span class="token punctuation">;</span>
            mOptions <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//ConcernDb 构造函数 传递一个可写的数据库进来</span>
        <span class="token keyword">public</span> <span class="token function">ConcernDb</span><span class="token punctuation">(</span>SQLiteDatabase db<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> db <span class="token operator">!=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//构建一个 InstallEnv 的对象</span>
            mInstallEnv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteLint<span class="token punctuation">.</span>InstallEnv</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleSQLiteExecutionDelegate</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOptions <span class="token operator">=</span> SQLiteLint<span class="token punctuation">.</span>Options<span class="token punctuation">.</span>LAX<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * 设置数据库检测的白名单
         */</span>
        <span class="token keyword">public</span> ConcernDb <span class="token function">setWhiteListXml</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> xmlResId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mWhiteListXmlResId <span class="token operator">=</span> xmlResId<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> SQLiteLint<span class="token punctuation">.</span>InstallEnv <span class="token function">getInstallEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mInstallEnv<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> SQLiteLint<span class="token punctuation">.</span>Options <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mOptions<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//获取到数据库检测的白名单</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getWhiteListXmlResId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mWhiteListXmlResId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * 执行check的检查,这里是检查所有的情况
         * @return
         */</span>
        <span class="token keyword">public</span> ConcernDb <span class="token function">enableAllCheckers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">enableExplainQueryPlanChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enableAvoidSelectAllChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enableWithoutRowIdBetterChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enableAvoidAutoIncrementChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enablePreparedStatementBetterChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">enableRedundantIndexChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>


首先在构造函数 中 执行 mInstallEnv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteLint<span class="token punctuation">.</span>InstallEnv</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleSQLiteExecutionDelegate</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
首先将 传递过来的数据库db 传递到了  SimpleSQLiteExecutionDelegate<span class="token punctuation">,</span>这个类是更像是一个代理的实现，用来真正的执行数据库的操作，这个会由JNI层来触发
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SimpleSQLiteExecutionDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">ISQLiteExecutionDelegate</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"SQLiteLint.SimpleSQLiteExecutionDelegate"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> SQLiteDatabase mDb<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SimpleSQLiteExecutionDelegate</span><span class="token punctuation">(</span>SQLiteDatabase db<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span>  db <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        mDb <span class="token operator">=</span> db<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 执行查询的操作
     * @param selection
     * @param selectionArgs
     * @return
     * @throws SQLException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Cursor <span class="token function">rawQuery</span><span class="token punctuation">(</span>String selection<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> selectionArgs<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mDb<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"rawQuery db close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//最终调用了 SQLiteDatabase rawQuery 来执行查询</span>
        <span class="token keyword">return</span> mDb<span class="token punctuation">.</span><span class="token function">rawQuery</span><span class="token punctuation">(</span>selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execSQL</span><span class="token punctuation">(</span>String sql<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mDb<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"rawQuery db close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mDb<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


接着构建一个InstallEnv 对象，保存了传递过来的内容
 <span class="token comment" spellcheck="true">/**
     * A data struct of some variables which guide the installation and make SQLiteLint work.
     * 一些变量的数据结构，指导安装并使SQLiteLint工作。
     * Used in {@link #install(Context, InstallEnv, Options)}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InstallEnv</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//要检查的数据库的路径</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> String mConcernedDbPath<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//数据库执行的委托</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> ISQLiteExecutionDelegate mSQLiteExecutionDelegate<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * @param concernedDbPath the path of the database which will be observed and checked
         * @param executionDelegate SQLiteLint will do some sql execution use SQLite, but SQLiteLint will delegate the execution.
         *                          A simple delegate like {@link SimpleSQLiteExecutionDelegate}
         */</span>
        <span class="token keyword">public</span> <span class="token function">InstallEnv</span><span class="token punctuation">(</span>String concernedDbPath<span class="token punctuation">,</span> ISQLiteExecutionDelegate executionDelegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> concernedDbPath <span class="token operator">!=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">assert</span> executionDelegate <span class="token operator">!=</span> null<span class="token punctuation">;</span>

            mConcernedDbPath <span class="token operator">=</span> concernedDbPath<span class="token punctuation">;</span>
            mSQLiteExecutionDelegate <span class="token operator">=</span> executionDelegate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    接着调用 <span class="token function">enableAllCheckers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数，回到前面ConcernDb类的定义，其实这里既是配置要检测的内容，比如ExplainQueryPlanChecker 代表检查索引<span class="token punctuation">,</span>AvoidSelectAllChecker代表检查selec<span class="token operator">*</span>
    所以配置检查所有的内容<span class="token punctuation">,</span>最终要检查的内容 都是添加到了 mEnableCheckerList 字符串的集合中，后面要传递给JNI层告知当前要检查的种类，接着调用addConcernedDB函数

    <span class="token comment" spellcheck="true">/**
    * 添加concernDb
    * @param concernDb
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addConcernedDB</span><span class="token punctuation">(</span>SQLiteLintConfig<span class="token punctuation">.</span>ConcernDb concernDb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPluginStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"addConcernedDB isPluginStarted not"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>concernDb <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        mConfig<span class="token punctuation">.</span><span class="token function">addConcernDB</span><span class="token punctuation">(</span>concernDb<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//获取到当前要安装的数据库的路径</span>
        String concernedDbPath <span class="token operator">=</span> concernDb<span class="token punctuation">.</span><span class="token function">getInstallEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConcernedDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//执行安装的操作</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getInstallEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//设置白名单</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">setWhiteList</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getWhiteListXmlResId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//设置允许检查的内容</span>
        SQLiteLint<span class="token punctuation">.</span><span class="token function">enableCheckers</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getEnableCheckerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    之后执行   SQLiteLint<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getInstallEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">install</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> InstallEnv installEnv<span class="token punctuation">,</span> Options options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        options <span class="token operator">=</span> <span class="token punctuation">(</span>options <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> Options<span class="token punctuation">.</span>LAX <span class="token operator">:</span> options<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//执行安装的操作</span>
        SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installEnv<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">enum</span> SQLiteLintAndroidCoreManager <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//单例 ，使用枚举创建单例</span>
    INSTANCE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"SQLiteLint.SQLiteLintAndroidCoreManager"</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * key: the concerned db path   要检测的数据库的路径
     * value: a SQLiteLintAndroidCore to check this db
     */</span>
    <span class="token keyword">private</span> ConcurrentHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> SQLiteLintAndroidCore<span class="token operator">></span> mCoresMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 执行安装的操作
     * @param context
     * @param installEnv
     * @param options
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">install</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> SQLiteLint<span class="token punctuation">.</span>InstallEnv installEnv<span class="token punctuation">,</span> SQLiteLint<span class="token punctuation">.</span>Options options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取到当前要检查的数据库的路径</span>
        String concernedDbPath <span class="token operator">=</span> installEnv<span class="token punctuation">.</span><span class="token function">getConcernedDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//如果已经存在集合中，忽略</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCoresMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"install twice!! ignore"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//构建一个 SQLiteLintAndroidCore 对象，然后添加到集合 mCoresMap 中</span>
        SQLiteLintAndroidCore core <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteLintAndroidCore</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installEnv<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCoresMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> core<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
可以看出这是一个使用枚举的单例写法，接着会构建一个 SQLiteLintAndroidCore 对象
<span class="token function">SQLiteLintAndroidCore</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> SQLiteLint<span class="token punctuation">.</span>InstallEnv installEnv<span class="token punctuation">,</span> SQLiteLint<span class="token punctuation">.</span>Options options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//初始化 ,创建SqliteOpenHelper</span>
        SQLiteLintDbHelper<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//获取到当前要检测的数据库的路径</span>
        mConcernedDbPath <span class="token operator">=</span> installEnv<span class="token punctuation">.</span><span class="token function">getConcernedDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到数据库执行的委托对象</span>
        mSQLiteExecutionDelegate <span class="token operator">=</span> installEnv<span class="token punctuation">.</span><span class="token function">getSQLiteExecutionDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//如果当前的数据库的检测模式为 Hook</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SQLiteLint<span class="token punctuation">.</span><span class="token function">getSqlExecutionCallbackMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> SQLiteLint<span class="token punctuation">.</span>SqlExecutionCallbackMode<span class="token punctuation">.</span>HOOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//执行hook操作</span>
            SQLite3ProfileHooker<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//native 层的安装</span>
        SQLiteLintNativeBridge<span class="token punctuation">.</span><span class="token function">nativeInstall</span><span class="token punctuation">(</span>mConcernedDbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">//构建一个 mBehaviors 集合 ，添加一个 PersistenceBehaviour 成员</span>
        mBehaviors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*PersistenceBehaviour is a default pre-behaviour */</span>
        mBehaviors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersistenceBehaviour</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//默认为 BEHAVIOUR_ALERT ，再往  mBehaviors 中添加一个 IssueAlertBehaviour 对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">isAlertBehaviourEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mBehaviors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IssueAlertBehaviour</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> mConcernedDbPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">isReportBehaviourEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mBehaviors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IssueReportBehaviour</span><span class="token punctuation">(</span>SQLiteLint<span class="token punctuation">.</span>sReportDelegate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
首先调用  SQLiteLintDbHelper<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> SQLiteLintDbHelper <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//使用枚举 构建单例</span>
    INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment" spellcheck="true">//单例 ,是一个  SQLiteOpenHelper 对象</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> InternalDbHelper mHelper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> SQLiteDatabase <span class="token function">getDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHelper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"getIssueStorage db not ready"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> mHelper<span class="token punctuation">.</span><span class="token function">getWritableDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHelper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mHelper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalDbHelper</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InternalDbHelper</span> <span class="token keyword">extends</span> <span class="token class-name">SQLiteOpenHelper</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//要打开的数据库名, SQLiteLintInternal.db 是一个用来保存Issure 的数据库</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String DB_NAME <span class="token operator">=</span> <span class="token string">"SQLiteLintInternal.db"</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> VERSION_1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token function">InternalDbHelper</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> DB_NAME<span class="token punctuation">,</span> null<span class="token punctuation">,</span> VERSION_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>SQLiteDatabase db<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCreate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//执行创建数据库</span>
            db<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>IssueStorage<span class="token punctuation">.</span>DB_VERSION_1_CREATE_SQL<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//创建索引</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> IssueStorage<span class="token punctuation">.</span>DB_VERSION_1_CREATE_INDEX<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                db<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>IssueStorage<span class="token punctuation">.</span>DB_VERSION_1_CREATE_INDEX<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUpgrade</span><span class="token punctuation">(</span>SQLiteDatabase db<span class="token punctuation">,</span> <span class="token keyword">int</span> oldVersion<span class="token punctuation">,</span> <span class="token keyword">int</span> newVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
可以看出这也是一个单例，其实这个是内部的数据库，用来存储分析的结果，也即是当分析到了结果，会先经过这个数据库进行保存，继续往下面执行由于我们当前的模式不为hook方式，所以不会执行
SQLite3ProfileHooker<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>接着就会执行到 SQLiteLintNativeBridge<span class="token punctuation">.</span><span class="token function">nativeInstall</span><span class="token punctuation">(</span>mConcernedDbPath<span class="token punctuation">)</span><span class="token punctuation">;</span> 这是一个<span class="token keyword">native</span> 方法，对应的jni方法的实现为
    <span class="token comment" spellcheck="true">/**
     * 执行native层的安装操作
     * @param env
     * @param name
     */</span>
    <span class="token keyword">void</span> <span class="token function">Java_com_tencent_sqlitelint_SQLiteLintNativeBridge_nativeInstall</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//当前要检测的 数据库的路径</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>filename <span class="token operator">=</span> <span class="token function">jstringToChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//安装 SQLiteLint ,OnIssuePublish 为函数指针，用于进一步的将结果传回java层</span>
        <span class="token function">InstallSQLiteLint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> OnIssuePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//释放操作</span>
        <span class="token function">free</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//传递SQL 执行的函数指针</span>
        <span class="token function">SetSqlExecutionDelegate</span><span class="token punctuation">(</span>SqliteLintExecSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    执行 <span class="token function">InstallSQLiteLint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> OnIssuePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//执行安装的操作 ,issue_callback 为 传递结果的函数指针</span>
    <span class="token keyword">void</span> <span class="token function">InstallSQLiteLint</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> db_path<span class="token punctuation">,</span> OnPublishIssueCallback issue_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">Install</span><span class="token punctuation">(</span>db_path<span class="token punctuation">,</span> issue_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里LintManager其实为一个单例
    <span class="token comment" spellcheck="true">// A singleton and it manage the lint</span>
    <span class="token keyword">class</span> <span class="token class-name">LintManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token operator">:</span>
        <span class="token keyword">static</span> LintManager<span class="token operator">*</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment" spellcheck="true">//单例模式，构造函数为 私有</span>
        <span class="token function">LintManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">LintManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//单例模式</span>
        <span class="token keyword">static</span> LintManager <span class="token operator">*</span>instance_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//获取到 LintManager 对象，如果是第一次调用，执行创建</span>
    LintManager<span class="token operator">*</span> LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance_<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//加锁操作</span>
            std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>lints_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance_<span class="token punctuation">)</span><span class="token punctuation">{</span>
                instance_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LintManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//解锁 操作</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    当第一次调用的时候就会创建一个LintManager 对象，之后都不会进行创建了<span class="token punctuation">,</span>接着调用 Install函数
    <span class="token comment" spellcheck="true">/**
     * 执行安装的操作
     * @param db_path
     * @param issued_callback
     */</span>
    <span class="token keyword">void</span> LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Install</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> db_path<span class="token punctuation">,</span> OnPublishIssueCallback issued_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sInfo</span><span class="token punctuation">(</span><span class="token string">"LintManager::Install dbPath:%s"</span><span class="token punctuation">,</span> db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//加锁</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>lints_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果 lints_ 集合中 以及存在 db_path ，直接返回</span>
        std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> Lint<span class="token operator">*</span><span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> lints_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> lints_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//已经在 集合中存在，解锁</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sWarn</span><span class="token punctuation">(</span><span class="token string">"Install already installed; dbPath: %s"</span><span class="token punctuation">,</span> db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//如果到了这里说明不存在,构建一个</span>
        Lint<span class="token operator">*</span> lint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lint</span><span class="token punctuation">(</span>db_path<span class="token punctuation">,</span> issued_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lints_<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>pair<span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> Lint<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>db_path<span class="token punctuation">,</span> lint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//解锁</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    其中 lints_ 为 LintManager 中的一个集合<span class="token punctuation">,</span>用来存储当前已经添加的检测  定义为 
    std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> Lint<span class="token operator">*</span><span class="token operator">></span> lints_<span class="token punctuation">;</span>
    集合的key为当前要添加检测的数据库的路径，这里的逻辑就是先检测当前的数据库路径是否已经添加过，如果已经添加过，直接返回，假设没有，就构建一个Lint 对象，然后存储到集合中

    Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Lint</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> db_path<span class="token punctuation">,</span> OnPublishIssueCallback issued_callback<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">env_</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">checked_sql_cache_</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//env_(db_path) 会调用  LintEnv(path)的构造函数,构建这样的对象,checked_sql_cache_ 集合的大小为500</span>
            <span class="token punctuation">,</span> <span class="token function">issued_callback_</span><span class="token punctuation">(</span>issued_callback<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">exit_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//构建一个线程, 线程执行的时候会执行 Check 函数</span>
        check_thread_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Lint<span class="token operator">:</span><span class="token operator">:</span>Check<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里要注意在构建这个Lint 对象的时候传递的OnPublishIssueCallback 为函数指针，这个函数指针是用来中转结果的，跟上一篇的检测Io一样，将结果做一个中转，最后转到java层
    这里的env_ 为 Lint 的一个成员变量  LintEnv env_<span class="token punctuation">;</span>，这里执行 <span class="token function">env_</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span>就会调用对应的构造函数<span class="token punctuation">,</span>LintEnv 这个对象用来代表这个数据库检测的环境

    <span class="token comment" spellcheck="true">// LintEnv 构造函数的执行</span>
    LintEnv<span class="token operator">:</span><span class="token operator">:</span><span class="token function">LintEnv</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>string db_path<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">db_path_</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">checked_sql_cnt_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> db_path<span class="token punctuation">.</span><span class="token function">find_last_of</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            db_file_name_ <span class="token operator">=</span> db_path<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>pos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            db_file_name_ <span class="token operator">=</span> db_path<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    同时将 issued_callback 保存到 成员变量issued_callback_中，用于后面检测结果的中转，同时参加了一个线程check_thread_<span class="token punctuation">,</span>线程执行的时候会执行<span class="token operator">&amp;</span>Lint<span class="token operator">:</span><span class="token operator">:</span>Check 函数
    <span class="token comment" spellcheck="true">/**
     * 在 check_thread_ 线程中 执行
     */</span>
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//这边又构建一个  init_check_thread_ 的线程，线程执行的时候，会执行  InitCheck 函数</span>
        init_check_thread_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Lint<span class="token operator">:</span><span class="token operator">:</span>InitCheck<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//用来存储要分发结果的集合</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token operator">*</span> published_issues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token punctuation">;</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>SqlInfo<span class="token operator">></span> sql_info<span class="token punctuation">;</span>
        SqlInfo simple_sql_info<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//这下面一般是检查是否有结果，有就分发出去之类的</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment" spellcheck="true">//从queue 结果队列中 获取到内容，如果 队列中有元素，取出对头的元素，然后辅助给 sql_info ，如果没有元素，则会阻塞在这里</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">TakeSqlInfo</span><span class="token punctuation">(</span>sql_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"check exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    可以看到当这个子线程执行的时候，又会创建另一个子线程 init_check_thread_ ，函数指针为Lint<span class="token operator">:</span><span class="token operator">:</span>InitCheck，这里先不去看这个函数的实现<span class="token punctuation">,</span>继续回到nativeInstall 函数
     <span class="token keyword">void</span> <span class="token function">Java_com_tencent_sqlitelint_SQLiteLintNativeBridge_nativeInstall</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//当前要检测的 数据库的路径</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>filename <span class="token operator">=</span> <span class="token function">jstringToChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//安装 SQLiteLint ,OnIssuePublish 为函数指针，用于进一步的将结果传回java层</span>
        <span class="token function">InstallSQLiteLint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> OnIssuePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//释放操作</span>
        <span class="token function">free</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//传递SQL 执行的函数指针</span>
        <span class="token function">SetSqlExecutionDelegate</span><span class="token punctuation">(</span>SqliteLintExecSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//传递全局的SQL 执行的函数指针</span>
    <span class="token keyword">void</span> <span class="token function">SetSqlExecutionDelegate</span><span class="token punctuation">(</span>SqlExecutionDelegate func<span class="token punctuation">)</span><span class="token punctuation">{</span>
        kSqlExecutionDelegate <span class="token operator">=</span> func<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里的SqliteLintExecSql 也为函数指针，也是一个中转函数的，这个函数主要完成的操作当JNI层要操作数据库的时候，会通过这个函数，中转到Java层，其实真正的查询有java来操作
    继续回到 java层的 <span class="token function">addConcernedDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数，继续往下面执行
    <span class="token comment" spellcheck="true">//设置白名单</span>
    SQLiteLint<span class="token punctuation">.</span><span class="token function">setWhiteList</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getWhiteListXmlResId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setWhiteList</span><span class="token punctuation">(</span>String concernedDbPath<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> xmlResId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果 INSTANCE 中 存在 concernedDbPath 路径 对应的 SQLiteLintAndroidCore 对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//设置白名单</span>
        SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setWhiteList</span><span class="token punctuation">(</span>xmlResId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 增加白名单
     * @param xmlResId
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWhiteList</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> xmlResId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CheckerWhiteListLogic<span class="token punctuation">.</span><span class="token function">setWhiteList</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> mConcernedDbPath<span class="token punctuation">,</span> xmlResId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setWhiteList</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> <span class="token keyword">final</span> String concernedDbPath<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> xmlResId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token comment" spellcheck="true">//将解析完白名单之后的结果传递到native 层</span>
       <span class="token function">addToNative</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> whiteListMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里首先会先将xml 白名单使用xml解析器，解析出来，之后调用addToNative 告知白名单的设置
    <span class="token comment" spellcheck="true">/**
     * 将解析白名单之后的结果 传递到native层
     * @param concernedDbPath
     * @param whiteListMap
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addToNative</span><span class="token punctuation">(</span><span class="token keyword">final</span> String concernedDbPath<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">>></span> whiteListMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteListMap <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//将map 转成 数组的形式</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">//传递到native 层，设置当前检查数据库的白名单</span>
        SQLiteLintNativeBridge<span class="token punctuation">.</span><span class="token function">nativeAddToWhiteList</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> checkerArr<span class="token punctuation">,</span> whiteListArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">Java_com_tencent_sqlitelint_SQLiteLintNativeBridge_nativeAddToWhiteList</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring db_path<span class="token punctuation">,</span> jobjectArray check_name_arr<span class="token punctuation">,</span> jobjectArray white_list_arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//解析完之后，传递白名单的结果</span>
        <span class="token function">SetWhiteList</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">,</span> whiteList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">SetWhiteList</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> db_path<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>set<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">>></span><span class="token operator">&amp;</span> white_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">SetWhiteList</span><span class="token punctuation">(</span>db_path<span class="token punctuation">,</span> white_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">SetWhiteList</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>db_path<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>set<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">>></span> <span class="token operator">&amp;</span>white_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//加锁</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>lints_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//遍历是否能从 lints_ 集合中找到 db_path 对应的 Lint 对象</span>
        std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> Lint<span class="token operator">*</span><span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> lints_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//没有找到</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> lints_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sWarn</span><span class="token punctuation">(</span><span class="token string">"LintManager::SetWhiteList lint not installed; dbPath: %s"</span><span class="token punctuation">,</span> db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//找到了，设置白名单</span>
        it<span class="token operator">-</span><span class="token operator">></span>second<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetWhiteList</span><span class="token punctuation">(</span>white_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//解锁</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">SetWhiteList</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>set<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">>></span> <span class="token operator">&amp;</span>white_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        env_<span class="token punctuation">.</span><span class="token function">SetWhiteList</span><span class="token punctuation">(</span>white_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> LintEnv<span class="token operator">:</span><span class="token operator">:</span><span class="token function">SetWhiteList</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>set<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">>></span> <span class="token operator">&amp;</span>white_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        white_list_mgr_<span class="token punctuation">.</span><span class="token function">SetWhiteList</span><span class="token punctuation">(</span>white_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里white_list_mgr_ 为 LintEnv 中的一个成员变量 WhiteListMgr white_list_mgr_<span class="token punctuation">,</span>而 WhiteListMgr 中有一个成员变量 std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>set<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">>></span> white_list_<span class="token punctuation">;</span>
    专门用来存储白名单的内容，继续回到<span class="token function">addConcernedDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数<span class="token punctuation">,</span>执行
    SQLiteLint<span class="token punctuation">.</span><span class="token function">enableCheckers</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> concernDb<span class="token punctuation">.</span><span class="token function">getEnableCheckerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enableCheckers</span><span class="token punctuation">(</span>String concernedDbPath<span class="token punctuation">,</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> enableCheckerList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enableCheckers</span><span class="token punctuation">(</span>enableCheckerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enableCheckers</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> enableCheckers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//将list 结构 转成 数组的形式</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> enableCheckerArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>enableCheckers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> enableCheckers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            enableCheckerArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> enableCheckers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//将当前 要检测的内容 传递到 native 层</span>
        SQLiteLintNativeBridge<span class="token punctuation">.</span><span class="token function">nativeEnableCheckers</span><span class="token punctuation">(</span>mConcernedDbPath<span class="token punctuation">,</span> enableCheckerArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">Java_com_tencent_sqlitelint_SQLiteLintNativeBridge_nativeEnableCheckers</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring dbPathStr<span class="token punctuation">,</span> jobjectArray enableCheckerArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>dbPath <span class="token operator">=</span> <span class="token function">jstringToChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> dbPathStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        jint j_check_name_arr_count <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetArrayLength</span><span class="token punctuation">(</span>enableCheckerArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>jint i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j_check_name_arr_count <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jstring j_checker_name <span class="token operator">=</span> <span class="token punctuation">(</span>jstring<span class="token punctuation">)</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetObjectArrayElement</span><span class="token punctuation">(</span>enableCheckerArr<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>checkerName <span class="token operator">=</span> <span class="token function">jstringToChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_checker_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//告知当前dbPath 路径指定的数据库 检测的内容</span>
            <span class="token function">EnableChecker</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">,</span> checkerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>checkerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">free</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    就会通过<span class="token function">EnableChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>设置当前 数据库 dbPath 对应的检测内容
    <span class="token keyword">void</span> <span class="token function">EnableChecker</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> db_path<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">EnableChecker</span><span class="token punctuation">(</span>db_path<span class="token punctuation">,</span> checker_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">EnableChecker</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>db_path<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string <span class="token operator">&amp;</span>checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>lints_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//遍历是否能从 lints_ 集合中找到 db_path 对应的 Lint 对象</span>
        std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> Lint<span class="token operator">*</span><span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> lints_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//没有找到</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> lints_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sWarn</span><span class="token punctuation">(</span><span class="token string">"LintManager::EnableChecker lint not installed; dbPath: %s"</span><span class="token punctuation">,</span> db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//找到了，注册检测的内容</span>
        it<span class="token operator">-</span><span class="token operator">></span>second<span class="token operator">-</span><span class="token operator">></span><span class="token function">RegisterChecker</span><span class="token punctuation">(</span>checker_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里就会根据传递过来的字符串匹配，从而注册对应的检测对象
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">RegisterChecker</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string <span class="token operator">&amp;</span>checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sDebug</span><span class="token punctuation">(</span><span class="token string">"Lint::RegisterChecker check_name: %s"</span><span class="token punctuation">,</span> checker_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>CheckerName<span class="token operator">:</span><span class="token operator">:</span>kExplainQueryPlanCheckerName <span class="token operator">==</span> checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 索引检查</span>
            <span class="token function">RegisterChecker</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExplainQueryPlanChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CheckerName<span class="token operator">:</span><span class="token operator">:</span>kRedundantIndexCheckerName <span class="token operator">==</span> checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//冗余检查</span>
            <span class="token function">RegisterChecker</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedundantIndexChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CheckerName<span class="token operator">:</span><span class="token operator">:</span>kAvoidAutoIncrementCheckerName <span class="token operator">==</span> checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//AutoIncrement 检查</span>
            <span class="token function">RegisterChecker</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AvoidAutoIncrementChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CheckerName<span class="token operator">:</span><span class="token operator">:</span>kAvoidSelectAllCheckerName <span class="token operator">==</span> checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//select * 检查</span>
            <span class="token function">RegisterChecker</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AvoidSelectAllChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CheckerName<span class="token operator">:</span><span class="token operator">:</span>kWithoutRowIdBetterCheckerName <span class="token operator">==</span> checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//without rowId 检查</span>
            <span class="token function">RegisterChecker</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WithoutRowIdBetterChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CheckerName<span class="token operator">:</span><span class="token operator">:</span>kPreparedStatementBetterCheckerName <span class="token operator">==</span> checker_name<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//preparedStatement 检查</span>
            <span class="token function">RegisterChecker</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PreparedStatementBetterChecker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">RegisterChecker</span><span class="token punctuation">(</span>Checker<span class="token operator">*</span> checker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>CheckScene<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Checker<span class="token operator">*</span><span class="token operator">>></span><span class="token operator">:</span><span class="token operator">:</span>iterator iter <span class="token operator">=</span> checkers_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>checker<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCheckScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据 checker 分类,如果找到了，就直接添加</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iter <span class="token operator">!=</span> checkers_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iter<span class="token operator">-</span><span class="token operator">></span>second<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>checker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//如果没有找到，构建一个数组，再添加到总的  checkers_ 数组中</span>
            std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Checker<span class="token operator">*</span><span class="token operator">></span> v<span class="token punctuation">;</span>
            v<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>checker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            checkers_<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>pair<span class="token operator">&lt;</span>CheckScene<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Checker<span class="token operator">*</span><span class="token operator">>></span><span class="token punctuation">(</span>checker<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetCheckScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    其中 checkers_ 为 Lint 的一个成员变量，定义为  std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>CheckScene<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Checker<span class="token operator">*</span><span class="token operator">>></span> checkers_<span class="token punctuation">;</span> 用来存储要检测的内容，已经检测对应的类，
    这样java对应的初始化已经执行完毕
</code></pre>
<p>线程的执行</p>
<pre class=" language-java"><code class="language-java">我们知道在构建当前数据库路径对应的Lint对象的时候，创建了俩个线程，其中一个线程的run方法
 <span class="token comment" spellcheck="true">/**
     * 在 check_thread_ 线程中 执行
     */</span>
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//这边又构建一个  init_check_thread_ 的线程，线程执行的时候，会执行  InitCheck 函数</span>
        init_check_thread_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Lint<span class="token operator">:</span><span class="token operator">:</span>InitCheck<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//用来存储要分发结果的集合</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token operator">*</span> published_issues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token punctuation">;</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>SqlInfo<span class="token operator">></span> sql_info<span class="token punctuation">;</span>
        SqlInfo simple_sql_info<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//这下面一般是检查是否有结果，有就分发出去之类的</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment" spellcheck="true">//从queue 结果队列中 获取到内容，如果 队列中有元素，取出对头的元素，然后辅助给 sql_info ，如果没有元素，则会阻塞在这里</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">TakeSqlInfo</span><span class="token punctuation">(</span>sql_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"check exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//取出了队列中的头部的元素,下面是执行分发</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//虽然用了双端队列，还是得确认线程安全影响大不大</span>
    <span class="token keyword">int</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">TakeSqlInfo</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>SqlInfo<span class="token operator">></span> <span class="token operator">&amp;</span>sql_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//加锁</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//如果当前为推出的状态，返回-1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exit_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//如果队里为空，利用 queue_cv_ 将线程阻塞</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>queue_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sInfo</span><span class="token punctuation">(</span><span class="token string">"Lint::TakeSqlInfo queue empty and wait"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queue_cv_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exit_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//如果队列不为空，移除队头的元素,辅助给 sql_info</span>
        sql_info <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>queue_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queue_<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    所以这里在执行<span class="token function">TakeSqlInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>的时候，因为没有queue中没有内容，会导致阻塞，接下来我们再来分析另一个线程
    <span class="token comment" spellcheck="true">/**
     * init_check_thread_ 线程启动的时候，执行
     */</span>
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">InitCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sVerbose</span><span class="token punctuation">(</span><span class="token string">"Lint::Check() init check"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//休眠4秒</span>
        std<span class="token operator">:</span><span class="token operator">:</span>this_thread<span class="token operator">:</span><span class="token operator">:</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>chrono<span class="token operator">:</span><span class="token operator">:</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//构建一个集合用来收集结果</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token operator">*</span> published_issues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//安排检查， 类型为 kAfterInit 的有 AvoidAutoIncrementChecker  , WithoutRowIdBetterChecker  ,RedundantIndexChecker</span>
        <span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span>CheckScene<span class="token operator">:</span><span class="token operator">:</span>kAfterInit<span class="token punctuation">,</span> <span class="token function">SqlInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//如果published_issues 结果 不为空，说明检查到了有不合格的内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>published_issues<span class="token operator">-</span><span class="token operator">></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sInfo</span><span class="token punctuation">(</span><span class="token string">"New check some diagnosis out!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>issued_callback_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//将结果传递回去</span>
                <span class="token function">issued_callback_</span><span class="token punctuation">(</span>env_<span class="token punctuation">.</span><span class="token function">GetDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        delete published_issues<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里会先调用  <span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span>CheckScene<span class="token operator">:</span><span class="token operator">:</span>kAfterInit<span class="token punctuation">,</span> <span class="token function">SqlInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span> 这里注意第一个参数为CheckScene<span class="token operator">:</span><span class="token operator">:</span>kAfterInit，这个标识是否为初始化的时候就可以检测，
    对于索引的检测，AutoCrenemt等的检测，可以在初始化的时候就检测，这个时机点在检测的每一个类中都有指定，比如
     CheckScene AvoidAutoIncrementChecker<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetCheckScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> CheckScene<span class="token operator">:</span><span class="token operator">:</span>kAfterInit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/**
     * 当前的检查方式为抽样检查
     * @return
     */</span>
    CheckScene PreparedStatementBetterChecker<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetCheckScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> CheckScene<span class="token operator">:</span><span class="token operator">:</span>kSample<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    再次及时第三个参数为 published_issues 为一个集合用来存储检测的结果
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span><span class="token keyword">const</span> CheckScene check_scene<span class="token punctuation">,</span> <span class="token keyword">const</span> SqlInfo<span class="token operator">&amp;</span> sql_info<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span> <span class="token operator">*</span>published_issues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span>CheckScene<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Checker<span class="token operator">*</span><span class="token operator">>></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> checkers_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>check_scene<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> checkers_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 从 checkers_ 得到 满足  check_scene 集合</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Checker<span class="token operator">*</span><span class="token operator">></span> scene_checkers <span class="token operator">=</span> it<span class="token operator">-</span><span class="token operator">></span>second<span class="token punctuation">;</span>
        size_t scene_checkers_cnt <span class="token operator">=</span> scene_checkers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//遍历执行对应的 Check 函数</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> scene_checkers_cnt<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Checker<span class="token operator">*</span> checker <span class="token operator">=</span> scene_checkers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//当前比较的类型不能为 kSample的形势，也即是不为抽样检查</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>check_scene <span class="token operator">!=</span> CheckScene<span class="token operator">:</span><span class="token operator">:</span>kSample <span class="token operator">||</span> <span class="token punctuation">(</span>env_<span class="token punctuation">.</span><span class="token function">GetSqlCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> checker<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetSqlCntToSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                checker<span class="token operator">-</span><span class="token operator">></span><span class="token function">Check</span><span class="token punctuation">(</span>env_<span class="token punctuation">,</span> sql_info<span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    由于类型为 kAfterInit 的有 AvoidAutoIncrementChecker  <span class="token punctuation">,</span> WithoutRowIdBetterChecker  <span class="token punctuation">,</span>RedundantIndexChecker<span class="token punctuation">,</span>所以就会对应的执行 Check函数
</code></pre>
<p>AutoIncrement 检测</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> AvoidAutoIncrementChecker<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Check</span><span class="token punctuation">(</span>LintEnv <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> <span class="token keyword">const</span> SqlInfo <span class="token operator">&amp;</span>sql_info<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span> <span class="token operator">*</span>issues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取到当前数据库 中表的信息集合</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>TableInfo<span class="token operator">></span> tables <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">GetTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">sVerbose</span><span class="token punctuation">(</span><span class="token string">"AvoidAutoIncrementChecker::Check tables count: %d"</span><span class="token punctuation">,</span> tables<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">:</span><span class="token operator">:</span>string create_sql<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//遍历这些表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> TableInfo<span class="token operator">&amp;</span> table_info <span class="token operator">:</span> tables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//检查这个table 是否在白名单中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsInWhiteList</span><span class="token punctuation">(</span>kCheckerName<span class="token punctuation">,</span> table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sVerbose</span><span class="token punctuation">(</span><span class="token string">"AvoidAutoIncrementChecker::Check in white list: %s"</span><span class="token punctuation">,</span> table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//获取到当前创建的sql语句，在 select name, sql from sqlite_master where type='table' 中就能获取到全部表的创建信息</span>
            create_sql <span class="token operator">=</span> table_info<span class="token punctuation">.</span>create_sql_<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//转成小写</span>
            <span class="token function">ToLowerCase</span><span class="token punctuation">(</span>create_sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//从创建表的sql 语句中 查找是否有 autoincrement 关键字</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>create_sql<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>kAutoIncrementKeyWord<span class="token punctuation">)</span> <span class="token operator">!=</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">:</span><span class="token operator">:</span>npos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//如果找到了，发布一个结果</span>
                <span class="token function">PublishIssue</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">,</span> issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    既然是提前检测，那么肯定是根据当前数据库的创建表信息，属性等来检测，所以首先要获取到表的信息
    std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>TableInfo<span class="token operator">></span> tables <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">GetTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>TableInfo<span class="token operator">></span> LintEnv<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//加锁</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>lints_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果当前数据库 表信息为空，收集表信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tables_info_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">CollectTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tables_info_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    由于我们当前第一次访问，所以会执行<span class="token function">CollectTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 执行收集的操作
     <span class="token comment" spellcheck="true">/**
     * 收集当前数据库表的信息
     */</span>
    <span class="token keyword">void</span> LintEnv<span class="token operator">:</span><span class="token operator">:</span><span class="token function">CollectTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//用来接受错误的信息</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>err_msg <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//查询表的信息</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>kSelectTablesSql<span class="token punctuation">,</span> OnSelectTablesCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tables_info_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//处理查询的错误信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DealWithGetQuery</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> err_msg<span class="token punctuation">,</span> kSelectTablesSql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//用来标记查询数据库列的sql</span>
        std<span class="token operator">:</span><span class="token operator">:</span>string select_columns_sql<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//用来查询索引的sql</span>
        std<span class="token operator">:</span><span class="token operator">:</span>string select_index_sql<span class="token punctuation">;</span>
        std<span class="token operator">:</span><span class="token operator">:</span>string select_index_info_sql<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//遍历当前 tables_info_ 集合</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>TableInfo <span class="token operator">&amp;</span>table_info <span class="token operator">:</span> tables_info_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//查询数据库列的 sql语句</span>
            select_columns_sql <span class="token operator">=</span> <span class="token string">"PRAGMA table_info("</span> <span class="token operator">+</span> table_info<span class="token punctuation">.</span>table_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//执行查询操作,这里传递的参数 为 table_info，查询完之后填充这个表中列的信息</span>
            r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_columns_sql<span class="token punctuation">,</span> OnSelectColumnsCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//处理查询列错误的信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DealWithGetQuery</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> err_msg<span class="token punctuation">,</span> select_columns_sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//接下来查询表的 索引信息</span>
            select_index_sql <span class="token operator">=</span> <span class="token string">"PRAGMA index_list("</span> <span class="token operator">+</span> table_info<span class="token punctuation">.</span>table_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//这里的 接受处理的回调函数为 OnSelectIndexsCallback</span>
            r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_index_sql<span class="token punctuation">,</span> OnSelectIndexsCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//处理查询错误的信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DealWithGetQuery</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> err_msg<span class="token punctuation">,</span> select_index_sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//遍历当前表中的索引名称，判断是否为组合索引，如果是获取到组合索引中的元素，</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>IndexInfo <span class="token operator">&amp;</span>index_info <span class="token operator">:</span> table_info<span class="token punctuation">.</span>indexs_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                select_index_info_sql <span class="token operator">=</span> <span class="token string">"PRAGMA index_info("</span> <span class="token operator">+</span> index_info<span class="token punctuation">.</span>index_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
                r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_index_info_sql<span class="token punctuation">,</span> OnSelectIndexInfoCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//处理错误的信息</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DealWithGetQuery</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> err_msg<span class="token punctuation">,</span> select_index_info_sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    首先执行 <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>kSelectTablesSql<span class="token punctuation">,</span> OnSelectTablesCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tables_info_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>这里  kSelectTablesSql值为，这也即是要查询的内容
    <span class="token keyword">static</span> constexpr <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> kSelectTablesSql <span class="token operator">=</span> <span class="token string">"select name, sql from sqlite_master where type='table'"</span><span class="token punctuation">;</span>
    第二个参数OnSelectTablesCallback 为 执行了这个查询之后，进行调用的函数指针<span class="token punctuation">,</span>而tables_info_ 的定义为<span class="token punctuation">,</span>也即是用来填充查询之后表的内容
    <span class="token comment" spellcheck="true">//用来存储当前数据库 包含表信息的集合</span>
    std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>TableInfo<span class="token operator">></span> tables_info_<span class="token punctuation">;</span>
    <span class="token keyword">int</span> LintEnv<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetQuery</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string <span class="token operator">&amp;</span>query_sql<span class="token punctuation">,</span> <span class="token keyword">const</span> SqlExecutionCallback <span class="token operator">&amp;</span>callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>para<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>errMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//执行查询</span>
        <span class="token keyword">return</span> <span class="token function">SQLite3ExecSql</span><span class="token punctuation">(</span>db_path_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> query_sql<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> para<span class="token punctuation">,</span> errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> LintEnv<span class="token operator">:</span><span class="token operator">:</span><span class="token function">SQLite3ExecSql</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>db_path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> <span class="token keyword">const</span> SqlExecutionCallback <span class="token operator">&amp;</span>callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>para<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>errmsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果有设置全局sql 执行的代理，执行这个代理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kSqlExecutionDelegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">kSqlExecutionDelegate</span><span class="token punctuation">(</span>db_path<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> para<span class="token punctuation">,</span> errmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"LintEnv::SQLite3ExecSql kSqlExecutionDelegate not set!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    由于前面我们有设置kSqlExecutionDelegate 的值，这个值就是用来委托java层执行sql语句的函数指针
    <span class="token keyword">int</span> <span class="token function">SqliteLintExecSql</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file_name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> SqlExecutionCallback callback<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>para<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>err_msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//查询之后函数指针,这里将地址转为 整数 传递到java层</span>
        int64_t exec_sql_callback_ptr <span class="token operator">=</span> <span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span> callback<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//参数</span>
        int64_t para_ptr <span class="token operator">=</span> <span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span> para<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//获取到env</span>
        JNIEnv <span class="token operator">*</span>env <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        bool attached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        jint ret <span class="token operator">=</span> kJvm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> JNI_EDETACHED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jint ret <span class="token operator">=</span> kJvm<span class="token operator">-</span><span class="token operator">></span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">assert</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> JNI_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> ret<span class="token punctuation">;</span>
            attached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//调用 SQLiteLintNativeBridge 中的 sqliteLintExecSql 函数</span>
        jstring filename_str <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jstring sql_str <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobjectArray retArray <span class="token operator">=</span> <span class="token punctuation">(</span>jobjectArray<span class="token punctuation">)</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>kExecSqlObj<span class="token punctuation">,</span> kExecSqlMethodID<span class="token punctuation">,</span>filename_str<span class="token punctuation">,</span> sql_str<span class="token punctuation">,</span>
                                                                     callback <span class="token operator">?</span> JNI_TRUE <span class="token operator">:</span> JNI_FALSE<span class="token punctuation">,</span> exec_sql_callback_ptr<span class="token punctuation">,</span>para_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>filename_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>sql_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>retArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"sqliteLintExecSql retArray is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attached<span class="token punctuation">)</span> kJvm<span class="token operator">-</span><span class="token operator">></span><span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    可以看到这里将这些函数指针转成int64，然后通过调用java层SQLiteLintNativeBridge 的sqliteLintExecSql 函数来执行查询
    <span class="token comment" spellcheck="true">/**
     * JNI 层方法调用 ,native 没有办法查询数据库，只能通知java层来查询，查询完之后将结果传到native 层
     * @param dbPath
     * @param sql
     * @param needCallBack         是否需要回调
     * @param execSqlCallbackPtr   底层回调函数的地址
     * @param paraPtr              底层参数的地址
     * @return
     */</span>
    <span class="token keyword">private</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">sqliteLintExecSql</span><span class="token punctuation">(</span>String dbPath<span class="token punctuation">,</span> String sql<span class="token punctuation">,</span> <span class="token keyword">boolean</span> needCallBack<span class="token punctuation">,</span> <span class="token keyword">long</span> execSqlCallbackPtr<span class="token punctuation">,</span><span class="token keyword">long</span> paraPtr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> retObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            ISQLiteExecutionDelegate executionDelegate <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//获取到当前 dbPath 对应的 SQLiteLintAndroidCore 对象，然后获取到当前sql 执行的委托对象</span>
            SQLiteLintAndroidCore core <span class="token operator">=</span> SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>core <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                executionDelegate <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">getSQLiteExecutionDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//委托对象为空，直接返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>executionDelegate <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"sqliteLintExecSql mExecSqlImp is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> retObj<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//不为空</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needCallBack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//执行真正的查询操作</span>
                    Cursor cu <span class="token operator">=</span> executionDelegate<span class="token punctuation">.</span><span class="token function">rawQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//判断查询的结果</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cu <span class="token operator">==</span> null <span class="token operator">||</span> cu<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//查询结果出错, 返回值为 -1</span>
                        SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"sqliteLintExecSql cu is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        retObj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Cursor is null"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//查询到了结果,这里传递了cursor</span>
                        <span class="token function">doExecSqlCallback</span><span class="token punctuation">(</span>execSqlCallbackPtr<span class="token punctuation">,</span>paraPtr<span class="token punctuation">,</span> dbPath<span class="token punctuation">,</span> cu<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">//将最终的结果 变为0,代表查询成功</span>
                        retObj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">//关闭Cursor</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cu <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        cu<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//出现了错误,传递错误的信息</span>
                    SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"sqliteLintExecSql rawQuery exp: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    retObj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//如果不需要回调</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//那就单纯的执行他,执行的结果也直接设置为0</span>
                    executionDelegate<span class="token punctuation">.</span><span class="token function">execSQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    retObj<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"sqliteLintExecSql execSQL exp: %s"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    retObj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"sqliteLintExecSql ex "</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> retObj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
这里的查询又通过 executionDelegate<span class="token punctuation">.</span><span class="token function">rawQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> 来执行，而executionDelegate 前面有提到过 SimpleSQLiteExecutionDelegate对象
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SimpleSQLiteExecutionDelegate</span> <span class="token keyword">implements</span> <span class="token class-name">ISQLiteExecutionDelegate</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"SQLiteLint.SimpleSQLiteExecutionDelegate"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> SQLiteDatabase mDb<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SimpleSQLiteExecutionDelegate</span><span class="token punctuation">(</span>SQLiteDatabase db<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span>  db <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        mDb <span class="token operator">=</span> db<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Cursor <span class="token function">rawQuery</span><span class="token punctuation">(</span>String selection<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> selectionArgs<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mDb<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"rawQuery db close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//最终调用了 SQLiteDatabase rawQuery 来执行查询</span>
        <span class="token keyword">return</span> mDb<span class="token punctuation">.</span><span class="token function">rawQuery</span><span class="token punctuation">(</span>selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在当前的demo 中 执行 select name, sql from sqlite_master where type=’table’ 获取到结果为<br><img src="/uploads/Matrix Trace分析/sqlite_master执行结果.png" alt="结果显示"></p>
<pre class=" language-java"><code class="language-java">可以看到这里能获取到 创建表的语句<span class="token punctuation">,</span>接着当我们获取到结果之后，又会执行 <span class="token function">doExecSqlCallback</span><span class="token punctuation">(</span>execSqlCallbackPtr<span class="token punctuation">,</span>paraPtr<span class="token punctuation">,</span> dbPath<span class="token punctuation">,</span> cu<span class="token punctuation">)</span><span class="token punctuation">;</span>会将返回的内容解析出来，接着会调用
<span class="token comment" spellcheck="true">//解析了一条数据，就传递到native层  execSqlCallback(execSqlCallbackPtr, paraPtr, dbName, columnCount, value, name);</span>
extern <span class="token string">"C"</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">Java_com_tencent_sqlitelint_SQLiteLintNativeBridge_execSqlCallback</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jlong exec_sql_callback_ptr<span class="token punctuation">,</span> jlong para_ptr<span class="token punctuation">,</span> jstring name<span class="token punctuation">,</span> jint n_column<span class="token punctuation">,</span>
                                                                jobjectArray column_value<span class="token punctuation">,</span> jobjectArray column_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//将回调地址直接强转为 SqlExecutionCallback</span>
        SqlExecutionCallback exec_sql_callback <span class="token operator">=</span> <span class="token punctuation">(</span>SqlExecutionCallback<span class="token punctuation">)</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span> exec_sql_callback_ptr<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exec_sql_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"execSqlCallback execSqlCallback is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//参数也是</span>
        <span class="token keyword">void</span><span class="token operator">*</span> para <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>intptr_t<span class="token punctuation">)</span> para_ptr<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>para<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"execSqlCallback para is NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//又执行查询结果的回调</span>
        <span class="token function">exec_sql_callback</span><span class="token punctuation">(</span>para<span class="token punctuation">,</span> n_column<span class="token punctuation">,</span> p_column_value<span class="token punctuation">,</span> p_column_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    这里的exec_sql_callback 即为我们前面传递的 OnSelectTablesCallback 函数，所以就会执行到对应的函数
    <span class="token keyword">int</span> <span class="token function">OnSelectTablesCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>para<span class="token punctuation">,</span> <span class="token keyword">int</span> n_column<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>column_value<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>column_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//创建一个 TableInfo 对象</span>
        TableInfo table_info<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//获取到表明</span>
        table_info<span class="token punctuation">.</span>table_name_ <span class="token operator">=</span> <span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> column_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果当前获取到的表名 为 "sqlite_master", "sqlite_sequence", "android_metadata" 中的一个 ，直接返回,因为这些不是我们创建的表,是属于系统</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ReserveSqlManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">IsReservedTable</span><span class="token punctuation">(</span>table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//如果到了这里说明表是用户创建的表</span>
        table_info<span class="token punctuation">.</span>create_sql_ <span class="token operator">=</span> <span class="token punctuation">(</span>column_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> nullptr <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> column_value<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//将para 参数转为 std::vector&lt;TableInfo></span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>TableInfo<span class="token operator">></span> <span class="token operator">*</span>infoList <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>TableInfo<span class="token operator">></span> <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//添加到集合中</span>
        infoList<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span>table_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里我们构建了一个TableInfo 对象，然后从传递过来的结果中赋值 对应的创建表sql语句，之后添加到集合TableInfo中<span class="token punctuation">,</span>这样数据库的表信息就收集完毕了
    回到  <span class="token keyword">void</span> LintEnv<span class="token operator">:</span><span class="token operator">:</span><span class="token function">CollectTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 函数，收集了当前数据库中所拥有的表之后，继续往下面执行
    <span class="token comment" spellcheck="true">//遍历当前 tables_info_ 集合</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>TableInfo <span class="token operator">&amp;</span>table_info <span class="token operator">:</span> tables_info_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//查询数据库列的 sql语句</span>
            select_columns_sql <span class="token operator">=</span> <span class="token string">"PRAGMA table_info("</span> <span class="token operator">+</span> table_info<span class="token punctuation">.</span>table_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//执行查询操作,这里传递的参数 为 table_info，查询完之后填充这个表中列的信息</span>
            r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_columns_sql<span class="token punctuation">,</span> OnSelectColumnsCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//处理查询列错误的信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DealWithGetQuery</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> err_msg<span class="token punctuation">,</span> select_columns_sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//接下来查询表的 索引信息</span>
            select_index_sql <span class="token operator">=</span> <span class="token string">"PRAGMA index_list("</span> <span class="token operator">+</span> table_info<span class="token punctuation">.</span>table_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//这里的 接受处理的回调函数为 OnSelectIndexsCallback</span>
            r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_index_sql<span class="token punctuation">,</span> OnSelectIndexsCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//处理查询错误的信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DealWithGetQuery</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> err_msg<span class="token punctuation">,</span> select_index_sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//遍历当前表中的索引名称，判断是否为组合索引，如果是获取到组合索引中的元素，</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>IndexInfo <span class="token operator">&amp;</span>index_info <span class="token operator">:</span> table_info<span class="token punctuation">.</span>indexs_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                select_index_info_sql <span class="token operator">=</span> <span class="token string">"PRAGMA index_info("</span> <span class="token operator">+</span> index_info<span class="token punctuation">.</span>index_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
                r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_index_info_sql<span class="token punctuation">,</span> OnSelectIndexInfoCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//处理错误的信息</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DealWithGetQuery</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> err_msg<span class="token punctuation">,</span> select_index_info_sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        之后执行查询 
        select_columns_sql <span class="token operator">=</span> <span class="token string">"PRAGMA table_info("</span> <span class="token operator">+</span> table_info<span class="token punctuation">.</span>table_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//执行查询操作,这里传递的参数 为 table_info，查询完之后填充这个表中列的信息</span>
        r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_columns_sql<span class="token punctuation">,</span> OnSelectColumnsCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>PRAGMA table_info(testTable) 查询的结果 ，从下面的几个可以看出，这个语句可以查询出当前表的列，type等<br><img src="/uploads/Matrix Trace分析/column查询的结果.png" alt="结果显示"></p>
<pre class=" language-java"><code class="language-java">至于查询的过程就不重复了，查询成功之后，就会回调执行 OnSelectColumnsCallback（）函数，进一步的填充 代表当前表信息的 table_info 对象
 <span class="token keyword">int</span> <span class="token function">OnSelectColumnsCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>para<span class="token punctuation">,</span> <span class="token keyword">int</span> n_column<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>column_value<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>column_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>para <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"OnSelectColumnsCallback para is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//将参数转转为 TableInfo</span>
        TableInfo <span class="token operator">*</span>table_info <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>TableInfo <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//接下来填充 table_info中 columns_ 成员的值</span>
        ColumnInfo column_info<span class="token punctuation">;</span>
        <span class="token keyword">int</span> columns_assigned <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_column<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//填充name</span>
                column_info<span class="token punctuation">.</span>name_ <span class="token operator">=</span> <span class="token punctuation">(</span>nullptr <span class="token operator">!=</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">?</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                columns_assigned<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//填充type</span>
                column_info<span class="token punctuation">.</span>type_ <span class="token operator">=</span> <span class="token punctuation">(</span>nullptr <span class="token operator">!=</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">?</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                columns_assigned<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"pk"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//填充 primary_key</span>
                column_info<span class="token punctuation">.</span>is_primary_key_ <span class="token operator">=</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span><span class="token punctuation">;</span>
                columns_assigned<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>columns_assigned <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        table_info<span class="token operator">-</span><span class="token operator">></span>columns_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>column_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    接着又执行
    select_index_sql <span class="token operator">=</span> <span class="token string">"PRAGMA index_list("</span> <span class="token operator">+</span> table_info<span class="token punctuation">.</span>table_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//这里的 接受处理的回调函数为 OnSelectIndexsCallback</span>
    r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_index_sql<span class="token punctuation">,</span> OnSelectIndexsCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>“PRAGMA index_list(“ + table_info.table<em>name</em> + “)”;<br><img src="/uploads/Matrix Trace分析/indexList结果.png" alt="结果显示"></p>
<pre class=" language-java"><code class="language-java">查询完之后，就会执行 OnSelectIndexsCallback 函数指针，进一步的填充 table_info对象
 <span class="token keyword">int</span> <span class="token function">OnSelectIndexsCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>para<span class="token punctuation">,</span> <span class="token keyword">int</span> n_column<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>column_value<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>column_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>para <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"OnSelectIndexsCallback para is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        IndexInfo index_info<span class="token punctuation">;</span>
        <span class="token keyword">int</span> columns_assigned <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_column<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//索引的名称</span>
                index_info<span class="token punctuation">.</span>index_name_ <span class="token operator">=</span> <span class="token punctuation">(</span>nullptr <span class="token operator">!=</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">?</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                columns_assigned<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"seq"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//索引的顺序</span>
                index_info<span class="token punctuation">.</span>seq_ <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                columns_assigned<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"unique"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//索引是否唯一</span>
                index_info<span class="token punctuation">.</span>is_unique_ <span class="token operator">=</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'0'</span><span class="token punctuation">;</span>
                columns_assigned<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>columns_assigned <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//将参数转转为 TableInfo</span>
        TableInfo<span class="token operator">*</span> table_info <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>TableInfo <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sVerbose</span><span class="token punctuation">(</span><span class="token string">"OnSelectIndexsCallback index : %s"</span><span class="token punctuation">,</span> index_info<span class="token punctuation">.</span>index_name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//填充当前表创建的索引信息</span>
        table_info<span class="token operator">-</span><span class="token operator">></span>indexs_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>index_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    接着遍历获取到当前表的索引，判断是否为组合索引
    select_index_info_sql <span class="token operator">=</span> <span class="token string">"PRAGMA index_info("</span> <span class="token operator">+</span> index_info<span class="token punctuation">.</span>index_name_ <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
    r <span class="token operator">=</span> <span class="token function">GetQuery</span><span class="token punctuation">(</span>select_index_info_sql<span class="token punctuation">,</span> OnSelectIndexInfoCallback<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index_info<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>“PRAGMA index_info(“ + index_info.index<em>name</em> + “)”;<br><img src="/uploads/Matrix Trace分析/组合索引拆分.png" alt="结果显示"></p>
<pre class=" language-java"><code class="language-java">查询完之后，回调执行 OnSelectIndexInfoCallback 函数，进一步的填充 table_info对象
<span class="token keyword">int</span> <span class="token function">OnSelectIndexInfoCallback</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> para<span class="token punctuation">,</span> <span class="token keyword">int</span> n_column<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> column_value<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> column_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>para <span class="token operator">==</span> nullptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"OnSelectIndexsCallback para is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        IndexElement index_element<span class="token punctuation">;</span>
        <span class="token keyword">int</span> columns_assigned <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_column<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"seqno"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//位置</span>
                index_element<span class="token punctuation">.</span>pos_ <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                columns_assigned <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"cid"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//对应列的索引</span>
                index_element<span class="token punctuation">.</span>column_index_ <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                columns_assigned <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> column_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//列的名称</span>
                index_element<span class="token punctuation">.</span>column_name_ <span class="token operator">=</span> <span class="token punctuation">(</span>nullptr <span class="token operator">!=</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">?</span> column_value<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                columns_assigned <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>columns_assigned <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//添加到TableInfo 中的 IndexInfo 数组中</span>
        IndexInfo<span class="token operator">*</span> index_info <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>IndexInfo<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>index_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index_info<span class="token operator">-</span><span class="token operator">></span><span class="token function">AddIndexElement</span><span class="token punctuation">(</span>index_element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"onCollectIndexInfoCallback indexInfo is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    在这些信息都收集完之后，就可以执行分析了，继续回到前面
</code></pre>
<p>检查 AutoIncrement</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> AvoidAutoIncrementChecker<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Check</span><span class="token punctuation">(</span>LintEnv <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> <span class="token keyword">const</span> SqlInfo <span class="token operator">&amp;</span>sql_info<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span> <span class="token operator">*</span>issues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取到当前数据库 中表的信息集合</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>TableInfo<span class="token operator">></span> tables <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">GetTablesInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">:</span><span class="token operator">:</span>string create_sql<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//遍历这些表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> TableInfo<span class="token operator">&amp;</span> table_info <span class="token operator">:</span> tables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//检查这个table 是否在白名单中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsInWhiteList</span><span class="token punctuation">(</span>kCheckerName<span class="token punctuation">,</span> table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sVerbose</span><span class="token punctuation">(</span><span class="token string">"AvoidAutoIncrementChecker::Check in white list: %s"</span><span class="token punctuation">,</span> table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//获取到当前创建的sql语句，在 select name, sql from sqlite_master where type='table' 中就能获取到全部表的创建信息</span>
            create_sql <span class="token operator">=</span> table_info<span class="token punctuation">.</span>create_sql_<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//转成小写</span>
            <span class="token function">ToLowerCase</span><span class="token punctuation">(</span>create_sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//从创建表的sql 语句中 查找是否有 autoincrement 关键字</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>create_sql<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>kAutoIncrementKeyWord<span class="token punctuation">)</span> <span class="token operator">!=</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">:</span><span class="token operator">:</span>npos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//如果找到了，发布一个结果</span>
                <span class="token function">PublishIssue</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">,</span> issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
对于检测的内容也明了，就是通过你的创建表的sql中判断是否有autoincrement 关键字，如果有就执行 <span class="token function">PublishIssue</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> table_info<span class="token punctuation">.</span>table_name_<span class="token punctuation">,</span> issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> AvoidAutoIncrementChecker<span class="token operator">:</span><span class="token operator">:</span><span class="token function">PublishIssue</span><span class="token punctuation">(</span><span class="token keyword">const</span> LintEnv<span class="token operator">&amp;</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string <span class="token operator">&amp;</span>table_name<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span> <span class="token operator">*</span>issues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">:</span><span class="token operator">:</span>string desc <span class="token operator">=</span> <span class="token string">"Table("</span> <span class="token operator">+</span> table_name <span class="token operator">+</span> <span class="token string">") has a column which is AutoIncrement."</span> <span class="token operator">+</span> <span class="token string">"It's not really recommended."</span><span class="token punctuation">;</span>

        Issue issue<span class="token punctuation">;</span>
        issue<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">GenIssueId</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">GetDbFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kCheckerName<span class="token punctuation">,</span> table_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        issue<span class="token punctuation">.</span>db_path <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">GetDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//当前创建的时间</span>
        issue<span class="token punctuation">.</span>create_time <span class="token operator">=</span> <span class="token function">GetSysTimeMillisecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//等级</span>
        issue<span class="token punctuation">.</span>level <span class="token operator">=</span> IssueLevel<span class="token operator">:</span><span class="token operator">:</span>kTips<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//当前的类型</span>
        issue<span class="token punctuation">.</span>type <span class="token operator">=</span> IssueType<span class="token operator">:</span><span class="token operator">:</span>kAvoidAutoIncrement<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//数据库名</span>
        issue<span class="token punctuation">.</span>table <span class="token operator">=</span> table_name<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//详细的描述信息</span>
        issue<span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//添加到集合中</span>
        issues<span class="token operator">-</span><span class="token operator">></span><span class="token function">push_back</span><span class="token punctuation">(</span>issue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这里的 issues 为我们传递进来的，所以这里就会往这个集合添加元素，继续回到我们的线程执行函数
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">InitCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sVerbose</span><span class="token punctuation">(</span><span class="token string">"Lint::Check() init check"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//休眠4秒</span>
        std<span class="token operator">:</span><span class="token operator">:</span>this_thread<span class="token operator">:</span><span class="token operator">:</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>chrono<span class="token operator">:</span><span class="token operator">:</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//构建一个集合用来收集结果</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token operator">*</span> published_issues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//安排检查， 类型为 kAfterInit 的有 AvoidAutoIncrementChecker  , WithoutRowIdBetterChecker  ,RedundantIndexChecker</span>
        <span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span>CheckScene<span class="token operator">:</span><span class="token operator">:</span>kAfterInit<span class="token punctuation">,</span> <span class="token function">SqlInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//如果published_issues 结果 不为空，说明检查到了有不合格的内容</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>published_issues<span class="token operator">-</span><span class="token operator">></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sInfo</span><span class="token punctuation">(</span><span class="token string">"New check some diagnosis out!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>issued_callback_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//将结果传递回去</span>
                <span class="token function">issued_callback_</span><span class="token punctuation">(</span>env_<span class="token punctuation">.</span><span class="token function">GetDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        delete published_issues<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这样published_issues 集合中就有内容了，下面就可以将结果传递出去了 <span class="token function">issued_callback_</span><span class="token punctuation">(</span>env_<span class="token punctuation">.</span><span class="token function">GetDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">/**
     * 函数指针，用于进一步的中转结果
     * @param db_path
     * @param published_issues
     */</span>
    <span class="token keyword">void</span> <span class="token function">OnIssuePublish</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> db_path<span class="token punctuation">,</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span> published_issues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">//获取到Env</span>
        bool attached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        jint jRet <span class="token operator">=</span> kJvm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jRet <span class="token operator">==</span> JNI_EDETACHED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOGD</span><span class="token punctuation">(</span><span class="token string">"OnIssuePublish GetEnv JNI_EDETACHED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jint jAttachRet <span class="token operator">=</span> kJvm<span class="token operator">-</span><span class="token operator">></span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>env<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jAttachRet <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"OnIssuePublish AttachCurrentThread !JNI_OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                attached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>jRet <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"OnIssuePublish GetEnv !JNI_OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">LOGV</span><span class="token punctuation">(</span><span class="token string">"OnIssuePublish issue size %d"</span><span class="token punctuation">,</span> published_issues<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//构建一个ArrayList</span>
        jclass listCls <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/util/ArrayList"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jobject jIssueList <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewObject</span><span class="token punctuation">(</span>listCls<span class="token punctuation">,</span> kListConstruct<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//将published_issues 集合中的每一个Issure 的信息，添加到 ArrayList中</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> published_issues<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> published_issues<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jstring id <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>it<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jstring dbPath <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>it<span class="token operator">-</span><span class="token operator">></span>db_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jint level <span class="token operator">=</span> it<span class="token operator">-</span><span class="token operator">></span>level<span class="token punctuation">;</span>
            jint type <span class="token operator">=</span> it<span class="token operator">-</span><span class="token operator">></span>type<span class="token punctuation">;</span>
            jstring sql <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>it<span class="token operator">-</span><span class="token operator">></span>sql<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jstring table <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>it<span class="token operator">-</span><span class="token operator">></span>table<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jstring desc <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>it<span class="token operator">-</span><span class="token operator">></span>desc<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jstring detail <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>it<span class="token operator">-</span><span class="token operator">></span>detail<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jstring advice <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>it<span class="token operator">-</span><span class="token operator">></span>advice<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jlong createTime <span class="token operator">=</span> it<span class="token operator">-</span><span class="token operator">></span>create_time<span class="token punctuation">;</span>
            jstring extInfo <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> it<span class="token operator">-</span><span class="token operator">></span>ext_info<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jlong sqlTimeCost <span class="token operator">=</span> it<span class="token operator">-</span><span class="token operator">></span>sql_time_cost<span class="token punctuation">;</span>
            jboolean isInMainThread <span class="token operator">=</span> it<span class="token operator">-</span><span class="token operator">></span>is_in_main_thread<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//构建以java层 SQLiteLintIssue对象</span>
            jobject diagnosisObj <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">NewObject</span><span class="token punctuation">(</span>kIssueClass<span class="token punctuation">,</span> kMethodIDIssueConstruct<span class="token punctuation">,</span> id<span class="token punctuation">,</span> dbPath<span class="token punctuation">,</span>
                                                  level<span class="token punctuation">,</span> type<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> table<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> detail<span class="token punctuation">,</span> advice<span class="token punctuation">,</span> createTime<span class="token punctuation">,</span> extInfo<span class="token punctuation">,</span> sqlTimeCost<span class="token punctuation">,</span> isInMainThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOGV</span><span class="token punctuation">(</span><span class="token string">"OnIssuePublish id=%s"</span><span class="token punctuation">,</span> it<span class="token operator">-</span><span class="token operator">></span>id<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//执行 ArrayList 的 Add 函数，添加到 ArrayList 集合中</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallBooleanMethod</span><span class="token punctuation">(</span>jIssueList<span class="token punctuation">,</span> kListAdd<span class="token punctuation">,</span> diagnosisObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>advice<span class="token punctuation">)</span><span class="token punctuation">;</span>
            env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>extInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//调用 SQLiteLintNativeBridge 的 onPublishIssue 函数，传递结果</span>
        jstring jDbPath <span class="token operator">=</span> <span class="token function">charsToJstring</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>kJavaBridgeClass<span class="token punctuation">,</span> kMethodIDOnPublishIssueCallback<span class="token punctuation">,</span> jDbPath<span class="token punctuation">,</span> jIssueList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>jDbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>attached<span class="token punctuation">)</span> kJvm<span class="token operator">-</span><span class="token operator">></span><span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    最终会通过JNI的调用java 到 SQLiteLintNativeBridge 中的 onPublishIssue 函数
     <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onPublishIssue</span><span class="token punctuation">(</span><span class="token keyword">final</span> String dbName<span class="token punctuation">,</span> <span class="token keyword">final</span> ArrayList<span class="token operator">&lt;</span>SQLiteLintIssue<span class="token operator">></span> publishedIssues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dbName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onPublish</span><span class="token punctuation">(</span>publishedIssues<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SLog<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onPublishIssue ex "</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    之后的逻辑就不看了，大致就是会先存储到内部的数据库，然后将这些结果显示出来<span class="token punctuation">,</span>包括冗余检查，Without RowId 这里就不检测了
</code></pre>
<p>对于我们事实的sql 语句检查是怎么样做到的呢</p>
<pre class=" language-java"><code class="language-java">在demo 中 有这样的方法，会按钮按下的时候触发

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取到 要测试的 sql 数组</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> list <span class="token operator">=</span> TestSQLiteLintHelper<span class="token punctuation">.</span><span class="token function">getTestParserList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//分别执行</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String sql <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MatrixLog<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"testParser, sql = "</span> <span class="token operator">+</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            SQLiteLint<span class="token punctuation">.</span><span class="token function">notifySqlExecution</span><span class="token punctuation">(</span>TestDBHelper<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWritableDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//获取到要测试的sql 语句</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getTestParserList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
                <span class="token string">"select a,b,c from test  where id > 100 and id &lt; 200 or id between 300 and 400 or id = 1000 ORDER BY c1,c2,c3 desc limit 10 offset 2;"</span><span class="token punctuation">,</span>
                <span class="token string">"select t1.a ,t2.b from table1 as t1,table2 as t2 where t1.tid = t2.tid and t1.tid='aaa' or t2.tid=12;"</span><span class="token punctuation">,</span>
                <span class="token string">"select count(*) from test union select id from test where id not IN (select id from test1);"</span><span class="token punctuation">,</span>
                <span class="token string">"select title, year from film where starring like 'Jodie%' and year >= 1985 order by year desc limit 10;"</span><span class="token punctuation">,</span>
                <span class="token string">"SELECT * FROM table1 WHERE column2 not LIKE 'rt' OR column3 LIKE 'rc' AND column1 = 'yy' GROUP BY column2 ORDER BY column2;"</span><span class="token punctuation">,</span>
                <span class="token string">"SELECT * FROM nosharding_test WHERE id = 1 AND(id &lt; 50 OR id > 200);"</span><span class="token punctuation">,</span>
                <span class="token string">"SELECT * FROM test WHERE name NOT LIKE '/Hello%' ESCAPE '/';"</span><span class="token punctuation">,</span>
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   遍历每一条语句<span class="token punctuation">,</span>分别执行
   SQLiteLint<span class="token punctuation">.</span><span class="token function">notifySqlExecution</span><span class="token punctuation">(</span>TestDBHelper<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWritableDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">notifySqlExecution</span><span class="token punctuation">(</span>String concernedDbPath<span class="token punctuation">,</span> String sql<span class="token punctuation">,</span> <span class="token keyword">int</span> timeCost<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//获取到当前 数据库的路径 对应的 SQLiteLintAndroidCore</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//notifySqlExecution</span>
        SQLiteLintAndroidCoreManager<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifySqlExecution</span><span class="token punctuation">(</span>concernedDbPath<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> timeCost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifySqlExecution</span><span class="token punctuation">(</span>String dbPath<span class="token punctuation">,</span> String sql<span class="token punctuation">,</span> <span class="token keyword">long</span> timeCost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String extInfoStack <span class="token operator">=</span> <span class="token string">"null"</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//get stack only when cost > 8</span>
        <span class="token comment" spellcheck="true">//timeCost 默认传递的参数为 10，所以大于8</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeCost <span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//这个是获取到当前的堆栈信息</span>
            extInfoStack <span class="token operator">=</span> SQLiteLintUtil<span class="token punctuation">.</span><span class="token function">getThrowableStack</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Throwable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//传递到native 层</span>
        SQLiteLintNativeBridge<span class="token punctuation">.</span><span class="token function">nativeNotifySqlExecute</span><span class="token punctuation">(</span>dbPath<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> timeCost<span class="token punctuation">,</span> extInfoStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    可以看到这里首先获取到java层对应的堆栈信息，然后传递给<span class="token keyword">native</span>层
    <span class="token keyword">void</span> <span class="token function">Java_com_tencent_sqlitelint_SQLiteLintNativeBridge_nativeNotifySqlExecute</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring dbPath
            <span class="token punctuation">,</span> jstring sql<span class="token punctuation">,</span> jlong executeTime<span class="token punctuation">,</span> jstring extInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>filename <span class="token operator">=</span> <span class="token function">jstringToChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> dbPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>ext_info <span class="token operator">=</span> <span class="token function">jstringToChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> extInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>jsql <span class="token operator">=</span> <span class="token function">jstringToChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">NotifySqlExecution</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> jsql<span class="token punctuation">,</span> executeTime<span class="token punctuation">,</span> ext_info<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">free</span><span class="token punctuation">(</span>jsql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>ext_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">NotifySqlExecution</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> db_path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> sql<span class="token punctuation">,</span> <span class="token keyword">long</span> time_cost<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ext_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">NotifySqlExecution</span><span class="token punctuation">(</span>db_path<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> time_cost<span class="token punctuation">,</span> ext_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token keyword">void</span> LintManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">NotifySqlExecution</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>db_path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> <span class="token keyword">long</span> time_cost<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ext_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//加锁</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>lints_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//找到当前数据库路径对应的 Lint 对象</span>
        std<span class="token operator">:</span><span class="token operator">:</span>map<span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token punctuation">,</span> Lint<span class="token operator">*</span><span class="token operator">></span><span class="token operator">:</span><span class="token operator">:</span>iterator it <span class="token operator">=</span> lints_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> lints_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sWarn</span><span class="token punctuation">(</span><span class="token string">"LintManager::NotifySqlExecution lint not installed; dbPath: %s"</span><span class="token punctuation">,</span> db_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//执行测试</span>
        it<span class="token operator">-</span><span class="token operator">></span>second<span class="token operator">-</span><span class="token operator">></span><span class="token function">NotifySqlExecution</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> time_cost<span class="token punctuation">,</span> ext_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">NotifySqlExecution</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">long</span> time_cost<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ext_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//参数检查</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sql <span class="token operator">==</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"Lint::NotifySqlExecution sql NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//判断当前sql 是否在 reserve_sql_mgr_ 集合中 找得到，并且找到的时候 时间不能超过一秒</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>env_<span class="token punctuation">.</span><span class="token function">IsReserveSql</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sDebug</span><span class="token punctuation">(</span><span class="token string">"Lint::NotifySqlExecution a reserved sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//构建一个SqlInfo 对象</span>
        SqlInfo <span class="token operator">*</span>sql_info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sql_info<span class="token operator">-</span><span class="token operator">></span>sql_ <span class="token operator">=</span> sql<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//对应的执行的时间</span>
        sql_info<span class="token operator">-</span><span class="token operator">></span>execution_time_ <span class="token operator">=</span> <span class="token function">GetSysTimeMillisecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//对应的java 的堆栈信息</span>
        sql_info<span class="token operator">-</span><span class="token operator">></span>ext_info_ <span class="token operator">=</span> ext_info<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//对应的花费的时间</span>
        sql_info<span class="token operator">-</span><span class="token operator">></span>time_cost_ <span class="token operator">=</span> time_cost<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//标识当前的状态是否在主线程</span>
        sql_info<span class="token operator">-</span><span class="token operator">></span>is_in_main_thread_ <span class="token operator">=</span> <span class="token function">IsInMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//加锁</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>queue_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//将这个 sql_info 添加到了 queue_ 队列中，同时执行了 notify_one ，这样检查的线程就会唤醒了</span>
        queue_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>SqlInfo<span class="token operator">></span><span class="token punctuation">(</span>sql_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queue_cv_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//解锁</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    这边会将传递参数，构建一个SqlInfo 对象，然后添加到 queue_ 中<span class="token punctuation">,</span>前面说个还有一个线程因为queue中的内容为空，导致处于阻塞的状态，这里因为添加进去了，所以就不会阻塞了，继续回到
    线程函数

    <span class="token keyword">void</span> Lint<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//这边又构建一个  init_check_thread_ 的线程，线程执行的时候，会执行  InitCheck 函数</span>
        init_check_thread_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Lint<span class="token operator">:</span><span class="token operator">:</span>InitCheck<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//用来存储要分发结果的集合</span>
        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token operator">*</span> published_issues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">std</span><span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>Issue<span class="token operator">></span><span class="token punctuation">;</span>
        std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>SqlInfo<span class="token operator">></span> sql_info<span class="token punctuation">;</span>
        SqlInfo simple_sql_info<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//这下面一般是检查是否有结果，有就分发出去之类的</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment" spellcheck="true">//从queue 结果队列中 获取到内容，如果 队列中有元素，取出对头的元素，然后辅助给 sql_info ，如果没有元素，则会阻塞在这里</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">TakeSqlInfo</span><span class="token punctuation">(</span>sql_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"check exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//取出了队列中的头部的元素,下面是执行分发</span>

            <span class="token comment" spellcheck="true">//标识当前检测的sql 语句加一</span>
            env_<span class="token punctuation">.</span><span class="token function">IncSqlCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span>CheckScene<span class="token operator">:</span><span class="token operator">:</span>kSample<span class="token punctuation">,</span> <span class="token operator">*</span>sql_info<span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> wildcard_sql <span class="token operator">=</span> sql_info<span class="token operator">-</span><span class="token operator">></span>wildcard_sql_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> sql_info<span class="token operator">-</span><span class="token operator">></span>sql_ <span class="token operator">:</span> sql_info<span class="token operator">-</span><span class="token operator">></span>wildcard_sql_<span class="token punctuation">;</span>
            bool checked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>checked_sql_cache_<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>wildcard_sql<span class="token punctuation">,</span> checked<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span>CheckScene<span class="token operator">:</span><span class="token operator">:</span>kUncheckedSql<span class="token punctuation">,</span> <span class="token operator">*</span>sql_info<span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
                checked_sql_cache_<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>wildcard_sql<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">sVerbose</span><span class="token punctuation">(</span><span class="token string">"Lint::Check() already checked recently"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>published_issues<span class="token operator">-</span><span class="token operator">></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sInfo</span><span class="token punctuation">(</span><span class="token string">"New check some diagnosis out!, sql=%s"</span><span class="token punctuation">,</span> sql_info<span class="token operator">-</span><span class="token operator">></span>sql_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>issued_callback_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">issued_callback_</span><span class="token punctuation">(</span>env_<span class="token punctuation">.</span><span class="token function">GetDbPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            sql_info <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
            env_<span class="token punctuation">.</span><span class="token function">CheckReleaseHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">sError</span><span class="token punctuation">(</span><span class="token string">"check break"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delete published_issues<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    由于<span class="token function">TakeSqlInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 返回了元素，所以会往下执行，分别执行 <span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span>CheckScene<span class="token operator">:</span><span class="token operator">:</span>kSample<span class="token punctuation">,</span> <span class="token operator">*</span>sql_info<span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>，以及 
    <span class="token function">ScheduleCheckers</span><span class="token punctuation">(</span>CheckScene<span class="token operator">:</span><span class="token operator">:</span>kUncheckedSql<span class="token punctuation">,</span> <span class="token operator">*</span>sql_info<span class="token punctuation">,</span> published_issues<span class="token punctuation">)</span><span class="token punctuation">;</span>至于检测的内容就不细看了，这里比较复杂，检测到了结果之后，就会将检测的结果通过issued_callback_
    传递到java层
</code></pre>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p>SQLiteLint 中检测 ，索引使用问题，冗余索引问题，Autoincrement 问题，without rowid 特性不需要事实的sql语句，只需要通过读取数据库创建的表信息就可以检测，其中检测是通过JNI的方式将参数传递到java层，由java层来真正的操作数据库，查询完之后又将结果传递给Native层，对于 Select * ,prepared statement 需要事实的sql语句来分析，由于没有采用hook sqlite3_profile 所以对于要检测的sql 语句需要java层传递到native层</p>
</blockquote>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><a href="https://mp.weixin.qq.com/s/laUgOmAcMiZIOfM2sWrQgw" target="_blank" rel="noopener">Matrix SQLiteLint – SQLite 使用质量检测</a></li>
<li><a href="https://blog.csdn.net/liubingzhao/article/details/47041735" target="_blank" rel="noopener">在adb shell中直接使用sqlite3命令操作数据库</a></li>
<li><a href="https://www.cnblogs.com/alantu2018/p/8465919.html" target="_blank" rel="noopener"><strong>attribute</strong>中constructor和destructor</a></li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">AheadSnail</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://aheadsnail.github.io/2019/03/14/matrix-sqlite-lint-yuan-ma-jie-xi/">https://aheadsnail.github.io/2019/03/14/matrix-sqlite-lint-yuan-ma-jie-xi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">AheadSnail</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Android/">
                                    <span class="chip bg-color">Android</span>
                                </a>
                            
                                <a href="/tags/Matrix/">
                                    <span class="chip bg-color">Matrix</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/03/15/matrix-resource-cannary-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="Matrix Resource Cannary 源码解析">
                        
                        <span class="card-title">Matrix Resource Cannary 源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            概述
Matrix Resource Cannary 源码解析

                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2019-03-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Matrix/">
                        <span class="chip bg-color">Matrix</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/03/13/matrix-io-canary-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Matrix IO Canary源码解析">
                        
                        <span class="card-title">Matrix IO Canary源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            概述
Matrix IO Canary源码解析

                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2019-03-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Matrix/">
                        <span class="chip bg-color">Matrix</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">AheadSnail</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
