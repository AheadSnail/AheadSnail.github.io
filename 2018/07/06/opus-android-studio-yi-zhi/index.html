<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Opus Android Studio移植, AheadSnail&#39;s blog">
    <meta name="description" content>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Opus Android Studio移植 | AheadSnail&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<link rel="alternate" href="/atom.xml" title="AheadSnail's blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">AheadSnail&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">AheadSnail&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Opus Android Studio移植</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/AndroidStudio/">
                                <span class="chip bg-color">AndroidStudio</span>
                            </a>
                        
                            <a href="/tags/NDK/">
                                <span class="chip bg-color">NDK</span>
                            </a>
                        
                            <a href="/tags/Opus/">
                                <span class="chip bg-color">Opus</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2018-07-06
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>Opus Android Studio移植</p>
</blockquote>
<a id="more"></a>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><blockquote>
<p>这篇文章会介绍怎么在Android Studio中编译Opus，至于为什么要在Android Studio中编译，是为了营造一个可以直接调试C代码的环境，这样可以方便我们开发人员查看代码，调试代码<br>前面一篇文章已经介绍了在Ubuntu 使用NDKr14-b来编译最新版的Opus，而且验证了在手机上是可以正常运行的，而且我们知道opus-tools，需要依赖ogg,flac,opus库，这些库对于我们<br>使用者来说，是完全没有必要去修改的，所以我们直接用Ubuntu中交叉编译的内容，然后查看他们是怎么编译的，需要什么样的参数，采集然后填充到我们的项目中，自己来编译<br>下面会采用ndk-build的模式来编译，至于为什么不采用cmakeList来编译，是因为使用cmakeList编译的时候，出现了录的声音在播放的时候会有停顿，但是采用ndk-build来编译就没有这个问题<br>至于为什么会这样，到目前为止我也没有发现，我猜可能是clang的问题，因为我使用ndk-build编译采用的是gcc，这两者都可以支持调试代码，都可以将生成的so自动的打包进apk，不同的地方就是cmakeList的语法，可能更加简单，毕竟Google 原本采用的是ndk-build，后才出来这个CmakeList</p>
</blockquote>
<h3 id="Android-Studio移植"><a href="#Android-Studio移植" class="headerlink" title="Android Studio移植"></a>Android Studio移植</h3><blockquote>
<p>我们将Ubuntu交叉编译之后产生的local,opus-tools文件,拿出来,创建一个NDK工程，我们直接创建一个CmakeList的NDK项目,将我们需要的文件拷贝到工程中<br>这里我们需要拷贝生成的lib目录，已经include目录，这里都只要oput-tools的依赖文件，ogg,flac,opus 还有直接将opus-tools的源码直接包含进来,<br>接着创建一个Android.mk文件，以及Application.mk文件,下面是文件的结构图</p>
</blockquote>
<p>目录结构图:<br><img src="/uploads/Opus交叉编译/OpusAndroidStudio移植.jpg" alt="结果显示"></p>
<p>1.修改app目录下的build.gradle文件</p>
<pre class=" language-gradle"><code class="language-gradle">defaultConfig{
    ...
    externalNativeBuild {
        ndkBuild {
        //指定构建的架构
        abiFilters "armeabi-v7a"
    }
}

//指定JNI的目录
sourceSets.main.jniLibs.srcDirs = ['/src/main/jni/']

externalNativeBuild {
        ndkBuild {
            //指定Android.mk文件的目录
            path "/src/main/jni/Android.mk"
    }
}
</code></pre>
<p>由于最新版的ndk_bundle 不支持了armeabi，如果构建一个armeabi 就会出现下面的这种错误<br>ABIs [armeabi] are not supported for platform. Supported ABIs are [armeabi-v7a, arm64-v8a, x86, x86_64]. 所以我们可以直接构建一个armeabi-v7a</p>
<p>下面是Android.mk的内容</p>
<pre class=" language-MakeFile"><code class="language-MakeFile">#此变量用于指定当前文件的路径。必须在 Android.mk 文件的开头定义它。 以下示例向您展示如何操作： LOCAL_PATH := $(call my-dir)
#CLEAR_VARS 指向的脚本不会清除此变量。因此，即使您的 Android.mk 文件描述了多个模块，您也只需定义它一次。

LOCAL_PATH := $(call my-dir)

#可以打印信息 E:/sdk/ndk-bundle/build//../build/core 而.代表当前的Android.mk路径
#LOCAL_PATH  H:/AndroidStudioWorkSpace3/OpusNativeBuild/app/src/main/jni 也即是当前Android.mk文件的路径
#要注意使用LOCAL_PATH的时候，不能$LOCAL_PATH这样使用，会打印 OCAL_PATH 要${LOCAL_PATH}或者$(LOCAL_PATH)
$(warning ${LOCAL_PATH})

#此变量指向的构建脚本用于取消定义下面“开发者定义的变量”一节中列出的几乎全部 LOCAL_XXX 变量。 在描述新模块之前，使用此变量包括此脚本
include $(CLEAR_VARS)

#当前模考的名称
LOCAL_MODULE    := FLAc

#.代表当前的目录，当前的目录是前面$(call my-dir)指定的跟android.mk文件同一级别的
LOCAL_SRC_FILES := ${LOCAL_PATH}/lib/libFLAC.a

#一个 BUILD_SHARED_LIBRARY 变量用于编译一个静态库。静态库不会复制到的APK包中，但是能够用于编译共享库。
# 根据您是使用共享 (.so) 还是静态 (.a) 库，添加 PREBUILT_SHARED_LIBRARY 或 PREBUILT_STATIC_LIBRARY。
include $(PREBUILT_STATIC_LIBRARY)

#在编译完一个模块之后，有必要调用CLEAR_VARS 用来清除之前使用的 LOCAL_XXX 变量 ，防止影响当前的模块的内容
include $(CLEAR_VARS)

LOCAL_MODULE    := Ogg

LOCAL_SRC_FILES := ${LOCAL_PATH}/lib/libogg.a

include $(PREBUILT_STATIC_LIBRARY)


include $(CLEAR_VARS)

LOCAL_MODULE    := Opus

LOCAL_SRC_FILES := ${LOCAL_PATH}/lib/libopus.a

include $(PREBUILT_STATIC_LIBRARY)

#此变量指向的构建脚本用于取消定义下面“开发者定义的变量”一节中列出的几乎全部 LOCAL_XXX 变量。（模块之前使用这个，会清除LOCAL的系统变量） 在描述新模块之前
include $(CLEAR_VARS)

LOCAL_MODULE        := opustool

#这是要编译的源代码文件列表。 只要列出要传递给编译器的文件
LOCAL_SRC_FILES     := \
        ${LOCAL_PATH}/opustools/src/opus_header.c \
        ${LOCAL_PATH}/opustools/src/picture.c \
        ${LOCAL_PATH}/opustools/src/resample.c \
        ${LOCAL_PATH}/opustools/src/audio-in.c \
        ${LOCAL_PATH}/opustools/src/diag_range.c \
        ${LOCAL_PATH}/opustools/src/flac.c \
        ${LOCAL_PATH}/opustools/src/lpc.c \
        ${LOCAL_PATH}/opustools/win32/unicode_support.c \
        ${LOCAL_PATH}/opustools/src/wav_io.c \
        ${LOCAL_PATH}/opustools/src/opusinfo.c \
        ${LOCAL_PATH}/opustools/src/info_opus.c \
        ${LOCAL_PATH}/opustools/src/mydecoder.c \
        ${LOCAL_PATH}/opustools/src/myencode.c


#可以使用此可选变量指定相对于 NDK root 目录的路径列表，以便在编译所有源文件（C、C++ 和 Assembly）时添加到 include 搜索路径。
#在通过 LOCAL_CFLAGS 或 LOCAL_CPPFLAGS 设置任何对应的 include 标志之前定义此变量。在使用 ndk-gdb 启动本地调试时，构建系统也会自动使用 LOCAL_C_INCLUDES 路径。
#也即是要在设置 LOCAL_CFLAGS 或者 LOCAL_CPPFLAGS 之前使用
LOCAL_C_INCLUDES := ${LOCAL_PATH}/include ${LOCAL_PATH}/include/opus ${LOCAL_PATH}/opustools/include

#“:=” 的意思是，它右边赋得值如果是变量，只能使用在这条语句之前定义好的，而不能使用本条语句之后定义的变量；
#“=”，当它的右边赋值是变量时，这个变量的定义在本条语句之前或之后都可以；

#此可选变量为构建系统设置在构建 C 和 C++ 源文件时要传递的编译器标志。 此功能对于指定额外的宏定义或编译选项可能很有用。是全局的引用，不是模块化的，只要设置了，对于后面的模块也是有效的
LOCAL_CFLAGS     := -w -std=c11 -Os -fno-strict-aliasing -fprefetch-loop-arrays
LOCAL_CFLAGS     += -DHAVE_CONFIG_H -DOPUSTOOLS -DSPX_RESAMPLE_EXPORT= -DRANDOM_PREFIX=opustools -DOUTSIDE_SPEEX -DFLOATING_POINT -fno-math-errno

#仅当构建 C++ 源文件时才会传递一组可选的编译器标志。 它们将出现在编译器命令行中的 LOCAL_CFLAGS 后面。
LOCAL_CPPFLAGS     := -DBSD=1 -ffast-math -Os -funroll-loops -std=c++11
LOCAL_CPPFLAGS  += -DHAVE_CONFIG_H -DOPUSTOOLS -DSPX_RESAMPLE_EXPORT= -DRANDOM_PREFIX=opustools -DOUTSIDE_SPEEX -DFLOATING_POINT

#此变量包含在构建共享库或可执行文件时要使用的其他链接器标志列表。 它可让您使用 -l 前缀传递特定系统库的名称。 例如，以下示例指示链接器生成在加载时链接到 /system/lib/libz.so
#的模块： LOCAL_LDLIBS := -lz
LOCAL_LDLIBS     := -llog

#LOCAL_STATIC_LIBRARIES此变量用于存储当前模块依赖的静态库模块列表。如果当前模块是共享库或可执行文件，此变量将强制这些库链接到生成的二进制文件。如果当前模块是静态库，
此变量只是指示，依赖当前模块的模块也会依赖列出的库
#LOCAL_SHARED_LIBRARIES此变量是此模块在运行时依赖的共享库模块列表。 此信息在链接时需要，并且会在生成的文件中嵌入相应的信息。
LOCAL_STATIC_LIBRARIES := FLAc Ogg Opus

#指向编译脚本，根据所有的在 LOCAL_XXX 变量把列出的源代码文件编译成一个共享库。 注意，必须至少在包含这个文件之前定义 LOCAL_MODULE 和 LOCAL_SRC_FILES。
include $(BUILD_SHARED_LIBRARY)
</code></pre>
<p>下面是Appliation.mk文件的内容</p>
<pre class=" language-MakeFile"><code class="language-MakeFile">APP_PLATFORM := android-14
APP_ABI := armeabi-v7a
NDK_TOOLCHAIN_VERSION := 4.9
APP_STL := gnustl_static

#APP_OPTIM 将此可选变量定义为 release 或 debug。在构建应用的模块时可使用它来更改优化级别。
#APP_CFLAGS 此变量用于存储构建系统在为任何模块编译任何 C 或 C++ 源代码时传递到编译器的一组 C 编译器标志 也即是全局的
#APP_LDFLAGS 此变量包含构建系统在仅构建 C++ 源文件时传递到编译器的一组 C++ 编译器标志 也即是全局的
#APP_PLATFORM  此变量包含目标 Android 平台的名称。例如，android-3 指定 Android 1.5 系统映像
#APP_STL  默认情况下，NDK 构建系统为 Android 系统提供的最小 C++ 运行时库 (system/lib/libstdc++.so) 提供 C++ 标头
#NDK_TOOLCHAIN_VERSION 将此变量定义为 4.9 或 4.8 以选择 GCC 编译器的版本。 64 位 ABI 默认使用版本 4.9 ，32 位 ABI 默认使用版本 4.8
</code></pre>
<h3 id="源码修改"><a href="#源码修改" class="headerlink" title="源码修改"></a>源码修改</h3><p>从Android.mk文件中有俩个文件是经过修改过后的<br>${LOCAL_PATH}/opustools/src/mydecoder.c<br>${LOCAL_PATH}/opustools/src/myencode.c</p>
<blockquote>
<p>原本的文件为decoder.c encoder.c，对于decoder.c提供的功能可以将一个opus文件，变成一个wav文件，对于encoder.c文件，可以将一个wav文件变成opus文件<br>但是我们在使用的时候，并不会说提供一个wav文件，然后让你去压缩变成一个opus文件，播放语音的时候也不会说提供一个opus文件，经过解压缩变成一个wav文件，然后再来播放这个wav文件<br>这样太慢了，对于解压缩，跟压缩的过程都是有时间延迟的，而且时长越大，延迟也就越大，所以我们需要修改原本的代码,建议在Visual Studio中阅读代码，然后修改,Visual Studio是在Pc上<br>而如果采用NDK中调试，修改代码属于手机端，对应方便来说肯定是PC方便，而且Visual Studio 用来开发c/c++ 是非常强大的，非常方便的 ,而且从git clone的代码来看官网对visual Studio默认是支持的<br>可能人家开发采用的就是Visual Studio ,所以对于前面的文章 Visual Studio中搭建这个环境的必要,下面会直接贴出这些修改文件的全部内容</p>
</blockquote>
<p>压缩提供的接口为</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeInitEncoder</span><span class="token punctuation">(</span>String fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
* opus的压缩，要传递原始的录音的大小，这里传递200个字节
* @param sourceIn
* @return
*/</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeEncodeBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceIn<span class="token punctuation">,</span><span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * opus压缩的资源的释放
 *  如果返回的值不是0，代表初始化失败
 */</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeReleaseEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>myencode.c实现：</p>
<pre class=" language-C++"><code class="language-C++">/*
 * Class:     vide_m4399_com_newopusdemo_OpusEncoder
 * Method:    nativeInitEncoder
 * Signature: (Ljava/lang/String;)V
 */
JNIEXPORT jint JNICALL Java_com_example_administrator_opusnativebuild_OpusEncoder_nativeInitEncoder
  (JNIEnv * env , jobject object, jstring value)
 {
     char * destFileName = Jstring2CStr(env,value);
     int ret = 0;
     if (destFileName == NULL)
     {
         ret = -1;
         LOGD("MyOpus_Init func errot destFileName == NULL ret == %d\n",ret);
         return ret;
     }
     //将变量重置默认值
     opus_resert_variably();

     opt_ctls_ctlval = NULL;
     frange = NULL;
     range_file = NULL;
     in_format = NULL;
     inopt.channels = chan;
     inopt.rate = coding_rate = rate;
     /* 0 dB gain is recommended unless you know what you're doing */
     inopt.gain = 0;
     inopt.samplesize = 16;
     inopt.endianness = 0;
     inopt.rawmode = 0;
     inopt.ignorelength = 0;
     inopt.copy_comments = 1;
     inopt.copy_pictures = 1;

     start_time = time(NULL);
     //生成一个随机数种子
     srand(((getpid() & 65535) << 15) ^ start_time);
     //产生一个随机数,用来校验 文件
     serialno = rand();
     //打印版本号
     opus_version = opus_get_version_string();
     /*Vendor string should just be the encoder library,
     the ENCODER comment specifies the tool used.*/
     //指针做函数参数间距的修改主调函数的值
     comment_init(&inopt.comments, &inopt.comments_length, opus_version);
     //最多从源串中拷贝n-1个字符到目标串中，然后再在后面加一个0。所以如果目标串的大小为n的话...,将opusenc from opus-tools 0.1.10写到ENCODER_string数组中
     snprintf(ENCODER_string, sizeof(ENCODER_string), "opusenc from %s %s", PACKAGE_NAME, PACKAGE_VERSION);
     comment_add(&inopt.comments, &inopt.comments_length, "ENCODER", ENCODER_string);

    //压缩完之后的目标文件
    outFile = destFileName;
    inopt.rawmode = 1;
    in_format = &raw_format;
    //设置一些参数
    in_format->open_func(NULL, &inopt, NULL, 0);

    if (inopt.rate<100 || inopt.rate>768000)
    {
        /*Crazy rates excluded to avoid excessive memory usage for padding/resampling.*/
        exit(1);
    }

    if (inopt.channels>255 || inopt.channels<1)
    {
        exit(1);
    }

    if (downmix == 0 && inopt.channels>2 && bitrate>0 && bitrate<(16000 * inopt.channels))
    {
        if (!quiet)LOGD("Notice: Surround bitrate less than 16kbit/sec/channel, downmixing.\n");
        downmix = inopt.channels>8 ? 1 : 2;
    }

    if (downmix > 0 && downmix < inopt.channels)
    {
        downmix = setup_downmix(&inopt, downmix);
    }
    else
    {
        downmix = 0;
    }

    //设置一些默认值
    rate = inopt.rate;
    chan = inopt.channels;
    inopt.skip = 0;

    /*In order to code the complete length we'll need to do a little padding*/
    setup_padder_from_my(&inopt, &original_samples);

    if (rate > 24000)
    {
        coding_rate = 48000;
    }
    else if (rate > 16000)
    {
        coding_rate = 24000;
    }
    else if (rate > 12000)
    {
        coding_rate = 16000;
    }
    else if (rate > 8000)
    {
        coding_rate = 12000;
    }
    else
    {
        coding_rate = 8000;
    }

    //默认的inopt.rate=coding_rate=rate; = 48000
    frame_size = frame_size / (48000 / coding_rate);

    /*Scale the resampler complexity, but only for 48000 output because
    the near-cutoff behavior matters a lot more at lower rates.*/
    if (rate != coding_rate)
    {
        setup_resample(&inopt, coding_rate == 48000 ? (complexity + 1) / 2 : 5, coding_rate);
    }

    if (rate != coding_rate&&complexity != 10 && !quiet)
    {
        LOGD("Notice: Using resampling with complexity<10.\n");
        LOGD("Opusenc is fastest with 48, 24, 16, 12, or 8kHz input.\n\n");
    }

    /*OggOpus headers*/ /*FIXME: broke forcemono*/
    //给header 结构体赋值
    header.channels = chan;
    header.channel_mapping = header.channels>8 ? 255 : chan>2;
    header.input_sample_rate = rate;
    header.gain = inopt.gain;

    /*Initialize Opus encoder*/
    /*Frame sizes <10ms can only use the MDCT modes, so we switch on RESTRICTED_LOWDELAY
    to save the extra 4ms of codec lookahead when we'll be using only small frames.*/
    //OpusMSEncoder      *st;
    st = opus_multistream_surround_encoder_create(coding_rate, chan, header.channel_mapping, &header.nb_streams, &header.nb_coupled,
        header.stream_map, frame_size<480 / (48000 / coding_rate) ? OPUS_APPLICATION_RESTRICTED_LOWDELAY : OPUS_APPLICATION_AUDIO, &ret);

    if (ret != OPUS_OK)
    {
        LOGD("Error cannot create encoder: %s\n", opus_strerror(ret));
        exit(1);
    }

    //min_bytes 跟 max_frame_bytes大小是一样的
    min_bytes = max_frame_bytes = (1275 * 3 + 7)*header.nb_streams;
    //分配packet的内存空间
    packet = malloc(sizeof(unsigned char)*max_frame_bytes);
    if (packet == NULL)
    {
        LOGD("Error allocating packet buffer.\n");
        exit(1);
    }

    if (bitrate<0)
    {
        /*Lower default rate for sampling rates [8000-44100) by a factor of (rate+16k)/(64k)*/
        bitrate = ((64000 * header.nb_streams + 32000 * header.nb_coupled)*
            (IMIN(48, IMAX(8, ((rate<44100 ? rate : 48000) + 1000) / 1000)) + 16) + 32) >> 6;
    }

    if (bitrate>(1024000 * chan) || bitrate<500)
    {
        LOGD("Error: Bitrate %d bits/sec is insane.\nDid you mistake bits for kilobits?\n", bitrate);
        LOGD("--bitrate values from 6-256 kbit/sec per channel are meaningful.\n");
        exit(1);
    }
    bitrate = IMIN(chan * 256000, bitrate);
    ret = opus_multistream_encoder_ctl(st, OPUS_SET_BITRATE(bitrate));
    if (ret != OPUS_OK)
    {
        LOGD("Error OPUS_SET_BITRATE returned: %s\n", opus_strerror(ret));
        exit(1);
    }
    ret = opus_multistream_encoder_ctl(st, OPUS_SET_VBR(!with_hard_cbr));//1
    if (ret != OPUS_OK)
    {
        LOGD("Error OPUS_SET_VBR returned: %s\n", opus_strerror(ret));
        exit(1);
    }
    if (!with_hard_cbr)
    {
        ret = opus_multistream_encoder_ctl(st, OPUS_SET_VBR_CONSTRAINT(with_cvbr));//0
        if (ret != OPUS_OK)
        {
            LOGD("Error OPUS_SET_VBR_CONSTRAINT returned: %s\n", opus_strerror(ret));
            exit(1);
        }
    }
    ret = opus_multistream_encoder_ctl(st, OPUS_SET_COMPLEXITY(complexity));
    if (ret != OPUS_OK)
    {
        LOGD("Error OPUS_SET_COMPLEXITY returned: %s\n", opus_strerror(ret));
        exit(1);
    }
    ret = opus_multistream_encoder_ctl(st, OPUS_SET_PACKET_LOSS_PERC(expect_loss));
    if (ret != OPUS_OK)
    {
        LOGD("Error OPUS_SET_PACKET_LOSS_PERC returned: %s\n", opus_strerror(ret));
        exit(1);
    }
#ifdef OPUS_SET_LSB_DEPTH
    ret = opus_multistream_encoder_ctl(st, OPUS_SET_LSB_DEPTH(IMAX(8, IMIN(24, inopt.samplesize))));
    if (ret != OPUS_OK)
    {
        LOGD("Warning OPUS_SET_LSB_DEPTH returned: %s\n", opus_strerror(ret));
    }
#endif

    /*We do the lookahead check late so user CTLs can change it*/
    ret = opus_multistream_encoder_ctl(st, OPUS_GET_LOOKAHEAD(&lookahead));
    if (ret != OPUS_OK)
    {
        LOGD("Error OPUS_GET_LOOKAHEAD returned: %s\n", opus_strerror(ret));
        exit(1);
    }
    inopt.skip += lookahead;
    /*Regardless of the rate we're coding at the ogg timestamping/skip is
    always timed at 48000.*/
    header.preskip = inopt.skip*(48000. / coding_rate);
    /* Extra samples that need to be read to compensate for the pre-skip */
    inopt.extraout = (int)header.preskip*(rate / 48000.);

    if (strcmp(outFile, "-") == 0)
    {
#if defined WIN32 || defined _WIN32
        _setmode(_fileno(stdout), _O_BINARY);
#endif
        fout = stdout;
    }
    else {
        //打开文件，二进制的方式
        fout = fopen_utf8(outFile, "wb");
        if (!fout)
        {
                //打开失败
            perror(outFile);
            exit(1);
        }
    }
    /*Initialize Ogg stream struct*/
    if (ogg_stream_init(&os, serialno) == -1)
    {
        LOGD("Error: stream init failed\n");
        exit(1);
    }

    /*Write header*/
    {
        /*The Identification Header is 19 bytes, plus a Channel Mapping Table for
        mapping families other than 0. The Channel Mapping Table is 2 bytes +
        1 byte per channel. Because the maximum number of channels is 255, the
        maximum size of this header is 19 + 2 + 255 = 276 bytes.*/
        unsigned char header_data[276];
        int packet_size = opus_header_to_packet(&header, header_data, sizeof(header_data));
        op.packet = header_data;
        op.bytes = packet_size;
        op.b_o_s = 1;
        op.e_o_s = 0;
        op.granulepos = 0;
        op.packetno = 0;

        ogg_stream_packetin(&os, &op);

        while ((ret = ogg_stream_flush(&os, &og)))
        {
            if (!ret)break;
            /*头单独的做为一个page的存在，写进输出文件里面
            set pointers in the ogg_page struc
            og->header = os->header;
            og->header_len = os->header_fill = vals + 27;
            og->body = os->body_data + os->body_returned;
            og->body_len = bytes;
            */
            ret = oe_write_page(&og, fout);
            if (ret != og.header_len + og.body_len)
            {
                LOGD("Error: failed writing header to output stream\n");
                exit(1);
            }
            //标记已经写了多少个字节
            bytes_written += ret;
            //页数加一,已经写了一页
            pages_out++;
        }
        //重新的给ogg_packet赋值
        comment_pad(&inopt.comments, &inopt.comments_length, comment_padding);
        op.packet = (unsigned char *)inopt.comments;
        op.bytes = inopt.comments_length;
        op.b_o_s = 0;
        op.e_o_s = 0;
        op.granulepos = 0;
        op.packetno = 1;
        ogg_stream_packetin(&os, &op);
    }
    //写剩余Opus header packets信息
    /* writing the rest of the Opus header packets */
    while ((ret = ogg_stream_flush(&os, &og)))
    {
        if (!ret)
        {
            break;
        }
        ret = oe_write_page(&og, fout);
        if (ret != og.header_len + og.body_len)
        {
            LOGD("Error: failed writing header to output stream\n");
            exit(1);
        }
        bytes_written += ret;
        pages_out++;
    }

    free(inopt.comments);

    //输入分配的内存大小为160 * 1 *4
    input = malloc(sizeof(float)*frame_size*chan);
    if (input == NULL)
    {
        LOGD("Error: couldn't allocate sample buffer.\n");
        exit(1);
    }
    id++;
    return ret;
 }

int MyOpusEncoder(signed char * srcDataBuff, int readSize)
{
    int ret = 0;
    int size_segments, cur_frame_size;
    nb_samples = -1;
    //将读取到的数据，进一步处理
    nb_samples = inopt.read_samples_my(inopt.readdata, input, srcDataBuff, readSize, frame_size);
    total_samples += nb_samples;
    //刚好到了文件的末尾，一点数据都没有读取到
    if (nb_samples == 0)
    {
        op.e_o_s = 1;
        return 0;
    }

    if (start_time == 0)
    {
        start_time = time(NULL);
    }
    //当前的fragme_size
    cur_frame_size = frame_size;
    //到了文件的末尾的话,正常的话，nb_samples跟cur_frame_size，这俩个的值是一样的，小于的话，可能读取到了文件的末尾
    if (nb_samples<cur_frame_size)
    {
        op.e_o_s = 1;
        /*Avoid making the final packet 20ms or more longer than needed.*/
        cur_frame_size -= ((cur_frame_size - (nb_samples>0 ? nb_samples : 1)) / (coding_rate / 50))*(coding_rate / 50);
        /*No fancy end padding, just fill with zeros for now.*/
        //剩余的要填充0
        for (i = nb_samples*chan; i < cur_frame_size*chan; i++)
        {
            input[i] = 0;
        }
        LOGD("Error: arriver record end reflash data length == %d\n",nb_samples);
    }

    /*Encode current frame*/
    VG_UNDEF(packet, max_frame_bytes);
    VG_CHECK(input, sizeof(float)*chan*cur_frame_size);
    //进行压缩数据,返回压缩之后的字节，如果小于0，表示压缩失败,将压缩内容写到packet里面
    nbBytes = opus_multistream_encode_float(st, input, cur_frame_size, packet, max_frame_bytes);
    //如果小于0，说明压缩出现了问题
    if (nbBytes<0)
    {
        LOGD("Encoding failed: %s. Aborting.\n", opus_strerror(nbBytes));
        return 0;
    }
    VG_CHECK(packet, nbBytes);
    VG_UNDEF(input, sizeof(float)*chan*cur_frame_size);
    nb_encoded += cur_frame_size;
    enc_granulepos += cur_frame_size * 48000 / coding_rate;
    //记录已经压缩过的总大小
    total_bytes += nbBytes;
    //一个片段是255个字节，来判断压缩之后是有多少个片段
    size_segments = (nbBytes + 255) / 255;
    peak_bytes = IMAX(nbBytes, peak_bytes);
    min_bytes = IMIN(nbBytes, min_bytes);

    if (frange != NULL)
    {
        opus_uint32 rngs[256];
        OpusEncoder *oe;
        for (i = 0; i<header.nb_streams; i++)
        {
            ret = opus_multistream_encoder_ctl(st, OPUS_MULTISTREAM_GET_ENCODER_STATE(i, &oe));
            ret = opus_encoder_ctl(oe, OPUS_GET_FINAL_RANGE(&rngs[i]));
        }
        save_range(frange, cur_frame_size*(48000 / coding_rate), packet, nbBytes, rngs, header.nb_streams);
    }

    /*Flush early if adding this packet would make us end up with a
    continued page which we wouldn't have otherwise.*/
    //当片段达到255的时候，就要写数据了，缓冲区已满     max_ogg_delay=48000; /*48kHz samples*/
    while ((((size_segments <= 255) && (last_segments + size_segments>255)) || (enc_granulepos - last_granulepos>max_ogg_delay)) &&
#ifdef OLD_LIBOGG
        ogg_stream_flush(&os, &og))
    {
#else
        ogg_stream_flush_fill(&os, &og, 255 * 255))
    {
#endif
        if (ogg_page_packets(&og) != 0)
        {
            last_granulepos = ogg_page_granulepos(&og);
        }
        last_segments -= og.header[26];
        ret = oe_write_page(&og, fout);
        if (ret != og.header_len + og.body_len)
        {
            LOGD("Error: failed writing data to output stream\n");
            exit(1);
        }
        //已经写了多少个字节
        bytes_written += ret;
        //页数加一
        pages_out++;
    }
    //填写packet
    op.packet = (unsigned char *)packet;
    op.bytes = nbBytes;
    op.b_o_s = 0;
    op.granulepos = enc_granulepos;
    if (op.e_o_s)
    {
        /*We compute the final GP as ceil(len*48k/input_rate)+preskip. When a
        resampling decoder does the matching floor((len-preskip)*input_rate/48k)
        conversion, the resulting output length will exactly equal the original
        input length when 0<input_rate<=48000.*/
        op.granulepos = ((original_samples * 48000 + rate - 1) / rate) + header.preskip;
    }
    op.packetno = 2 + id;
    //将当前压缩后的packet的内容，封装到os里面
    ogg_stream_packetin(&os, &op);
    //用来判断是否是片段到了255个
    last_segments += size_segments;

    /*If the stream is over or we're sure that the delayed flush will fire,
    go ahead and flush now to avoid adding delay.*/
    //读取到了文件的末尾
    while ((op.e_o_s || (enc_granulepos + (frame_size * 48000 / coding_rate) - last_granulepos>max_ogg_delay) || (last_segments >= 255)) ?
#ifdef OLD_LIBOGG
        /*Libogg > 1.2.2 allows us to achieve lower overhead by
        producing larger pages. For 20ms frames this is only relevant
        above ~32kbit/sec.*/
        ogg_stream_flush(&os, &og) :
        ogg_stream_pageout(&os, &og))
    {
#else
        ogg_stream_flush_fill(&os, &og, 255 * 255) :
        ogg_stream_pageout_fill(&os, &og, 255 * 255))
    {
#endif
        if(op.e_o_s)
        {
            LOGD("Error: reflash data.\n");
        }
        if (ogg_page_packets(&og) != 0)
        {
            last_granulepos = ogg_page_granulepos(&og);
        }
        last_segments -= og.header[26];
        ret = oe_write_page(&og, fout);
        if (ret != og.header_len + og.body_len)
        {
            LOGD("Error: failed writing data to output stream\n");
            exit(1);
        }
        bytes_written += ret;
        pages_out++;
    }
    return ret;
}

/*
 * Class:     vide_m4399_com_newopusdemo_OpusEncoder
 * Method:    nativeEncodeBytes
 * Signature: ([BI)I
 */
JNIEXPORT jint JNICALL Java_com_example_administrator_opusnativebuild_OpusEncoder_nativeEncodeBytes
  (JNIEnv * env, jobject object, jbyteArray  encoder_insrc, jint length)
{
    jbyte* opus_data_encoder = (*env)->GetByteArrayElements(env, encoder_insrc, 0);
    int ret = MyOpusEncoder(opus_data_encoder,length);

    (*env)->ReleaseByteArrayElements(env, encoder_insrc, opus_data_encoder, 0);
    if ((*env)->ExceptionCheck(env))
    {
        return -1;
    }
    return ret;
}

/*
 * Class:     vide_m4399_com_newopusdemo_OpusEncoder
 * Method:    nativeReleaseEncoder
 * Signature: ()V
 */
JNIEXPORT jint JNICALL Java_com_example_administrator_opusnativebuild_OpusEncoder_nativeReleaseEncoder
  (JNIEnv * env, jobject object)
  {
    int ret = 0;

    //终止的时候，要刷新数据,将最后的数据写进文件,这里是人为的调用这个方法，
    signed char srcDataBuff[320] = {0};
    MyOpusEncoder(srcDataBuff,10);
    //不可以调用下面的方法直接的进行刷新数据,这样会导致，最后面有杂音
    //if (ogg_page_packets(&og) != 0)
    //{
    //        last_granulepos = ogg_page_granulepos(&og);
    //}
    //last_segments -= og.header[26];
    //ret = oe_write_page(&og, fout);
    //if (ret != og.header_len + og.body_len)
    //{
    //    LOGD("Error: failed writing data to output stream\n");
    //    exit(1);
    //}
    //bytes_written += ret;
    //pages_out++;

    LOGD("Debug: opus clear memory begin.\n");
    opus_multistream_encoder_destroy(st);
    ogg_stream_clear(&os);
    free(packet);
    free(input);
    if (opt_ctls)
    {
        free(opt_ctls_ctlval);
    }
    if (rate != coding_rate)
    {
        clear_resample(&inopt);
    }
    clear_padder(&inopt);
    if (downmix)
    {
        clear_downmix(&inopt);
    }
    in_format->close_func(inopt.readdata);
    if (fout)
    {
        fclose(fout);
    }
    //释放由一开始分配的内存空间Jstring2CStr
    if(outFile)
    {
        free(outFile);
    }

    if (frange)
    {
        fclose(frange);
    }
     LOGD("Debug: opus clear memory success.\n");
    return ret;
}
</code></pre>
<p>解码对应的java接口</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
* opus解码器的初始化,初始话成功返回0
*/</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeInitDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
* opus流的解析.返回解压缩之后的大小
*
* @param in 要解析的数组
* @param readSize 读取的大小
* @param out 解析之后的数组
* @return
*/</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeDecodeBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> in<span class="token punctuation">,</span><span class="token keyword">int</span> readSize<span class="token punctuation">,</span><span class="token keyword">short</span><span class="token punctuation">[</span><span class="token punctuation">]</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * opus解码器的释放,释放成功返回0
*/</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeReleaseDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>JNI接口对应的源码实现</p>
<pre class=" language-C++"><code class="language-C++">int MyOpusDecoder(char * srcData,int nb_read,short * destData)
{
    int ret = 0;
    if (srcData == NULL || destData == NULL || nb_read <= 0)
    {
        ret = -1;
        LOGD("MyOpusDecoder func error srcData == NULL  descData == NULL || nb_read <= 0 ret == %d\n",ret);
        return ret;
    }

    char * data;
    /*Get the ogg buffer for writing*/
    data = ogg_sync_buffer(&oy, 200);
    //内存的拷贝
    memcpy(data, srcData, nb_read);
    //标识当前已经读取了多少个字节  return((char *)oy->data + oy->fill);
    ogg_sync_wrote(&oy, nb_read);

    //标识每一页能解析多少个字节
    int pageCount = 0;

    int i;
    /*Loop for all complete pages we got (most likely only one)*/
    //从读取的内容中，找到一个page的内容，最有可能找到一页,只要找到一页的数据才会去解析
    while (ogg_sync_pageout(&oy, &og) == 1)
    {
        //如果ogg_stream_state os没有被初始化,标识ogg_stream已经被初始化了
        if (stream_init == 0)
        {
            //初始化ogg_stream_state os 分配内存空间，指定文件的唯一值
            ogg_stream_init(&os, ogg_page_serialno(&og));
            //标识已经初始化了
            stream_init = 1;
        }
        //比较serialno是否是相等，ogg_stream_state os 的serialno本来就是og的
        if (ogg_page_serialno(&og) != os.serialno)
        {
            /* so all streams are read. */
            ogg_stream_reset_serialno(&os, ogg_page_serialno(&og));
        }
        /*Add page to the bitstream*/
        ogg_stream_pagein(&os, &og);
        page_granule = ogg_page_granulepos(&og);
        /*Extract all available packets*/
        //解析出所有的packet，将每个packet变成原始的数据
        while (ogg_stream_packetout(&os, &op) == 1)
        {
            /*OggOpus streams are identified by a magic string in the initial
            stream header.*/
            //解析每个packet的前面8个字节，是否是OpusHead，
            if (op.b_o_s && op.bytes >= 8 && !memcmp(op.packet, "OpusHead", 8))
            {
                if (has_opus_stream && has_tags_packet)
                {
                    /*If we're seeing another BOS OpusHead now it means
                    the stream is chained without an EOS.*/
                    has_opus_stream = 0;
                    if (st)
                    {
                        opus_multistream_decoder_destroy(st);
                    }
                    st = NULL;
                    LOGD("\nWarning: stream %" I64FORMAT " ended without EOS and a new stream began.\n", (long long)os.serialno);
                }

                if (!has_opus_stream)
                {
                    if (packet_count>0 && opus_serialno == os.serialno)
                    {
                        LOGD("\nError: Apparent chaining without changing serial number (%" I64FORMAT "==%" I64FORMAT ").\n",
                                (long long)opus_serialno, (long long)os.serialno);
                        quit(1);
                    }

                    opus_serialno = os.serialno;
                    //标识有opus_stream的流
                    has_opus_stream = 1;
                    has_tags_packet = 0;
                    link_out = 0;
                    //解析一开始的时候，将这个packet的数量置为0
                    packet_count = 0;
                    eos = 0;
                    total_links++;
                }
                else
                {
                    LOGD("\nWarning: ignoring opus stream %" I64FORMAT "\n", (long long)os.serialno);
                }
            }

            //判断每个packet的合法性，是否有opus_stream,还有判断文件的唯一标识是否相等
            if (!has_opus_stream || os.serialno != opus_serialno)
            {
                break;
            }
            //如果第一个packet 是一个合法的  处理opus的头部
            /*If first packet in a logical stream, process the Opus header*/
            if (packet_count == 0)
            {
                int old_channels = channels;
                //解析opus的头部，并且初始化opus的解码器，获取到opus头文件中的速录rate
                st = process_header(&op, &decoder_rate, &mapping_family, &channels, &preskip, &gain, manual_gain, &streams, wav_format, decoder_quiet);
                //st为空，代表初始化失败，直接退出
                if (!st)
                {
                    quit(1);
                }

                if (output && channels != old_channels)
                {
                    LOGD("\nError: Apparent chaining changes channel count from %d to %d.\n", old_channels, channels);
                    LOGD("This is currently unhandled by opusdec.\n");
                    quit(1);
                }

                if (ogg_stream_packetout(&os, &op) != 0 || og.header[og.header_len - 1] == 255)
                {
                    /*The format specifies that the initial header and tags packets are on their
                    own pages. To aid implementors in discovering that their files are wrong
                    we reject them explicitly here. In some player designs files like this would
                    fail even without an explicit test.*/
                    LOGD("Extra packets on initial header page. Invalid stream.\n");
                    quit(1);
                }

                /*Remember how many samples at the front we were told to skip
                so that we can adjust the timestamp counting.*/
                gran_offset = preskip;

                /*Setup the memory for the dithered output*/
                //如果没有分配内存空间，分配内存空间
                if (!shapemem.a_buf)
                {
                    shapemem.a_buf = calloc(channels, sizeof(float) * 4);
                    shapemem.b_buf = calloc(channels, sizeof(float) * 4);
                    //保存帧
                    shapemem.fs = decoder_rate;
                }
                //分配存储解压缩后的内容
                if (!output)
                {
                    output = malloc(sizeof(float)*MAX_FRAME_SIZE*channels);
                }

                if (!shapemem.a_buf || !shapemem.b_buf || !output)
                {
                    LOGD("Memory allocation failure.\n");
                    quit(1);
                }

                /*Normal players should just play at 48000 or their maximum rate,
                as described in the OggOpus spec.  But for commandline tools
                like opusdec it can be desirable to exactly preserve the original
                sampling rate and duration, so we have a resampler here.*/
                if (decoder_rate != 48000 && resampler == NULL)
                {
                    int err;
                    resampler = speex_resampler_init(channels, 48000, decoder_rate, 5, &err);
                    if (err != 0)
                    {
                        LOGD("resampler error: %s\n", speex_resampler_strerror(err));
                    }
                    speex_resampler_skip_zeros(resampler);
                }
            }
            else if (packet_count == 1)//第二次写的coment信息
            {
                if (!decoder_quiet)
                {
                    print_comments((char*)op.packet, op.bytes);
                }
                has_tags_packet = 1;
                if (ogg_stream_packetout(&os, &op) != 0 || og.header[og.header_len - 1] == 255)
                {
                    LOGD("Extra packets on initial tags page. Invalid stream.\n");
                    quit(1);
                }
            }
            else
            {
                //这边才是开始解析压缩的数据
                int ret;
                opus_int64 maxout;
                opus_int64 outsamp;

                //默认丢失帧为0
                int lost = 0;
                if (loss_percent > 0 && 100 * ((float)rand()) / RAND_MAX < loss_percent)
                {
                    lost = 1;
                }

                /*End of stream condition*/
                //标识已经读取到了文件的结尾
                if (op.e_o_s && os.serialno == opus_serialno)
                {
                    eos = 1; /* don't care for anything except opus eos */
                }

                /*Are we simulating loss for this packet?*/
                //标识我们是否有丢包的情况
                if (!lost)
                {
                    /*Decode Opus packet*/
                    //解析packet 片段的内容,输出到output里面
                    ret = opus_multistream_decode_float(st, (unsigned char*)op.packet, op.bytes, output, MAX_FRAME_SIZE, 0);
                }
                else
                {
                    /*Extract the original duration.
                    Normally you wouldn't have it for a lost packet, but normally the
                    transports used on lossy channels will effectively tell you.
                    This avoids opusdec squaking when the decoded samples and
                    granpos mismatches.*/
                    opus_int32 lost_size;
                    lost_size = MAX_FRAME_SIZE;
                    if (op.bytes>0)
                    {
                        opus_int32 spp;
                        spp = opus_packet_get_nb_frames(op.packet, op.bytes);
                        if (spp>0)
                        {
                            spp *= opus_packet_get_samples_per_frame(op.packet, 48000/*decoding_rate*/);
                            if (spp > 0)
                            {
                                lost_size = spp;
                            }
                        }
                    }
                    /*Invoke packet loss concealment.*/
                    ret = opus_multistream_decode_float(st, NULL, 0, output, lost_size, 0);
                }

                //解压缩返回的值，如果小于0的话，说明解压缩出现了错误
                /*If the decoder returned less than zero, we have an error.*/
                if (ret<0)
                {
                    LOGD("Decoding error: %s\n", opus_strerror(ret));
                    break;
                }
                //解压缩之后返回的值
                decoder_frame_size = ret;
                /*Apply header gain, if we're not using an opus library new enough to do this internally.*/
                if (gain != 0)
                {
                    for (i = 0; i < decoder_frame_size*channels; i++)
                    {
                        output[i] *= gain;
                    }
                }

                /*This handles making sure that our output duration respects
                the final end-trim by not letting the output sample count
                get ahead of the granpos indicated value.*/
                maxout = ((page_granule - gran_offset)*decoder_rate / 48000) - link_out;
                //返回解压缩之后的大小
                outsamp = audio_write(output, channels, decoder_frame_size, resampler, &preskip, dither ? &shapemem : 0, 1, 0>maxout ? 0 : maxout, fp, destData+pageCount);
                //将当前读取的长度，加到总共解压缩之后的大小
                link_out += outsamp;

                audio_size += (fp ? 4 : 2)*outsamp*channels;

                pageCount += outsamp;
            }
            //在一页中的标识packet的数量，
            packet_count++;
        }

        if (pageCount > 0)
        {
            //写的是short *,将首地址变成char * ，只是每次写俩个字节，就可以做到写short*
            //fwrite((char *)destData, (fp ? 4 : 2)*channels, pageCount, fout);
            LOGD("packet_count == %lld pageCount == %d\n", packet_count,pageCount);
        }
        //printf("packet_count == %lld pageCount == %d\n", packet_count,pageCount);

        /*We're done, drain the resampler if we were using it.*/
        //文件的结尾
        if (eos && resampler)
        {
            float *zeros;
            int drain;

            zeros = (float *)calloc(100 * channels, sizeof(float));
            if (!zeros)
            {
                LOGD("Memory allocation failure.\n");
                quit(1);
            }
            drain = speex_resampler_get_input_latency(resampler);
            do {
                opus_int64 outsamp;
                int tmp = drain;
                if (tmp > 100)
                {
                    tmp = 100;
                }
                outsamp = audio_write(zeros, channels, tmp, resampler, NULL, &shapemem, 1, ((page_granule - gran_offset)*decoder_rate / 48000) - link_out, fp,destData+pageCount);
                link_out += outsamp;
                audio_size += (fp ? 4 : 2)*outsamp*channels;

                pageCount += outsamp;
                drain -= tmp;
            } while (drain>0);
            free(zeros);
            speex_resampler_destroy(resampler);
            resampler = NULL;

            if (pageCount > 0)
            {
                //写的是short *,将首地址变成char * ，只是每次写俩个字节，就可以做到写short*
                //fwrite((char *)destData, (fp ? 4 : 2)*channels, pageCount, fout);
                LOGD("packet_count == %lld pageCount == %d\n", packet_count,pageCount);
            }
            LOGD("opusDecoder success \n");
        }
    }
    return pageCount;
}

/*
 * Class:     vide_m4399_com_newopusdemo_OpusDecoder
 * Method:    nativeInitDecoder
 * Signature: ()V
 */
JNIEXPORT jint JNICALL Java_com_example_administrator_opusnativebuild_OpusDecoder_nativeInitDecoder
  (JNIEnv * env, jobject obj)
{
    int ret = 0;
    opus_decoder_resert_variably();
    //对于指针的类型一般赋值为NULL，比较好理解
    output = NULL;
    //0 跟NULL '\0' 都是一样的，都可以赋值
    shapemem.a_buf = NULL;
    shapemem.b_buf = NULL;
    shapemem.mute = 960;
    shapemem.fs = 0;
    /*Output to a file or playback?*/
    //判断是否有输出文件的参数的指定
    wav_format = 1;
    /*If the output is floating point, don't dither.*/
    dither = 1;
    //初始化oy里面的内容，全部变成0
    ogg_sync_init(&oy);
    return ret;
}

/*
 * Class:     vide_m4399_com_newopusdemo_OpusDecoder
 * Method:    nativeDecodeBytes
 * Signature: ([BI[S)I
 */
JNIEXPORT jint JNICALL Java_com_example_administrator_opusnativebuild_OpusDecoder_nativeDecodeBytes
  (JNIEnv * env, jobject obj, jbyteArray decoder_insrc, jint length, jshortArray decoder_out)
{
    int ret = 0;
    //将java中的数组变成c对应的数组
    jshort* pcm_data_decoder = (*env)->GetShortArrayElements(env, decoder_out,0);
    jbyte* opus_data_decoder = (*env)->GetByteArrayElements(env, decoder_insrc,0);

    //解压缩，返回解压缩之后的原始的长度
    //int MyOpusDecoder(char * srcData,int nb_read,short * destData)
    ret = MyOpusDecoder(opus_data_decoder, length,pcm_data_decoder);

    //释放内存
    (*env)->ReleaseShortArrayElements(env, decoder_out, pcm_data_decoder, 0);
    (*env)->ReleaseByteArrayElements(env, decoder_insrc, opus_data_decoder, 0);
    if ((*env)->ExceptionCheck(env))
    {
        return -1;
    }

    return ret;
}

/*
 * Class:     vide_m4399_com_newopusdemo_OpusDecoder
 * Method:    nativeReleaseDecoder
 * Signature: ()V
 */
JNIEXPORT jint JNICALL Java_com_example_administrator_opusnativebuild_OpusDecoder_nativeReleaseDecoder(JNIEnv * env, jobject obj)
{
    int ret = 0;

    LOGD("opusDecoder free start\n");

      if (!total_links)
      {
          LOGD("error This doesn't look like a Opus file\n");
      }

      if (stream_init)
      {
          ogg_stream_clear(&os);
      }

      ogg_sync_clear(&oy);

      if (shapemem.a_buf)
      {
          free(shapemem.a_buf);
      }
      if (shapemem.b_buf)
      {
          free(shapemem.b_buf);
      }

      if (output)
      {
          free(output);
      }

      LOGD("opusDecoder free success\n");
      return ret;
}
</code></pre>
<p>java代码</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpusDecoder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"OpusDecoder"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> frequency <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Capture mono data at 8kHz</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> channelConfiguration <span class="token operator">=</span> AudioFormat<span class="token punctuation">.</span>CHANNEL_CONFIGURATION_MONO<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> audioEncoding <span class="token operator">=</span> AudioFormat<span class="token punctuation">.</span>ENCODING_PCM_16BIT<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// raw encoding</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * opus解码器的初始化,初始话成功返回0
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeInitDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * opus流的解析.返回解压缩之后的大小
     *
     * @param in 要解析的数组
     * @param readSize 读取的大小
     * @param out 解析之后的数组
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeDecodeBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> in<span class="token punctuation">,</span><span class="token keyword">int</span> readSize<span class="token punctuation">,</span><span class="token keyword">short</span><span class="token punctuation">[</span><span class="token punctuation">]</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * opus解码器的释放,释放成功返回0
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">nativeReleaseDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 要decoder的opus文件路径
     */</span>
    <span class="token keyword">private</span> String mSrcDecoderpath<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 具备播放的音频
     */</span>
    <span class="token keyword">private</span> AudioTrack track<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 文件流
     */</span>
    <span class="token keyword">private</span> FileInputStream mFileInputStream<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 每次读取的文件流
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> readBuffer<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 代表了最后一块
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> mIsLastPart<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/***
     * 每次解析返回的大小
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> mDecoderSize<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 已经播放读取的大小
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> mBytesRead<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token function">OpusDecoder</span><span class="token punctuation">(</span>String srcPath<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mSrcDecoderpath <span class="token operator">=</span> srcPath<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">nativeInitDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"opusDecoder initError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">initializeAndroidAudio</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initializeAndroidAudio</span><span class="token punctuation">(</span><span class="token keyword">int</span> sampleRate<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 可以解决部分机型的问题</span>
        <span class="token keyword">int</span> minBufferSize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> AudioTrack<span class="token punctuation">.</span><span class="token function">getMinBufferSize</span><span class="token punctuation">(</span>sampleRate<span class="token punctuation">,</span> channelConfiguration<span class="token punctuation">,</span>
                                                            audioEncoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        track <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioTrack</span><span class="token punctuation">(</span>AudioManager<span class="token punctuation">.</span>STREAM_VOICE_CALL<span class="token punctuation">,</span> frequency<span class="token punctuation">,</span> channelConfiguration<span class="token punctuation">,</span>
                               audioEncoding<span class="token punctuation">,</span> minBufferSize<span class="token punctuation">,</span> AudioTrack<span class="token punctuation">.</span>MODE_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 解析的思路是按照你写进来的方式来进行的，每一个页里面可以包含有多个包，每一个页的数据，都是有包含有一些 特殊的信息的，有文件的检验，oggs
     * 标准的信息等
     *
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception
    <span class="token punctuation">{</span>
        File cacheFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mSrcDecoderpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>cacheFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        readBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>bufferSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">short</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decoded <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">short</span><span class="token punctuation">[</span><span class="token number">65535</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">int</span> read <span class="token operator">=</span> mFileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>readBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">!=</span> bufferSize<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//如果读取到了文件的结尾的化，返回值不是bufferSize大小</span>
            <span class="token punctuation">{</span>
                mIsLastPart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mDecoderSize <span class="token operator">=</span> <span class="token function">nativeDecodeBytes</span><span class="token punctuation">(</span>readBuffer<span class="token punctuation">,</span>read<span class="token punctuation">,</span> decoded<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"nativeDecodeBytes length "</span><span class="token operator">+</span>mDecoderSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

                mBytesRead <span class="token operator">+=</span> track<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>decoded<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mDecoderSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                track<span class="token punctuation">.</span><span class="token function">setStereoVolume</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置当前音量大小</span>
                track<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//读取到了文件的结尾</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>mIsLastPart<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        track<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        track<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 释放这个资源</span>
        <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">nativeReleaseDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"opusDecoder free error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mFileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mFileInputStream <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Recording</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> String TAG <span class="token operator">=</span> <span class="token string">"Recording"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> String audioFolder <span class="token operator">=</span> <span class="token string">"/example"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Folder in which the audio file</span>
    <span class="token comment" spellcheck="true">// is written.</span>
    <span class="token keyword">private</span> String audioFile <span class="token operator">=</span> <span class="token string">"voice.opus"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Name of the audio file.</span>
    <span class="token comment" spellcheck="true">// Status flags</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> isRecording <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> isRecordFinished <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Fields</span>
    <span class="token keyword">public</span> File recordedFile <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 设置音频采样率，44100是目前的标准，但是某些设备仍然支持22050，16000，11025</span>
    <span class="token comment" spellcheck="true">// Audio config</span>
    <span class="token comment" spellcheck="true">// 8kHz,CHANNEL_CONFIGURATION_MONO</span>

    <span class="token comment" spellcheck="true">//设置音频的录制的声道CHANNEL_IN_STEREO为双声道，CHANNEL_CONFIGURATION_MONO为单声道</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> channelConfiguration <span class="token operator">=</span> AudioFormat<span class="token punctuation">.</span>CHANNEL_CONFIGURATION_MONO<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> audioEncoding <span class="token operator">=</span> AudioFormat<span class="token punctuation">.</span>ENCODING_PCM_16BIT<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 音频获取源</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> audioSource <span class="token operator">=</span> MediaRecorder<span class="token punctuation">.</span>AudioSource<span class="token punctuation">.</span>MIC<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> shouldStopRecording <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 缓冲区字节大小</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> bufferSizeInBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> frequency <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Capture mono data at 8kHz</span>

    <span class="token comment" spellcheck="true">/**
     * 每次读取320个字节
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 开始录制声音
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordToFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shouldStopRecording <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isRecording <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获得缓冲区字节大小</span>
        bufferSizeInBytes <span class="token operator">=</span> AudioRecord<span class="token punctuation">.</span><span class="token function">getMinBufferSize</span><span class="token punctuation">(</span>frequency<span class="token punctuation">,</span> channelConfiguration<span class="token punctuation">,</span>
                                                         audioEncoding<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 创建AudioRecord对象</span>
        AudioRecord audioRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioRecord</span><span class="token punctuation">(</span>audioSource<span class="token punctuation">,</span> frequency<span class="token punctuation">,</span> channelConfiguration<span class="token punctuation">,</span>
                                                  audioEncoding<span class="token punctuation">,</span> bufferSizeInBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        audioRecord<span class="token punctuation">.</span><span class="token function">startRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        File file <span class="token operator">=</span> <span class="token function">initFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> OpusEncoder encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpusEncoder</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>bufferSize<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>shouldStopRecording<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">int</span> recordLength <span class="token operator">=</span> audioRecord<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"Recording"</span><span class="token punctuation">,</span> recordLength<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            encoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span>recordLength<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        audioRecord<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        audioRecord<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoder<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isRecording <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isRecordFinished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">/**
     * Creates the output file and folder.
     *
     * @return The output stream for the created file.
     */</span>
    <span class="token keyword">private</span> File <span class="token function">initFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        File sdCard <span class="token operator">=</span> Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        File dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>sdCard<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>audioFolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        File audioFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>audioFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>audioFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            audioFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            audioFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>audioFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>recordedFile <span class="token operator">=</span> audioFile<span class="token punctuation">;</span>
        <span class="token keyword">return</span> recordedFile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 获取录音的文件路径
     * @return
     */</span>
    <span class="token keyword">public</span> String <span class="token function">getRecordFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> recordedFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 停止录音
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shouldStopRecording <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>生成结果<br><img src="/uploads/Opus交叉编译/opusSo生成成功.png" alt="结果显示"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">AheadSnail</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://aheadsnail.github.io/2018/07/06/opus-android-studio-yi-zhi/">https://aheadsnail.github.io/2018/07/06/opus-android-studio-yi-zhi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">AheadSnail</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/AndroidStudio/">
                                    <span class="chip bg-color">AndroidStudio</span>
                                </a>
                            
                                <a href="/tags/NDK/">
                                    <span class="chip bg-color">NDK</span>
                                </a>
                            
                                <a href="/tags/Opus/">
                                    <span class="chip bg-color">Opus</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2018/07/07/soundtouch-visual-studio-huan-jing-da-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="SoundTouch Visual Studio环境搭建">
                        
                        <span class="card-title">SoundTouch Visual Studio环境搭建</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            概述
SoundTouch Visual Studio环境搭建

                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2018-07-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Visual-Studio/">
                        <span class="chip bg-color">Visual Studio</span>
                    </a>
                    
                    <a href="/tags/SoundTouch/">
                        <span class="chip bg-color">SoundTouch</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/07/04/opus-jiao-cha-bian-yi-shi-xian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="Opus 交叉编译实现">
                        
                        <span class="card-title">Opus 交叉编译实现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            概述
Opus Ubuntu实现交叉编译

                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2018-07-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/NDK/">
                        <span class="chip bg-color">NDK</span>
                    </a>
                    
                    <a href="/tags/Opus/">
                        <span class="chip bg-color">Opus</span>
                    </a>
                    
                    <a href="/tags/Ubuntu/">
                        <span class="chip bg-color">Ubuntu</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">AheadSnail</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
