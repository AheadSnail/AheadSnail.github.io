<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android系统启动流程(二),ServiceManager，Zygote启动, AheadSnail&#39;s blog">
    <meta name="description" content>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Android系统启动流程(二),ServiceManager，Zygote启动 | AheadSnail&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="alternate" href="/atom.xml" title="AheadSnail's blog" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">AheadSnail&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/guestbook" class="waves-effect waves-light">
      
      <span>guestbook</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">AheadSnail&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/guestbook" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			guestbook
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Android系统启动流程(二),ServiceManager，Zygote启动</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/ServiceManager/">
                                <span class="chip bg-color">ServiceManager</span>
                            </a>
                        
                            <a href="/tags/Zygote/">
                                <span class="chip bg-color">Zygote</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2018-01-08
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>Android 理解ServiceManager启动,Zygote启动过程<br><a id="more"></a></p>
<h1 id="servicemanager-rc文件的解析"><a href="#servicemanager-rc文件的解析" class="headerlink" title="servicemanager.rc文件的解析"></a><strong>servicemanager.rc文件的解析</strong></h1><pre class=" language-java"><code class="language-java">继上一篇文章介绍 在system<span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token operator">/</span>builtins<span class="token punctuation">.</span>cpp中实现了do_mount_all函数
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_mount_all</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    pid_t pid<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
    <span class="token keyword">int</span> child_ret <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>  
    struct fstab <span class="token operator">*</span>fstab<span class="token punctuation">;</span>  

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fstabfile <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment" spellcheck="true">/* 
     * Call fs_mgr_mount_all() to mount all filesystems.  We fork(2) and 
     * do the call in the child to provide protection to the main init 
     * process if anything goes wrong (crash or memory leak), and wait for 
     * the child to finish in the parent. 
     */</span> 
    pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

     <span class="token comment" spellcheck="true">/* Paths of .rc files are specified at the 2nd argument and beyond */</span> 解析指定路径之下的rc文件
    <span class="token function">import_late</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> FS_MGR_MNTALL_DEV_NEEDS_ENCRYPTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        ActionManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"encrypt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> FS_MGR_MNTALL_DEV_MIGHT_BE_ENCRYPTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.crypto.state"</span><span class="token punctuation">,</span> <span class="token string">"encrypted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.crypto.type"</span><span class="token punctuation">,</span> <span class="token string">"block"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        ActionManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"defaultcrypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> FS_MGR_MNTALL_DEV_NOT_ENCRYPTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.crypto.state"</span><span class="token punctuation">,</span> <span class="token string">"unencrypted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        ActionManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"nonencrypted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//将nonencrypted加入trigger_queue_  </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> FS_MGR_MNTALL_DEV_NOT_ENCRYPTABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.crypto.state"</span><span class="token punctuation">,</span> <span class="token string">"unsupported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        ActionManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"nonencrypted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//将nonencrypted加入trigger_queue_  </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> FS_MGR_MNTALL_DEV_NEEDS_RECOVERY<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token comment" spellcheck="true">/* Setup a wipe via recovery, and reboot into recovery */</span>  
        <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"fs_mgr_mount_all suggested recovery, so wiping data via recovery.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        ret <span class="token operator">=</span> <span class="token function">wipe_data_via_recovery</span><span class="token punctuation">(</span><span class="token string">"wipe_data_via_recovery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment" spellcheck="true">/* If reboot worked, there is no return. */</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> FS_MGR_MNTALL_DEV_FILE_ENCRYPTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">e4crypt_install_keyring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.crypto.state"</span><span class="token punctuation">,</span> <span class="token string">"encrypted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">property_set</span><span class="token punctuation">(</span><span class="token string">"ro.crypto.type"</span><span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token comment" spellcheck="true">// Although encrypted, we have device key, so we do not need to  </span>
        <span class="token comment" spellcheck="true">// do anything different from the nonencrypted case.  </span>
        ActionManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"nonencrypted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"fs_mgr_mount_all returned unexpected error %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment" spellcheck="true">/* else ... &lt; 0: error */</span>  

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

分析这个方法的实现
<span class="token function">import_late</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//大致意思就是说解析指定路径下的rc文件</span>
<span class="token comment" spellcheck="true">/* Imports .rc files from the specified paths. Default ones are applied if none is given.
 *
 * start_index: index of the first path in the args list
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">import_late</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">,</span> size_t start_index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//得到Parser对象</span>
    Parser<span class="token operator">&amp;</span> parser <span class="token operator">=</span> Parser<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> start_index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Use the default set if no path is given</span>
        <span class="token comment" spellcheck="true">//指定要查找的路径</span>
        <span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">></span> init_directories <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"/system/etc/init"</span><span class="token punctuation">,</span>
            <span class="token string">"/vendor/etc/init"</span><span class="token punctuation">,</span>
            <span class="token string">"/odm/etc/init"</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//遍历解析每一个路径之下的文件</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> dir <span class="token operator">:</span> init_directories<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> start_index<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


在Android <span class="token number">7</span>之前的版本中，系统Native服务，不管它们的可执行文件位于系统什么位置都定义在根分区的init<span class="token punctuation">.</span>*<span class="token punctuation">.</span>rc文件中。这造成init＊<span class="token punctuation">.</span>rc文件臃肿庞大，给维护带来了一些不便，
而且其中定义的一些服务的二进制文件根本不存在。但在Android <span class="token number">7.0</span>之后，对该机制做了一些改变 。

单一的init＊<span class="token punctuation">.</span>rc，被拆分，服务根据其二进制文件的位置（／system，／vendor，／odm）定义到对应分区的etc／init目录中，每个服务一个rc文件。与该服务相关的触发器、
操作等也定义在同一rc文件中。 
<span class="token operator">/</span>system<span class="token operator">/</span>etc<span class="token operator">/</span>init，包含系统核心服务的定义，如SurfaceFlinger、MediaServer、Logcatd等。
<span class="token operator">/</span>vendor<span class="token operator">/</span>etc<span class="token operator">/</span>init， SOC厂商针对SOC核心功能定义的一些服务。比如高通、MTK某一款SOC的相关的服务。
<span class="token operator">/</span>odm<span class="token operator">/</span>etc<span class="token operator">/</span>init，OEM<span class="token operator">/</span>ODM厂商如小米、华为、OPP其产品所使用的外设以及差异化功能相关的服务。
</code></pre>
<p>采用的是google自带的7.1的模拟器跟源码是对应上的<br><img src="/uploads/Android启动流程二/ServiceManager文件.png" alt="结果显示"></p>
<pre><code>通过上图可以发现在/system/etc/init 目录下面有一个ServiceManager.rc文件，对应的源码目录为frameworks/native/cmds/servicemanager/service_manager.c
</code></pre><p><img src="/uploads/Android启动流程二/ServiceManager源码路径.png" alt="结果显示"></p>
<p>查看servicemanager.rc文件的内容</p>
<pre><code>service servicemanager /system/bin/servicemanager
    class core       //class 名为core
    user system
    group system readproc
    critical     
    onrestart restart healthd
    onrestart restart zygote
    onrestart restart audioserver
    onrestart restart media
    onrestart restart surfaceflinger
    onrestart restart inputflinger
    onrestart restart drm
    onrestart restart cameraserver
    writepid /dev/cpuset/system-background/tasks

上一篇文章中有介绍到了service的解析过程，这里的class core代表的 core代表服务要启动的class名，就跟class main 一样，main 也为要启动的class名,core服务都是系统最基本的服务，
只要core服务全部启动，手机此时是可以运行的，但是却看不到东西，core服务都是系统最基本的服务，只要core服务全部启动，手机此时是可以运行的，但是却看不到东西，原因是framework没有启动。
当执行到  parser.ParseConfig(dir);的时候，就会解析servicemanager.rc中的service标签，统一的添加进ServiceManager中services_成员变量中,ServiceManager为c++的静态成员类
</code></pre><h1 id="zygote的启动"><a href="#zygote的启动" class="headerlink" title="zygote的启动"></a><strong>zygote的启动</strong></h1><pre class=" language-java"><code class="language-java">在system<span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token operator">/</span>builtins<span class="token punctuation">.</span>cpp中实现了do_mount_all函数
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_mount_all</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> 函数中执行了 <span class="token function">import_late</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>之后，继续往下执行，当执行到
ActionManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"nonencrypted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//将nonencrypted加入trigger_queue_  就会触发下面nonencrypted 的执行，下面为nonencrypted</span>
on nonencrypted    <span class="token comment" spellcheck="true">//触发action   </span>
    # A<span class="token operator">/</span>B update verifier that marks a successful boot<span class="token punctuation">.</span>  
    exec <span class="token operator">-</span> root <span class="token operator">--</span> <span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>update_verifier nonencrypted  
    class_start main         <span class="token comment" spellcheck="true">//调用do_class_start函数将class name为main的services启动起来  </span>
    class_start late_start  

而zygote的rc文件的内容为
service zygote <span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>app_process64 <span class="token operator">-</span>Xzygote <span class="token operator">/</span>system<span class="token operator">/</span>bin <span class="token operator">--</span>zygote <span class="token operator">--</span>start<span class="token operator">-</span>system<span class="token operator">-</span>server
    <span class="token keyword">class</span> <span class="token class-name">main</span>    <span class="token comment" spellcheck="true">//class name为main  </span>
    socket zygote stream <span class="token number">660</span> root system
    onrestart write <span class="token operator">/</span>sys<span class="token operator">/</span>android_power<span class="token operator">/</span>request_state wake
    onrestart write <span class="token operator">/</span>sys<span class="token operator">/</span>power<span class="token operator">/</span>state on
    onrestart restart audioserver
    onrestart restart cameraserver
    onrestart restart media
    onrestart restart netd
    writepid <span class="token operator">/</span>dev<span class="token operator">/</span>cpuset<span class="token operator">/</span>foreground<span class="token operator">/</span>tasks

class_start 对应的函数为
还是在system<span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token operator">/</span>builtins<span class="token punctuation">.</span>cpp中实现了do_class_start函数   <span class="token punctuation">{</span><span class="token string">"class_start"</span><span class="token punctuation">,</span>             <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    do_class_start<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">do_class_start</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token comment" spellcheck="true">/* Starting a class does not start services 
         * which are explicitly disabled.  They must 
         * be started individually. 
         */</span>  
    ServiceManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>  
        <span class="token function">ForEachServiceInClass</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>Service<span class="token operator">*</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span> s<span class="token operator">-</span><span class="token operator">></span><span class="token function">StartIfNotDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  

bool Service<span class="token operator">:</span><span class="token operator">:</span><span class="token function">StartIfNotDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> SVC_DISABLED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">return</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//如果services不是disable,就将start()函数返回  </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
        flags_ <span class="token operator">|=</span> SVC_DISABLED_START<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//否则,标记services为disable  </span>
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  

<span class="token keyword">void</span> ServiceManager<span class="token operator">:</span><span class="token operator">:</span><span class="token function">ForEachServiceInClass</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">:</span><span class="token operator">:</span>string<span class="token operator">&amp;</span> classname<span class="token punctuation">,</span>  
                                           <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>Service<span class="token operator">*</span> svc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> s <span class="token operator">:</span> services_<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//遍历services_寻找所有name为main的servies  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classname <span class="token operator">==</span> s<span class="token operator">-</span><span class="token operator">></span><span class="token function">classname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     
            <span class="token function">func</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//如果找到就调用Start()函数  </span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  

bool Service<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment" spellcheck="true">// Starting a service removes it from the disabled or reset state and  </span>
    <span class="token comment" spellcheck="true">// immediately takes it out of the restarting state if it was in there.  </span>
    flags_ <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token punctuation">(</span>SVC_DISABLED<span class="token operator">|</span>SVC_RESTARTING<span class="token operator">|</span>SVC_RESET<span class="token operator">|</span>SVC_RESTART<span class="token operator">|</span>SVC_DISABLED_START<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    time_started_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  

    <span class="token comment" spellcheck="true">// Running processes require no additional work --- if they're in the  </span>
    <span class="token comment" spellcheck="true">// process of exiting, we've ensured that they will immediately restart  </span>
    <span class="token comment" spellcheck="true">// on exit, unless they are ONESHOT.  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> SVC_RUNNING<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    bool needs_console <span class="token operator">=</span> <span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> SVC_CONSOLE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>needs_console <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>have_console<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"service '%s' requires console\n"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        flags_ <span class="token operator">|=</span> SVC_DISABLED<span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    struct stat sb<span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>args_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sb<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"cannot find '%s' (%s), disabling '%s'\n"</span><span class="token punctuation">,</span>  
              args_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        flags_ <span class="token operator">|=</span> SVC_DISABLED<span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    std<span class="token operator">:</span><span class="token operator">:</span>string bootmode <span class="token operator">=</span> <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"ro.bootmode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"healthd"</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"bootanim"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"zygote"</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"surfaceflinger"</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>bootmode <span class="token operator">==</span> <span class="token string">"charger"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  

         <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"stopping '%s'\n"</span><span class="token punctuation">,</span>name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

        flags_ <span class="token operator">|=</span> SVC_DISABLED<span class="token punctuation">;</span>  

         <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  

     <span class="token punctuation">}</span>  
    std<span class="token operator">:</span><span class="token operator">:</span>string scon<span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>seclabel_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        scon <span class="token operator">=</span> seclabel_<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
        <span class="token keyword">char</span><span class="token operator">*</span> mycon <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>  
        <span class="token keyword">char</span><span class="token operator">*</span> fcon <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>  

        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"computing context for service '%s'\n"</span><span class="token punctuation">,</span> args_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">getcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mycon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"could not get context while starting '%s'\n"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  

        rc <span class="token operator">=</span> <span class="token function">getfilecon</span><span class="token punctuation">(</span>args_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fcon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"could not get context while starting '%s'\n"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token function">free</span><span class="token punctuation">(</span>mycon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  

        <span class="token keyword">char</span><span class="token operator">*</span> ret_scon <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>  
        rc <span class="token operator">=</span> <span class="token function">security_compute_create</span><span class="token punctuation">(</span>mycon<span class="token punctuation">,</span> fcon<span class="token punctuation">,</span> <span class="token function">string_to_security_class</span><span class="token punctuation">(</span><span class="token string">"process"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
                                     <span class="token operator">&amp;</span>ret_scon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            scon <span class="token operator">=</span> ret_scon<span class="token punctuation">;</span>  
            <span class="token function">free</span><span class="token punctuation">(</span>ret_scon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> scon <span class="token operator">==</span> mycon<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"Service %s does not have a SELinux domain defined.\n"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token function">free</span><span class="token punctuation">(</span>mycon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token function">free</span><span class="token punctuation">(</span>fcon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        <span class="token function">free</span><span class="token punctuation">(</span>mycon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">free</span><span class="token punctuation">(</span>fcon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"could not get context while starting '%s'\n"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment" spellcheck="true">//上面都是对services进行判断,设置flags, 下面才是重点  </span>
    <span class="token function">NOTICE</span><span class="token punctuation">(</span><span class="token string">"Starting service '%s'...\n"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//在kernel log中可以看打印信息  </span>

    <span class="token comment" spellcheck="true">//创建一个进程</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//孵化进程  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment" spellcheck="true">//pid 为0 的代表是在子进程里面执行的,也即是下面的代码都是在子进程里面执行的</span>
        <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">077</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> ei <span class="token operator">:</span> envvars_<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">add_environment</span><span class="token punctuation">(</span>ei<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ei<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> si <span class="token operator">:</span> sockets_<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">int</span> socket_type <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"stream"</span> <span class="token operator">?</span> SOCK_STREAM <span class="token operator">:</span>  
                                <span class="token punctuation">(</span>si<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"dgram"</span> <span class="token operator">?</span> SOCK_DGRAM <span class="token operator">:</span>  
                                 SOCK_SEQPACKET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> socketcon <span class="token operator">=</span>  
                <span class="token operator">!</span>si<span class="token punctuation">.</span>socketcon<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> si<span class="token punctuation">.</span>socketcon<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> scon<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

            <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">create_socket</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> socket_type<span class="token punctuation">,</span> si<span class="token punctuation">.</span>perm<span class="token punctuation">,</span>  
                                  si<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> si<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> socketcon<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">PublishSocket</span><span class="token punctuation">(</span>si<span class="token punctuation">.</span>name<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  

        std<span class="token operator">:</span><span class="token operator">:</span>string pid_str <span class="token operator">=</span> <span class="token function">StringPrintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> file <span class="token operator">:</span> writepid_files_<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteStringToFile</span><span class="token punctuation">(</span>pid_str<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"couldn't write %s to %s: %s\n"</span><span class="token punctuation">,</span>  
                      pid_str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ioprio_class_ <span class="token operator">!=</span> IoSchedClass_NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">android_set_ioprio</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ioprio_class_<span class="token punctuation">,</span> ioprio_pri_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"Failed to set pid %d ioprio = %d,%d: %s\n"</span><span class="token punctuation">,</span>  
                      <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ioprio_class_<span class="token punctuation">,</span> ioprio_pri_<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  

        <span class="token keyword">if</span> <span class="token punctuation">(</span>needs_console<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token function">OpenConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
            <span class="token function">ZapStdio</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  

        <span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment" spellcheck="true">// As requested, set our gid, supplemental gids, and uid.  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gid_<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setgid</span><span class="token punctuation">(</span>gid_<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"setgid failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supp_gids_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setgroups</span><span class="token punctuation">(</span>supp_gids_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>supp_gids_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"setgroups failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uid_<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setuid</span><span class="token punctuation">(</span>uid_<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"setuid failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>seclabel_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setexeccon</span><span class="token punctuation">(</span>seclabel_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"cannot setexeccon('%s'): %s\n"</span><span class="token punctuation">,</span>  
                      seclabel_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  

        std<span class="token operator">:</span><span class="token operator">:</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span> strs<span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> auto<span class="token operator">&amp;</span> s <span class="token operator">:</span> args_<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            strs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>const_cast<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        strs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">execve</span><span class="token punctuation">(</span>args_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>strs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> ENV<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//执行system/bin/process程序,进入framework层  </span>
            <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"cannot execve('%s'): %s\n"</span><span class="token punctuation">,</span> args_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  

        <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">ERROR</span><span class="token punctuation">(</span><span class="token string">"failed to start '%s'\n"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        pid_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    time_started_ <span class="token operator">=</span> <span class="token function">gettime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    pid_ <span class="token operator">=</span> pid<span class="token punctuation">;</span>  
    flags_ <span class="token operator">|=</span> SVC_RUNNING<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//将services标记为running  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags_ <span class="token operator">&amp;</span> SVC_EXEC<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">"SVC_EXEC pid %d (uid %d gid %d+%zu context %s) started; waiting...\n"</span><span class="token punctuation">,</span>  
             pid_<span class="token punctuation">,</span> uid_<span class="token punctuation">,</span> gid_<span class="token punctuation">,</span> supp_gids_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
             <span class="token operator">!</span>seclabel_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> seclabel_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token function">NotifyStateChange</span><span class="token punctuation">(</span><span class="token string">"running"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  

调用execve函数用来执行一个可执行的文件，<span class="token function">execve</span><span class="token punctuation">(</span>执行文件<span class="token punctuation">)</span>在父进程中fork一个子进程，在子进程中调用exec函数启动新的程序。exec函数一共有六个，其中execve为内核级系统调用，
其他<span class="token punctuation">(</span>execl，execle，execlp，execv，execvp<span class="token punctuation">)</span>都是调用execve的库函数。调用了execve函数就会执行system<span class="token operator">/</span>bin<span class="token operator">/</span>app_process程序<span class="token punctuation">,</span> 就会进入framework<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>app_process<span class="token operator">/</span>app_main<span class="token punctuation">.</span>cpp的main函数<span class="token punctuation">.</span>
正式进入framework层<span class="token punctuation">.</span> 后文将详细分析
</code></pre>
<p>下面为app_process目录以及生成可执行文件的makefile文件的定义,可以看出生成的目标可执行文件就为app_process,还有区分32位还有64<br><img src="/uploads/Android启动流程二/app_process可执行文件.png" alt="结果显示"></p>
<p>app_process 对应于7.1模拟器上的位置为<br><img src="/uploads/Android启动流程二/app_process可执行文件的路径.png" alt="结果显示"></p>
<h1 id="serviceManager的启动"><a href="#serviceManager的启动" class="headerlink" title="serviceManager的启动"></a><strong>serviceManager的启动</strong></h1><p>ServiceManager简介</p>
<pre><code>ServiceManager是用户空间的一个守护进程，它一直运行在后台。它的职责是管理Binder机制中的各个Server。
当Server启动时，Server会将&quot;Server对象的名字&quot;连同&quot;Server对象的信息&quot;一起注册到ServiceManager中；
而当Client需要获取Server接入点时，则通过&quot;Server的名字&quot;来从ServiceManager中找到对应的Server。
</code></pre><pre class=" language-java"><code class="language-java">在之前的init<span class="token punctuation">.</span>rc文件中
on late<span class="token operator">-</span>init
    trigger early<span class="token operator">-</span>fs
    trigger fs            <span class="token comment" spellcheck="true">//触发</span>
    trigger post<span class="token operator">-</span>fs

    # Load properties from <span class="token operator">/</span>system<span class="token operator">/</span> <span class="token operator">+</span> <span class="token operator">/</span>factory after fs mount<span class="token punctuation">.</span> Place
    # <span class="token keyword">this</span> in another action so that the load will be scheduled after the prior
    # issued fs triggers have completed<span class="token punctuation">.</span>
    trigger load_system_props_action

    # Now we can mount <span class="token operator">/</span>data<span class="token punctuation">.</span> File encryption requires keymaster to decrypt
    # <span class="token operator">/</span>data<span class="token punctuation">,</span> which in turn can only be loaded when system properties are present
    trigger post<span class="token operator">-</span>fs<span class="token operator">-</span>data
    trigger load_persist_props_action

    # Remove a file to wake up anything waiting <span class="token keyword">for</span> firmware<span class="token punctuation">.</span>
    trigger firmware_mounts_complete

    trigger early<span class="token operator">-</span>boot
    trigger boot       <span class="token comment" spellcheck="true">//触发</span>

可以发现是先触发了trigger fs 完成了serviceManger<span class="token punctuation">.</span>rc文件的解析，启动了zygote之后，触发 trigger boot
on boot
    # basic network init
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    class_start core      <span class="token comment" spellcheck="true">//调用do_class_start函数将class name为core的services启动起来  </span>

service_manager<span class="token punctuation">.</span>rc文件中    
service servicemanager <span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>servicemanager
    <span class="token keyword">class</span> <span class="token class-name">core</span>        <span class="token comment" spellcheck="true">//class 名为core</span>
    user system
    group system readproc
    critical     
    onrestart restart healthd
    onrestart restart zygote
    onrestart restart audioserver
    onrestart restart media
    onrestart restart surfaceflinger
    onrestart restart inputflinger
    onrestart restart drm
    onrestart restart cameraserver
    writepid <span class="token operator">/</span>dev<span class="token operator">/</span>cpuset<span class="token operator">/</span>system<span class="token operator">-</span>background<span class="token operator">/</span>tasks    

所以就会启动以core为函数名的service，其中就包括了servicemanager
class_start 对应的函数还是在system<span class="token operator">/</span>core<span class="token operator">/</span>init<span class="token operator">/</span>builtins<span class="token punctuation">.</span>cpp中实现了do_class_start函数   <span class="token punctuation">{</span><span class="token string">"class_start"</span><span class="token punctuation">,</span>             <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span>     <span class="token number">1</span><span class="token punctuation">,</span>    do_class_start<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
这里的启动服务的过程跟上面启动main为函数名的service是一样的，这里就不在重复了，只是调用execv函数执行的可执行的文件为servicemanager
调用execve执行system<span class="token operator">/</span>bin<span class="token operator">/</span>servicemanager程序<span class="token punctuation">,</span> 就会进入framework<span class="token operator">/</span><span class="token keyword">native</span><span class="token operator">/</span>cmds<span class="token operator">/</span>servicemanager<span class="token operator">/</span>servicemanager<span class="token punctuation">.</span>cpp的main函数<span class="token punctuation">.</span>
</code></pre>
<p>下面为service_manager目录以及生成可执行文件的makefile文件的定义,可以看出生成的目标可执行文件就为servicemanager<br><img src="/uploads/Android启动流程二/servicemanager源码的路径.png" alt="结果显示"></p>
<p>app_process 对应于7.1模拟器上的位置为<br><img src="/uploads/Android启动流程二/serviceManager可执行文件的路径.png" alt="结果显示"></p>
<p>下面进入servicemanager.cpp中的main函数的入口</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct binder_state <span class="token operator">*</span>bs<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//打开/dev/binder 启动，隐射内存空间</span>
    bs <span class="token operator">=</span> <span class="token function">binder_open</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"failed to open binder driver\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_become_context_manager</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"cannot become context manager (%s)\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    selinux_enabled <span class="token operator">=</span> <span class="token function">is_selinux_enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sehandle <span class="token operator">=</span> <span class="token function">selinux_android_service_context_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">selinux_status_open</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>selinux_enabled <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sehandle <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"SELinux: Failed to acquire sehandle. Aborting.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>service_manager_context<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"SELinux: Failed to acquire service_manager context. Aborting.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    union selinux_callback cb<span class="token punctuation">;</span>
    cb<span class="token punctuation">.</span>func_audit <span class="token operator">=</span> audit_callback<span class="token punctuation">;</span>
    <span class="token function">selinux_set_callback</span><span class="token punctuation">(</span>SELINUX_CB_AUDIT<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cb<span class="token punctuation">.</span>func_log <span class="token operator">=</span> selinux_log_callback<span class="token punctuation">;</span>
    <span class="token function">selinux_set_callback</span><span class="token punctuation">(</span>SELINUX_CB_LOG<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">binder_loop</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> svcmgr_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

struct binder_state <span class="token operator">*</span><span class="token function">binder_open</span><span class="token punctuation">(</span>size_t mapsize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct binder_state <span class="token operator">*</span>bs<span class="token punctuation">;</span>
    struct binder_version vers<span class="token punctuation">;</span>

    bs <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errno <span class="token operator">=</span> ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//以只读的方式打开/dev/binder </span>
    bs<span class="token operator">-</span><span class="token operator">></span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/binder"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bs<span class="token operator">-</span><span class="token operator">></span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span><span class="token string">"binder: cannot open device (%s)\n"</span><span class="token punctuation">,</span>
                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_open<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-</span><span class="token operator">></span>fd<span class="token punctuation">,</span> BINDER_VERSION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>vers<span class="token punctuation">.</span>protocol_version <span class="token operator">!=</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span>
                <span class="token string">"binder: kernel driver version (%d) differs from user space version (%d)\n"</span><span class="token punctuation">,</span>
                vers<span class="token punctuation">.</span>protocol_version<span class="token punctuation">,</span> BINDER_CURRENT_PROTOCOL_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_open<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    bs<span class="token operator">-</span><span class="token operator">></span>mapsize <span class="token operator">=</span> mapsize<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//mmap(NULL, mapsize, PROT_READ, MAP_PRIVATE, bs->fd, 0)对应会调用驱动的mmap函数。第一个参数是映射内存的起始地址，NULL代表让系统自动选定地址,</span>
    <span class="token comment" spellcheck="true">//mapsize大小是128*1024B，即128K；PROT_READ表示映射区域是可读的；MAP_PRIVATE表示建立一个写入时拷贝的私有映射，即，当进程中对该内存区域进行写入时，</span>
    <span class="token comment" spellcheck="true">//是写入到映射的拷贝中；bs->fd是"/dev/binder"句柄；而0表示偏移。</span>
    bs<span class="token operator">-</span><span class="token operator">></span>mapped <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span>NULL<span class="token punctuation">,</span> mapsize<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> bs<span class="token operator">-</span><span class="token operator">></span>fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bs<span class="token operator">-</span><span class="token operator">></span>mapped <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span><span class="token string">"binder: cannot map device (%s)\n"</span><span class="token punctuation">,</span>
                <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> fail_map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> bs<span class="token punctuation">;</span>

fail_map<span class="token operator">:</span>
    <span class="token function">close</span><span class="token punctuation">(</span>bs<span class="token operator">-</span><span class="token operator">></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
fail_open<span class="token operator">:</span>
    <span class="token function">free</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>/dev/binder在系统中的位置为<br><img src="/uploads/Android启动流程二/dev-binder所在的位置.png" alt="结果显示"></p>
<pre class=" language-java"><code class="language-java">main函数中binder_loop的函数实现为，第二个参数为函数指针<span class="token punctuation">,</span>函数的原型为
<span class="token keyword">int</span> <span class="token function">svcmgr_handler</span><span class="token punctuation">(</span>struct binder_state <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   struct binder_transaction_data <span class="token operator">*</span>txn<span class="token punctuation">,</span>
                   struct binder_io <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                   struct binder_io <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    struct svcinfo <span class="token operator">*</span>si<span class="token punctuation">;</span>
    uint16_t <span class="token operator">*</span>s<span class="token punctuation">;</span>
    size_t len<span class="token punctuation">;</span>
    uint32_t handle<span class="token punctuation">;</span>
    uint32_t strict_policy<span class="token punctuation">;</span>
    <span class="token keyword">int</span> allow_isolated<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//ALOGI("target=%p code=%d pid=%d uid=%d\n",</span>
    <span class="token comment" spellcheck="true">//      (void*) txn->target.ptr, txn->code, txn->sender_pid, txn->sender_euid);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>target<span class="token punctuation">.</span>ptr <span class="token operator">!=</span> BINDER_SERVICE_MANAGER<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>code <span class="token operator">==</span> PING_TRANSACTION<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Equivalent to Parcel::enforceInterface(), reading the RPC</span>
    <span class="token comment" spellcheck="true">// header with the strict mode policy mask and the interface name.</span>
    <span class="token comment" spellcheck="true">// Note that we ignore the strict_policy and don't propagate it</span>
    <span class="token comment" spellcheck="true">// further (since we do no outbound RPCs anyway).</span>
    strict_policy <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token function">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">memcmp</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span><span class="token string">"invalid id %s\n"</span><span class="token punctuation">,</span> <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sehandle <span class="token operator">&amp;&amp;</span> <span class="token function">selinux_status_updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        struct selabel_handle <span class="token operator">*</span>tmp_sehandle <span class="token operator">=</span> <span class="token function">selinux_android_service_context_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp_sehandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">selabel_close</span><span class="token punctuation">(</span>sehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sehandle <span class="token operator">=</span> tmp_sehandle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> SVC_MGR_GET_SERVICE<span class="token operator">:</span>
    <span class="token keyword">case</span> SVC_MGR_CHECK_SERVICE<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>用来响应当ServiceManager 得到对应的service
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        handle <span class="token operator">=</span> <span class="token function">do_find_service</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>sender_euid<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>sender_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token function">bio_put_ref</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> SVC_MGR_ADD_SERVICE<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>用来响应当ServiceManager add对应的service
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        handle <span class="token operator">=</span> <span class="token function">bio_get_ref</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        allow_isolated <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">do_add_service</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>sender_euid<span class="token punctuation">,</span>
            allow_isolated<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>sender_pid<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> SVC_MGR_LIST_SERVICES<span class="token operator">:</span> <span class="token punctuation">{</span>
        uint32_t n <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">svc_can_list</span><span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>sender_pid<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"list_service() uid=%d - PERMISSION DENIED\n"</span><span class="token punctuation">,</span>
                    txn<span class="token operator">-</span><span class="token operator">></span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        si <span class="token operator">=</span> svclist<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> si<span class="token punctuation">)</span>
            si <span class="token operator">=</span> si<span class="token operator">-</span><span class="token operator">></span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">bio_put_string16</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> si<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"unknown code %d\n"</span><span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">binder_loop</span><span class="token punctuation">(</span>struct binder_state <span class="token operator">*</span>bs<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    struct binder_write_read bwr<span class="token punctuation">;</span>
    uint32_t readbuf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> BC_ENTER_LOOPER<span class="token punctuation">;</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> readbuf<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> readbuf<span class="token punctuation">;</span>

        res <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>bs<span class="token operator">-</span><span class="token operator">></span>fd<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"binder_loop: ioctl failed (%s)\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        res <span class="token operator">=</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span> readbuf<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"binder_loop: unexpected reply?!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"binder_loop: io error %d %s\n"</span><span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">binder_parse</span><span class="token punctuation">(</span>struct binder_state <span class="token operator">*</span>bs<span class="token punctuation">,</span> struct binder_io <span class="token operator">*</span>bio<span class="token punctuation">,</span>
                 uintptr_t ptr<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> binder_handler func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_TRANSACTION<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//函数指针</span>
            struct binder_transaction_data <span class="token operator">*</span>txn <span class="token operator">=</span> <span class="token punctuation">(</span>struct binder_transaction_data <span class="token operator">*</span><span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> ptr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>txn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"parse: txn too small!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">binder_dump_txn</span><span class="token punctuation">(</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                unsigned rdata<span class="token punctuation">[</span><span class="token number">256</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                struct binder_io msg<span class="token punctuation">;</span>
                struct binder_io reply<span class="token punctuation">;</span>
                <span class="token keyword">int</span> res<span class="token punctuation">;</span>

                <span class="token function">bio_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> rdata<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>rdata<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">bio_init_from_txn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//也即是onTransate函数</span>
                res <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> txn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">binder_free_buffer</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">binder_send_reply</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">,</span> txn<span class="token operator">-</span><span class="token operator">></span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            ptr <span class="token operator">+=</span> <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>txn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ServiceManager启动流程图<br><img src="/uploads/Android启动流程二/ServiceManager启动流程图.jpg" alt="结果显示"></p>
<pre><code>上面是ServiceManager的时序图。它启动之后，会先打开&quot;/dev/binder&quot;文件(&quot;/dev/binder&quot;是Binder驱动注册的设备节点)。打开文件之后，再告诉Binder驱动，它是Binder的上下文管理者。
之后，就进入到了消息循环中。进入消息循环之后，会不断的从Binder的待处理事务队列中读取事务(Binder请求或反馈)，读出事务之后就进行解析，然后交给相应的进程进行处理。
若没有事务，则进入等待状态，等待被唤醒。
</code></pre><p>如果想要了解Kernel是怎么样处理IBinder的可以查看<a href="http://wangkuiwu.github.io/2014/09/01/Binder-Introduce/" target="_blank" rel="noopener">IBinder详解</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">AheadSnail</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://aheadsnail.github.io/2018/01/08/android-xi-tong-qi-dong-liu-cheng-er-servicemanager-zygote-qi-dong/">https://aheadsnail.github.io/2018/01/08/android-xi-tong-qi-dong-liu-cheng-er-servicemanager-zygote-qi-dong/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">AheadSnail</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Android/">
                                    <span class="chip bg-color">Android</span>
                                </a>
                            
                                <a href="/tags/ServiceManager/">
                                    <span class="chip bg-color">ServiceManager</span>
                                </a>
                            
                                <a href="/tags/Zygote/">
                                    <span class="chip bg-color">Zygote</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'IHAROYQfeblNBhewb7XcnPvS-gzGzoHsz',
        appKey: 'W2Wktehj1wV33eFF0A6B6elX',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2018/01/08/android-xi-tong-qi-dong-liu-cheng-san-jin-ru-zygote-jin-cheng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Android系统启动流程(三),进入Zygote进程">
                        
                        <span class="card-title">Android系统启动流程(三),进入Zygote进程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Android 进入Zygote过程
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2018-01-08
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Zygote/">
                        <span class="chip bg-color">Zygote</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/01/07/2017-nian-zhong-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="2017年终总结">
                        
                        <span class="card-title">2017年终总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            我的2017年终总结
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2018-01-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            AheadSnail
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/2017年终总结/">
                        <span class="chip bg-color">2017年终总结</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">AheadSnail</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
